<!DOCTYPE html>
<html  lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1"><meta name="viewport" content="width=device-width, initial-scale=1" />

      <title>Fritz User Guide</title>
    
          <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
          <link rel="stylesheet" href="_static/theme.css " type="text/css" />
          <link rel="stylesheet" href="_static/custom.css" type="text/css" />
      
      <!-- sphinx script_files -->
        <script src="_static/documentation_options.js?v=5929fcd5"></script>
        <script src="_static/doctools.js?v=9a2dae69"></script>
        <script src="_static/sphinx_highlight.js?v=dc90522c"></script>

      
      <!-- bundled in js (rollup iife) -->
      <!-- <script src="_static/theme-vendors.js"></script> -->
      <script src="_static/theme.js" defer></script>
    
  <link rel="index" title="Index" href="genindex.html" />
  <link rel="search" title="Search" href="search.html" />
  <link rel="next" title="Run your own Fritz" href="run_your_own.html" />
  <link rel="prev" title="Fritz marshal manual" href="index.html" /> 
  </head>

  <body>
    <div id="app">
    <div class="theme-container" :class="pageClasses"><navbar @toggle-sidebar="toggleSidebar">
  <router-link to="index.html" class="home-link">
    
      <span class="site-name">Fritz Marshal</span>
    
  </router-link>

  <div class="links">
    <navlinks class="can-hide">



    </navlinks>
  </div>
</navbar>

      
      <div class="sidebar-mask" @click="toggleSidebar(false)">
      </div>
        <sidebar @toggle-sidebar="toggleSidebar">
          
          <navlinks>
            



            
          </navlinks><div id="searchbox" class="searchbox" role="search">
  <div class="caption"><span class="caption-text">Quick search</span>
    <div class="searchformwrapper">
      <form class="search" action="search.html" method="get">
        <input type="text" name="q" />
        <input type="submit" value="Search" />
        <input type="hidden" name="check_keywords" value="yes" />
        <input type="hidden" name="area" value="default" />
      </form>
    </div>
  </div>
</div><div class="sidebar-links" role="navigation" aria-label="main navigation">
  
    <div class="sidebar-group">
      <p class="caption">
        <span class="caption-text"><a href="index.html#fritz-marshal-manual">fritz marshal manual</a></span>
      </p>
      <ul class="current">
        
          <li class="toctree-l1 current">
            
              <a href="#" class="reference internal current">Fritz User Guide</a>
            

            
              <ul>
                
                  <li class="toctree-l2"><a href="#quick-start" class="reference internal">Quick start</a></li>
                
                  <li class="toctree-l2"><a href="#alert-filters-in-fritz" class="reference internal">Alert filters in Fritz</a></li>
                
                  <li class="toctree-l2"><a href="#feedback" class="reference internal">Feedback</a></li>
                
              </ul>
            
          </li>

        
          <li class="toctree-l1 ">
            
              <a href="run_your_own.html" class="reference internal ">Run your own Fritz</a>
            

            
          </li>

        
          <li class="toctree-l1 ">
            
              <a href="api.html" class="reference internal ">API</a>
            

            
          </li>

        
          <li class="toctree-l1 ">
            
              <a href="catalogs.html" class="reference internal ">Kowalski collection schemas</a>
            

            
          </li>

        
          <li class="toctree-l1 ">
            
              <a href="technical_implementation.html" class="reference internal ">Technical implementation</a>
            

            
          </li>

        
          <li class="toctree-l1 ">
            
              <a href="developer.html" class="reference internal ">Developer Guidelines</a>
            

            
          </li>

        
          <li class="toctree-l1 ">
            
              <a href="license.html" class="reference internal ">License</a>
            

            
          </li>

        
      </ul>
    </div>
  
</div>
        </sidebar>

      <page>
          <div class="body-header" role="navigation" aria-label="navigation">
  
  <ul class="breadcrumbs">
    <li><a href="index.html">Docs</a> &raquo;</li>
    
    <li>Fritz User Guide</li>
  </ul>
  

  <ul class="page-nav">
  <li class="prev">
    <a href="index.html"
       title="previous chapter">← Fritz marshal manual</a>
  </li>
  <li class="next">
    <a href="run_your_own.html"
       title="next chapter">Run your own Fritz →</a>
  </li>
</ul>
  
</div>
<hr>
          <div class="content" role="main" v-pre>
            
  <section id="fritz-user-guide">
<h1>Fritz User Guide<a class="headerlink" href="#fritz-user-guide" title="Link to this heading">¶</a></h1>
<p><a class="reference external" href="https://github.com/fritz-marshal/fritz">Fritz</a> is the science data platform for the
<a class="reference external" href="https://ztf.caltech.edu">Zwicky Transient Facility (ZTF)</a> Phase II.</p>
<p>It implements an end-to-end, scalable, API-first system for Time-domain Astronomy, featuring</p>
<ul class="simple">
<li><p>A multi-survey data archive and alert broker</p></li>
<li><p>An interactive collaborative marshal for the transient, variable, and Solar system science cases</p></li>
<li><p>A workhorse for machine learning applications and active learning</p></li>
<li><p>Follow-up observation management with robotic and classical facilities</p></li>
<li><p>Fine-grained access control</p></li>
</ul>
<p>The key characteristics of Fritz are efficiency, scalability, portability, and extensibility.
Fritz employs a modular architecture and
integrates and extends two major components: <a class="reference external" href="https://github.com/dmitryduev/kowalski">Kowalski</a>
acts as the alert processor and data archive, and <a class="reference external" href="https://github.com/skyportal/skyportal">SkyPortal</a>,
which handles the rest of the stack.
The schematic overview of our system is shown below:</p>
<p><img alt="img/fritz.png" src="_images/fritz.jpg" /></p>
<section id="quick-start">
<h2>Quick start<a class="headerlink" href="#quick-start" title="Link to this heading">¶</a></h2>
<section id="a-quick-tour-of-fritz-from-the-user-perspective">
<h3>A quick tour of Fritz from the user perspective<a class="headerlink" href="#a-quick-tour-of-fritz-from-the-user-perspective" title="Link to this heading">¶</a></h3>
<section id="user-profile">
<h4>User profile<a class="headerlink" href="#user-profile" title="Link to this heading">¶</a></h4>
<p>Newly invited <code class="docutils literal notranslate"><span class="pre">Fritz</span></code> users are first taken to the Profile page.
Here, you can update your user info, preferences, and manage tokens to
<a class="reference external" href="https://docs.fritz.science/api.html">interact with <code class="docutils literal notranslate"><span class="pre">Fritz</span></code> programmatically</a>.
If you have a <a class="reference external" href="https://en.gravatar.com/">gravatar</a> associated with your email address,
it will be used as your avatar throughout the portal.</p>
<p><img alt="lsst-ws-profile" src="https://user-images.githubusercontent.com/7557205/113780243-cb733600-96e3-11eb-8f9d-3ed5734da11b.gif" /></p>
<p>System administrators can invite new users to <code class="docutils literal notranslate"><span class="pre">Fritz</span></code> and manage their roles/ACLs as well as group membership and
alert stream access.</p>
<p>We use OAuth for user authentication.</p>
</section>
<section id="dashboard">
<h4>Dashboard<a class="headerlink" href="#dashboard" title="Link to this heading">¶</a></h4>
<p>On the Dashboard, the landing page, the user can see a collection of configurable widgets displaying the
information on the most popular and latest saved sources, the newsfeed, conditions at telescopes and so on.</p>
<p><img alt="lsst-ws-dashboard" src="https://user-images.githubusercontent.com/7557205/113781577-c0b9a080-96e5-11eb-8f08-5dd59c00cf01.gif" /></p>
</section>
<section id="groups-and-filters">
<h4>Groups and filters<a class="headerlink" href="#groups-and-filters" title="Link to this heading">¶</a></h4>
<p>New <code class="docutils literal notranslate"><span class="pre">Fritz</span></code> users are added to one or more groups.
Users can also create groups themselves and request admission to groups they are not a member of.
<img alt="lsst-ws-group-admission" src="https://user-images.githubusercontent.com/7557205/113792878-d20da780-96fb-11eb-8e5d-359bd0e34807.gif" /></p>
<p>You can find and manage the list of group members, the sources saved to
the group, and the group’s <a class="reference external" href="https://docs.fritz.science/user_guide.html#alert-filters-in-fritz">alert filters</a>
(defined on one of the alert streams that the group has access to)
on the Group page. Group admins can create new filters (and modify existing ones).
System administrators can grant alert stream access to the groups.</p>
<p><code class="docutils literal notranslate"><span class="pre">Fritz</span></code> provides rich alert stream filtering capabilities through its Kowalski backend,
which consumes the ZTF Kafka alert stream, persisting the alerts to a database,
and supplementing them with additional data such as the Galactic coordinates,
external catalog cross-matches, machine learning scores etc.</p>
<p>Alert filters are implemented as <a class="reference external" href="https://docs.mongodb.com/manual/core/aggregation-pipeline/">aggregation pipelines</a>
and are executed on the enhanced packets containing, in particular, the full photometry history.
For a detailed discussion of this, refer to
the <a class="reference external" href="https://docs.fritz.science/user_guide.html#alert-filters-in-fritz">alert filters</a> section of the docs.</p>
<p>Fritz performs automated checks of the filter definition such that no code audit is necessary. Valid changes are propagated
and applied almost immediately. Users can enable/disable filters, inspect filter version history, opt in for
automatically saving passing objects to the filter’s group and updating annotations each time an object passes the filter.</p>
<p><img alt="lsst-ws-group-filter" src="https://user-images.githubusercontent.com/7557205/113790766-fe72f500-96f6-11eb-9c9a-7a7fc1ce8278.gif" /></p>
<p>Filters can range from very simple that rely on, for example,
<a class="reference external" href="https://docs.fritz.science/user_guide.html#acai-hosted-filter">mostly ML scores</a>,
or implement <a class="reference external" href="https://docs.fritz.science/user_guide.html#bts-rcf-program-full-filter">very complicated logic/computations</a>.
<a class="reference external" href="https://docs.fritz.science/user_guide.html#watch-lists">Watch lists</a> can also be implemented as simple Fritz filters.</p>
<p>Finally, we provide public alert databases for filter design and debugging.</p>
</section>
<section id="candidates-and-sources">
<h4>Candidates and Sources<a class="headerlink" href="#candidates-and-sources" title="Link to this heading">¶</a></h4>
<p>Alerts passing a filter are posted to Fritz’s SkyPortal backend as Candidates
and appear on the Scanning page (for the corresponding filter groups).</p>
<p>Candidates do not have to originate from <code class="docutils literal notranslate"><span class="pre">Kowalski</span></code> and could be posted (manually) via the API.</p>
<p>On the Candidates page, the users can filter, scan and inspect the objects that have passed filters of their groups
and save them to one or more groups. Candidates that are not saved to any group within 7 days are removed from <code class="docutils literal notranslate"><span class="pre">Fritz</span></code>.
Saved Candidates become Sources that are persisted indefinitely.</p>
<p><img alt="lsst-ws-candidates2" src="https://user-images.githubusercontent.com/7557205/113795061-d8525280-9700-11eb-9ab0-69c599554ca5.gif" /></p>
<p>Candidates/Sources can be supplemented with (structured) annotations, which is particularly useful for scanning:
<img alt="lsst-ws-candidates3" src="https://user-images.githubusercontent.com/7557205/113927408-4ac73f00-97a2-11eb-9a30-e2fc3c3c5e66.gif" /></p>
<p>The Source page aggregates all kinds of information related to an object:
<img alt="lsst-ws-source-overview" src="https://user-images.githubusercontent.com/7557205/113828809-a7424400-9739-11eb-86b6-5eb525d32c82.gif" /></p>
<p>In particular, users can generate finder charts and star lists for the source, check its observability,
add and inspect redshift data:
<img alt="lsst-ws-source-1" src="https://user-images.githubusercontent.com/7557205/113828984-d658b580-9739-11eb-9272-d6e15928f894.gif" /></p>
<p>Annotations provide a way to store structured data related to the source,
while comments can be used to enter text/data in free-form. Sources can be classified according to a taxonomy
(which users can post themselves provided they have the necessary ACL).
Interactive offset plot displays positional information.</p>
<p>Users can send notifications about the source to the group members, provided they opted in for receiving such.</p>
<p><img alt="lsst-ws-source-2" src="https://user-images.githubusercontent.com/7557205/113928363-89a9c480-97a3-11eb-86d0-713b7c3ceee9.gif" /></p>
<p>For sources <a class="reference external" href="https://skyportal.io/docs/advanced_usage.html?highlight=gaia">annotated with Gaia color information</a>, an
HR diagram is rendered.
<img alt="lsst-ws-source-hr" src="https://user-images.githubusercontent.com/7557205/113984246-bab7e280-97ff-11eb-9c64-472af5864d64.gif" /></p>
<p>Users can interactively inspect (optionally binned) photometry data in both magnitude and flux spaces.
Tools for data import, export, and granular access management are available.
<img alt="lsst-ws-source-3" src="https://user-images.githubusercontent.com/7557205/113929129-882ccc00-97a4-11eb-86fb-e40fd7bb34ea.gif" /></p>
<p>The photometry plot for sources annotated with period data additionally displays phase-folded light curves:
<img alt="lsst-ws-source-phase-fold" src="https://user-images.githubusercontent.com/7557205/113984100-922fe880-97ff-11eb-92e3-47a78aab0595.gif" /></p>
<p>Tooling for extensive in-browser periodogram analysis for variable sources is also available:
<img alt="lsst-ws-source-periodogram-analysis" src="https://user-images.githubusercontent.com/7557205/113931157-00948c80-97a7-11eb-9125-1f7f9887718e.gif" /></p>
<p>Users can inspect, analyze, and manage (including export/import) spectroscopy data.</p>
<p>We provide interfaces to work with both robotic and classical follow-up facilities, including
a framework for dealing with allocations.
In particular, we feature automated integration with the <a class="reference external" href="https://sites.astro.caltech.edu/sedm/">SEDM</a>.</p>
<p><img alt="lsst-ws-source-spectroscopy-follow-up" src="https://user-images.githubusercontent.com/7557205/113935794-ced1f480-97ab-11eb-8c48-ea60fb3aee03.gif" /></p>
<p>Sources can be added to (“classical”) observing runs:
<img alt="lsst-ws-source-observing-run" src="https://user-images.githubusercontent.com/7557205/113935874-ea3cff80-97ab-11eb-8705-7858febbe6d1.gif" /></p>
<p>Sources can be added to favorites:
<img alt="lsst-ws-fav" src="https://user-images.githubusercontent.com/7557205/113828656-824dd100-9739-11eb-8291-2c7b779889a3.gif" /></p>
<p>Users can query the objects that exist in Fritz’s SkyPortal on the Sources page:
<img alt="lsst-ws-sources" src="https://user-images.githubusercontent.com/7557205/113937545-2bceaa00-97ae-11eb-9e66-1fe19aa79a62.gif" /></p>
<p>Only the objects that have been posted to <code class="docutils literal notranslate"><span class="pre">Fritz</span></code>’s <code class="docutils literal notranslate"><span class="pre">SkyPortal</span></code> backend are saved in its database.
However, <code class="docutils literal notranslate"><span class="pre">Fritz</span></code>’s users can access the entire archive of ZTF alerts (~390M as of June 2021) via the Alerts page:</p>
<p><img alt="alerts-20210601" src="https://user-images.githubusercontent.com/7557205/120433501-287c1880-c330-11eb-907f-9c5327b9e0aa.gif" /></p>
<p><code class="docutils literal notranslate"><span class="pre">Fritz</span></code>’s users also have access to the entire archive of photometric light curves of ZTF sources
(~4B as of June 2021) via the Archive page:</p>
<p><img alt="archive-20210601" src="https://user-images.githubusercontent.com/7557205/120433545-36319e00-c330-11eb-9399-e68146a05d8b.gif" /></p>
</section>
<section id="mobile-experience">
<h4>Mobile experience<a class="headerlink" href="#mobile-experience" title="Link to this heading">¶</a></h4>
<p>Fritz’s interfaces are mobile-friendly, so the app will work as expected on your phone or tablet:</p>
<table>
<tr>
<td><img alt="phone" src="https://user-images.githubusercontent.com/7557205/114100592-5f2a3b00-9879-11eb-9dbc-9a4cdc46df77.gif" /></td>
<td><img alt="tablet" src="https://user-images.githubusercontent.com/7557205/114100803-b29c8900-9879-11eb-98c2-98ee91fd0e5e.gif" /></td>
</tr>
</table>
</section>
</section>
<section id="using-the-api">
<h3>Using the API<a class="headerlink" href="#using-the-api" title="Link to this heading">¶</a></h3>
<p>An API enables access to most of the underlying functionality of Fritz/SkyPortal/Kowalski.
The workflows described above are all enabled by specific API calls.
The complete OpenAPI specification is available at <a class="reference external" href="https://docs.fritz.science/api.html">https://docs.fritz.science/api.html</a>.</p>
<p>To use the API, you will need a token that can be generated on the Profile page. Once you have that, you can
access Fritz programmatically as follows.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">requests</span>
<span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">Mapping</span><span class="p">,</span> <span class="n">Optional</span>
<span class="kn">import</span> <span class="nn">urllib.parse</span>

<span class="n">token</span> <span class="o">=</span> <span class="s1">&#39;ea70a5f0-b321-43c6-96a1-b2de225e0339&#39;</span>

<span class="k">def</span> <span class="nf">api</span><span class="p">(</span>
    <span class="n">method</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">endpoint</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">data</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Mapping</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">base_url</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;https://fritz.science&quot;</span><span class="p">,</span>
<span class="p">):</span>
    <span class="n">headers</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;Authorization&quot;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;token </span><span class="si">{</span><span class="n">token</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">}</span>
    <span class="n">response</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">request</span><span class="p">(</span>
      <span class="n">method</span><span class="o">.</span><span class="n">upper</span><span class="p">(),</span>
      <span class="n">urllib</span><span class="o">.</span><span class="n">parse</span><span class="o">.</span><span class="n">urljoin</span><span class="p">(</span><span class="n">base_url</span><span class="p">,</span> <span class="n">endpoint</span><span class="p">),</span>
      <span class="n">json</span><span class="o">=</span><span class="n">data</span><span class="p">,</span>
      <span class="n">headers</span><span class="o">=</span><span class="n">headers</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="k">return</span> <span class="n">response</span>
</pre></div>
</div>
<p>For example, here is how to
<a class="reference external" href="https://docs.fritz.science/api.html#tag/sources/paths/~1api~1sources~1obj_id~1annotations/get">retrieve object’s annotations</a>:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">object_id</span> <span class="o">=</span> <span class="s2">&quot;ZTF21aatjavc&quot;</span>

<span class="n">response</span> <span class="o">=</span> <span class="n">api</span><span class="p">(</span><span class="s2">&quot;get&quot;</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;api/sources/</span><span class="si">{</span><span class="n">object_id</span><span class="si">}</span><span class="s2">/annotations&quot;</span><span class="p">)</span>
<span class="n">data</span> <span class="o">=</span> <span class="n">response</span><span class="o">.</span><span class="n">json</span><span class="p">()</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;data&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
</pre></div>
</div>
<p>Which would yield something similar to:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="p">[{</span>
    <span class="s2">&quot;author_id&quot;</span><span class="p">:</span> <span class="mi">3</span><span class="p">,</span>
    <span class="s2">&quot;created_at&quot;</span><span class="p">:</span> <span class="s2">&quot;2021-04-08T06:17:56.980090&quot;</span><span class="p">,</span>
    <span class="s2">&quot;data&quot;</span><span class="p">:</span> <span class="p">{</span>
        <span class="s2">&quot;acai_b&quot;</span><span class="p">:</span> <span class="mf">0.00011</span><span class="p">,</span>
        <span class="s2">&quot;acai_h&quot;</span><span class="p">:</span> <span class="mf">0.98887</span><span class="p">,</span>
        <span class="s2">&quot;acai_n&quot;</span><span class="p">:</span> <span class="mf">0.00361</span><span class="p">,</span>
        <span class="s2">&quot;acai_o&quot;</span><span class="p">:</span> <span class="mf">0.00925</span><span class="p">,</span>
        <span class="s2">&quot;acai_v&quot;</span><span class="p">:</span> <span class="mf">2e-05</span><span class="p">,</span>
        <span class="s2">&quot;age&quot;</span><span class="p">:</span> <span class="mf">0.0</span><span class="p">,</span>
        <span class="s2">&quot;candid&quot;</span><span class="p">:</span> <span class="s2">&quot;1558254455015015000&quot;</span><span class="p">,</span>
        <span class="s2">&quot;n_det&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
    <span class="p">},</span>
    <span class="s2">&quot;id&quot;</span><span class="p">:</span> <span class="mi">916700</span><span class="p">,</span>
    <span class="s2">&quot;modified&quot;</span><span class="p">:</span> <span class="s2">&quot;2021-04-08T06:17:56.980090&quot;</span><span class="p">,</span>
    <span class="s2">&quot;obj_id&quot;</span><span class="p">:</span> <span class="s2">&quot;ZTF21aatjavc&quot;</span><span class="p">,</span>
    <span class="s2">&quot;origin&quot;</span><span class="p">:</span> <span class="s2">&quot;au-public:hosted&quot;</span><span class="p">,</span>
<span class="p">}]</span>
</pre></div>
</div>
</section>
</section>
<section id="alert-filters-in-fritz">
<h2>Alert filters in <code class="docutils literal notranslate"><span class="pre">Fritz</span></code><a class="headerlink" href="#alert-filters-in-fritz" title="Link to this heading">¶</a></h2>
<p>This section describes how to define alert stream filters within <code class="docutils literal notranslate"><span class="pre">Fritz</span></code> and provides some examples for reference.</p>
<section id="introduction">
<h3>Introduction<a class="headerlink" href="#introduction" title="Link to this heading">¶</a></h3>
<p><a class="reference external" href="https://github.com/ZwickyTransientFacility/ztf-avro-alert">ZTF alerts</a> are
<a class="reference external" href="https://iopscience.iop.org/article/10.1088/1538-3873/aae8ac/meta">generated at IPAC</a> based on difference
imaging analysis and are distributed to the world at low latency via a Kafka alert stream.
<code class="docutils literal notranslate"><span class="pre">Fritz</span></code>’s <code class="docutils literal notranslate"><span class="pre">Kowalski</span></code> backend consumes this stream, persisting the alerts to a <code class="docutils literal notranslate"><span class="pre">MongoDB</span></code> database,
and supplementing them with other useful quantities such as Galactic coordinates, external catalog cross-matches,
machine learning scores etc. Next, <code class="docutils literal notranslate"><span class="pre">Kowalski</span></code> executes a series of user-defined filters on each new (“enhanced”)
incoming alert accessible to the filter. Users create filters on the <code class="docutils literal notranslate"><span class="pre">SkyPortal</span></code> frontend and they are executed
on the <code class="docutils literal notranslate"><span class="pre">Kowalski</span></code> backend. If an alert passes a filter, it is pushed up to <code class="docutils literal notranslate"><span class="pre">SkyPortal</span></code> and appears on a program’s
scanning page.</p>
<p>Note: for a detailed description of the ZTF alerts and their contents, please see
<a class="reference external" href="https://github.com/ZwickyTransientFacility/ztf-avro-alert">here</a>.</p>
<section id="implementation-of-filters-as-mongodb-aggregation-pipelines">
<h4>Implementation of Filters as MongoDB Aggregation Pipelines<a class="headerlink" href="#implementation-of-filters-as-mongodb-aggregation-pipelines" title="Link to this heading">¶</a></h4>
<p><code class="docutils literal notranslate"><span class="pre">Kowalski</span></code> uses <a class="reference external" href="https://mongodb.com"><code class="docutils literal notranslate"><span class="pre">MongoDB</span></code></a>, a document-based NoSQL database, on the backend.</p>
<ul class="simple">
<li><p>For a very brief introduction into <code class="docutils literal notranslate"><span class="pre">MongoDB</span></code>, we recommend watching
<a class="reference external" href="https://www.youtube.com/watch?v=EE8ZTQxa0AM">MongoDB in 5 Minutes with Eliot Horowitz</a>.</p></li>
<li><p>If you are familiar with relational databases, you may want to check out the
<a class="reference external" href="https://docs.mongodb.com/manual/reference/sql-comparison/">SQL to MongoDB Mapping Chart</a>.</p></li>
</ul>
<p><code class="docutils literal notranslate"><span class="pre">MongoDB</span></code> database stores its data in “collections”. A collection holds one or more “documents”.
Documents are analogous to records or rows in a relational database table.
Each document has one or more “fields”; fields are similar to the columns in a relational database table.
<code class="docutils literal notranslate"><span class="pre">MongoDB</span></code> supports a rich query language, which we will make use of when working with the alert filters.</p>
<p>Alert filtering is implemented as a
<a class="reference external" href="https://docs.mongodb.com/manual/core/aggregation-pipeline/">MongoDB aggregation pipeline</a> that first “massages”
the newly ingested alert data such that the user’s filter deals with enhanced “packets” containing, for example,
longer photometry history (and not just the rolling 30-day window), cross-match data, and custom ML scores.</p>
<p>The <a class="reference external" href="https://docs.mongodb.com/manual/core/aggregation-pipeline/">MongoDB aggregation pipeline</a> is a framework
for data aggregation modeled on the concept of data processing pipelines. Documents enter a multi-stage pipeline
that transforms the documents into aggregated results.</p>
<p>An aggregation pipeline is represented as a list of dictionaries, each corresponding to a processing stage/step:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">[</span>
    <span class="p">{</span><span class="o">&lt;</span><span class="n">stage_1</span><span class="o">&gt;</span><span class="p">},</span>
    <span class="o">...</span>
    <span class="p">{</span><span class="o">&lt;</span><span class="n">stage_N</span><span class="o">&gt;</span><span class="p">}</span>
<span class="p">]</span>
</pre></div>
</div>
<p>Documents pass through the stages in sequence. Different stages can appear multiple times in a pipeline.</p>
<p>As of MongoDB version 4.2, there are 30 different types of aggregation pipeline stages, please see
<a class="reference external" href="https://docs.mongodb.com/manual/reference/operator/aggregation-pipeline/">the official documentation</a> for a detailed
description.</p>
<p>To manipulate documents, each stage uses
<a class="reference external" href="https://docs.mongodb.com/manual/meta/aggregation-quick-reference/#expressions">expressions</a>,
which can include field paths, literals, system variables, expression objects, and expression operators.
Expressions can be nested.</p>
</section>
<section id="testing-your-filter">
<h4>Testing your filter<a class="headerlink" href="#testing-your-filter" title="Link to this heading">¶</a></h4>
<p>To ease the process of writing and debugging the filters, we have set up two live <em>public</em> <code class="docutils literal notranslate"><span class="pre">MongoDB</span> <span class="pre">Atlas</span></code> databases
in the cloud:</p>
<ul class="simple">
<li><p>The first one contains a small curated set of ~300 sample public ZTF alerts originating from SNe, variable stars,
AGN, and bogus detections. The auxiliary information is limited to the detection history present in the alert packets.</p></li>
<li><p>The second one contains ~120,000 public ZTF alerts from July 6, 2020. The auxiliary information contains a ~100-day
history of detections (limited to reduce the test database size), cross-matches with external catalogs, and a few
additional computed quantities.</p></li>
</ul>
<p>We recommend to begin exploring filtering on the first database and then move onto the second one.</p>
<p>We will show how to use a tool called <a class="reference external" href="https://www.mongodb.com/try/download/compass">MongoDB Compass</a>
(the full version is now free) to construct and debug aggregation pipelines (aka alert filters), using the two cloud
databases, that can be then plugged into <code class="docutils literal notranslate"><span class="pre">Fritz</span></code>.</p>
<p>Filters will be managed on a dedicated page on <code class="docutils literal notranslate"><span class="pre">Fritz</span></code>. A detailed description of the interface and its capabilities
(including, for example, filter versioning and diff’ing) will be covered elsewhere – please stay tuned.</p>
<section id="mongodb-compass">
<h5>MongoDB Compass<a class="headerlink" href="#mongodb-compass" title="Link to this heading">¶</a></h5>
<p>Download and install MongoDB Compass for your system from <a class="reference external" href="https://www.mongodb.com/try/download/compass">here</a>.</p>
<p>The connection string to access the first sample public alert database:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>mongodb://ztf:FritzZwicky@fritz-test-shard-00-00-uas9d.gcp.mongodb.net:27017,fritz-test-shard-00-01-uas9d.gcp.mongodb.net:27017,fritz-test-shard-00-02-uas9d.gcp.mongodb.net:27017/test?authSource=admin&amp;replicaSet=fritz-test-shard-0&amp;readPreference=primary&amp;appname=MongoDB%20Compass&amp;ssl=true
</pre></div>
</div>
<p>The connection string to access the second sample public alert database:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">mongodb</span><span class="o">+</span><span class="n">srv</span><span class="p">:</span><span class="o">//</span><span class="n">ztf</span><span class="p">:</span><span class="n">FritzZwicky</span><span class="nd">@fritz</span><span class="o">-</span><span class="n">public</span><span class="o">-</span><span class="mf">20200706.</span><span class="n">uas9d</span><span class="o">.</span><span class="n">gcp</span><span class="o">.</span><span class="n">mongodb</span><span class="o">.</span><span class="n">net</span><span class="o">/</span><span class="n">kowalski</span>
</pre></div>
</div>
<p>Upon connection:</p>
<ul class="simple">
<li><p>Select the <code class="docutils literal notranslate"><span class="pre">kowalski</span></code> database</p></li>
<li><p>Select the <code class="docutils literal notranslate"><span class="pre">ZTF_alerts</span></code> collection</p></li>
<li><p>Go to the Aggregations tab</p></li>
<li><p>Click the down arrow located to the left of the “Collation” button and select “New Pipeline From Text”</p></li>
<li><p>Copy paste the contents of the provided JSON files with the sample filters (see below)</p></li>
</ul>
<p>Note that Compass shows the output of all stages interactively and also displays/explains any errors in the code,
which is extremely helpful for debugging and experimentation.</p>
<p>By default, Compass’ aggregation pipeline builder works in Sample Mode, showing up to 20 documents that pass any
given stage. You can change the default settings, including the default timeout by clicking the button
with a little gear next to the “Auto Preview” toggle switch.</p>
<p><img alt="fritz-filters-01" src="https://user-images.githubusercontent.com/7557205/87487417-6f66ff80-c5f2-11ea-8d7b-49c51b6a502d.gif" /></p>
<p>Note: the filter code that you will save on Fritz must be valid JSON, so, once you’re done with debugging,
when exporting a filter in Compass, select “NODE” under “Export Pipeline To:”, copy-paste into a text editor,
and then manually replace single quotes with double quotes. We also recommend using a text editor that can validate
JSON.</p>
</section>
</section>
<section id="upstream-aggregation-pipeline-stages">
<h4>“Upstream” aggregation pipeline stages<a class="headerlink" href="#upstream-aggregation-pipeline-stages" title="Link to this heading">¶</a></h4>
<p>[OPTIONAL READ]</p>
<p>The upstream “massaging” mentioned above is performed by <code class="docutils literal notranslate"><span class="pre">Fritz</span></code> for each alert and includes:</p>
<ul class="simple">
<li><p>Selecting the newly ingested alert from the <code class="docutils literal notranslate"><span class="pre">ZTF_alerts</span></code> collection by its <code class="docutils literal notranslate"><span class="pre">candid</span></code></p></li>
<li><p>Removing the image cutouts to reduce traffic</p></li>
<li><p>Joining the alert by its <code class="docutils literal notranslate"><span class="pre">objectId</span></code> with the corresponding entry in the <code class="docutils literal notranslate"><span class="pre">ZTF_alerts_aux</span></code> collection, which contains
the cross-matches, ML scores, computed quantities, and archival photometry / detection history</p></li>
</ul>
<p>The upstream stages also take care of the ACLs.</p>
<p><code class="docutils literal notranslate"><span class="pre">Fritz</span></code> uses the following four stages:</p>
<ul class="simple">
<li><p>The first <a class="reference external" href="https://docs.mongodb.com/manual/reference/operator/aggregation/match/"><code class="docutils literal notranslate"><span class="pre">$match</span></code></a>
stage selects the alert by its candid and ensures the ACLs are respected.</p></li>
</ul>
<p>For example, for a program that has access to the partnership data:</p>
<div class="highlight-json notranslate"><div class="highlight"><pre><span></span><span class="p">{</span>
<span class="w">  </span><span class="nt">&quot;$match&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nt">&quot;candid&quot;</span><span class="p">:</span><span class="w"> </span><span class="mi">1282486310015015001</span><span class="p">,</span>
<span class="w">    </span><span class="nt">&quot;candidate.programid&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nt">&quot;$in&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="p">]</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p>TIP: When debugging your filter with Compass, you may want to play around with this stage: try selecting an object
that must have passed the filter (when using the second database, that must have happened on July 6, 2020) by
specifying <code class="docutils literal notranslate"><span class="pre">&quot;objectId&quot;:</span> <span class="pre">&quot;&lt;ZTF</span> <span class="pre">object</span> <span class="pre">id&gt;&quot;</span></code>, or turning it off altogether to make Mongo look at all the alerts stored
in the sample database.</p>
<ul class="simple">
<li><p>The image cutouts are stored per alert, but generally not needed for the filtering purposes.
The <a class="reference external" href="https://docs.mongodb.com/manual/reference/operator/aggregation/project/"><code class="docutils literal notranslate"><span class="pre">$project</span></code></a> stage
removes them:</p></li>
</ul>
<div class="highlight-json notranslate"><div class="highlight"><pre><span></span><span class="p">{</span>
<span class="w">  </span><span class="nt">&quot;$project&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nt">&quot;cutoutScience&quot;</span><span class="p">:</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span>
<span class="w">    </span><span class="nt">&quot;cutoutTemplate&quot;</span><span class="p">:</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span>
<span class="w">    </span><span class="nt">&quot;cutoutDifference&quot;</span><span class="p">:</span><span class="w"> </span><span class="mi">0</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<ul class="simple">
<li><p>Using the <a class="reference external" href="https://docs.mongodb.com/manual/reference/operator/aggregation/lookup/"><code class="docutils literal notranslate"><span class="pre">$lookup</span></code></a> stage,
the alert data are joined with auxiliary data stored in the <code class="docutils literal notranslate"><span class="pre">ZTF_alerts_aux</span></code> collection, which uses the alert’s
<code class="docutils literal notranslate"><span class="pre">objectId</span></code>s as unique document identifiers (<code class="docutils literal notranslate"><span class="pre">_id</span></code> - a concept in MongoDB similar to primary keys in SQL):</p></li>
</ul>
<div class="highlight-json notranslate"><div class="highlight"><pre><span></span><span class="w">  </span><span class="p">{</span>
<span class="w">    </span><span class="nt">&quot;$lookup&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nt">&quot;from&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;ZTF_alerts_aux&quot;</span><span class="p">,</span>
<span class="w">      </span><span class="nt">&quot;localField&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;objectId&quot;</span><span class="p">,</span>
<span class="w">      </span><span class="nt">&quot;foreignField&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;_id&quot;</span><span class="p">,</span>
<span class="w">      </span><span class="nt">&quot;as&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;aux&quot;</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">  </span><span class="p">}</span>
</pre></div>
</div>
<ul class="simple">
<li><p>The final <a class="reference external" href="https://docs.mongodb.com/manual/reference/operator/aggregation/project/"><code class="docutils literal notranslate"><span class="pre">$project</span></code></a> stage reshapes
the joined data for convenience, selects the last 365 days of photometry history (which is done having practical
considerations in mind and may be relaxed in the future),
and applies ACLs to the detection history stored in <code class="docutils literal notranslate"><span class="pre">prv_candidates</span></code>:</p></li>
</ul>
<div class="highlight-json notranslate"><div class="highlight"><pre><span></span><span class="p">{</span>
<span class="w">  </span><span class="nt">&quot;$project&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nt">&quot;cross_matches&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nt">&quot;$arrayElemAt&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[</span>
<span class="w">        </span><span class="s2">&quot;$aux.cross_matches&quot;</span><span class="p">,</span>
<span class="w">        </span><span class="mi">0</span>
<span class="w">      </span><span class="p">]</span>
<span class="w">    </span><span class="p">},</span>
<span class="w">    </span><span class="nt">&quot;prv_candidates&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nt">&quot;$filter&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nt">&quot;input&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">          </span><span class="nt">&quot;$arrayElemAt&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[</span>
<span class="w">            </span><span class="s2">&quot;$aux.prv_candidates&quot;</span><span class="p">,</span>
<span class="w">            </span><span class="mi">0</span>
<span class="w">          </span><span class="p">]</span>
<span class="w">        </span><span class="p">},</span>
<span class="w">        </span><span class="nt">&quot;as&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;item&quot;</span><span class="p">,</span>
<span class="w">        </span><span class="nt">&quot;cond&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">          </span><span class="nt">&quot;$and&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[</span>
<span class="w">            </span><span class="p">{</span>
<span class="w">              </span><span class="nt">&quot;$in&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[</span>
<span class="w">                </span><span class="s2">&quot;$$item.programid&quot;</span><span class="p">,</span>
<span class="w">                </span><span class="p">[</span>
<span class="w">                  </span><span class="mi">1</span><span class="p">,</span>
<span class="w">                  </span><span class="mi">2</span><span class="p">,</span>
<span class="w">                  </span><span class="mi">3</span>
<span class="w">                </span><span class="p">]</span>
<span class="w">              </span><span class="p">]</span>
<span class="w">            </span><span class="p">},</span>
<span class="w">            </span><span class="p">{</span>
<span class="w">              </span><span class="nt">&quot;$lt&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[</span>
<span class="w">                </span><span class="p">{</span>
<span class="w">                  </span><span class="nt">&quot;$subtract&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[</span>
<span class="w">                    </span><span class="s2">&quot;$candidate.jd&quot;</span><span class="p">,</span>
<span class="w">                    </span><span class="s2">&quot;$$item.jd&quot;</span>
<span class="w">                  </span><span class="p">]</span>
<span class="w">                </span><span class="p">},</span>
<span class="w">                </span><span class="mi">365</span>
<span class="w">              </span><span class="p">]</span>
<span class="w">            </span><span class="p">}</span>
<span class="w">          </span><span class="p">]</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">      </span><span class="p">}</span>
<span class="w">    </span><span class="p">},</span>
<span class="w">    </span><span class="nt">&quot;schemavsn&quot;</span><span class="p">:</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span>
<span class="w">    </span><span class="nt">&quot;publisher&quot;</span><span class="p">:</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span>
<span class="w">    </span><span class="nt">&quot;objectId&quot;</span><span class="p">:</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span>
<span class="w">    </span><span class="nt">&quot;candid&quot;</span><span class="p">:</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span>
<span class="w">    </span><span class="nt">&quot;candidate&quot;</span><span class="p">:</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span>
<span class="w">    </span><span class="nt">&quot;classifications&quot;</span><span class="p">:</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span>
<span class="w">    </span><span class="nt">&quot;coordinates&quot;</span><span class="p">:</span><span class="w"> </span><span class="mi">1</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p>The user-defined filter stages then operate on the “enhanced” packets that look like this:</p>
<p><img alt="img/filter-04.png" src="_images/filter-04.png" /></p>
<p><code class="docutils literal notranslate"><span class="pre">Fritz</span></code> automatically prepends these stages to all user-defined filters. However, when constructing/debugging
filters in Compass, the users must take care of that – all the examples below come with the upstream stages prepended.</p>
</section>
<section id="limitations">
<h4>Limitations<a class="headerlink" href="#limitations" title="Link to this heading">¶</a></h4>
<p><code class="docutils literal notranslate"><span class="pre">$lookup</span></code>, <code class="docutils literal notranslate"><span class="pre">$unionWith</span></code>, <code class="docutils literal notranslate"><span class="pre">$out</span></code>, and <code class="docutils literal notranslate"><span class="pre">$merge</span></code> stages are not allowed in the user-defined part of the filters.</p>
</section>
<section id="alert-data-augmentation">
<h4>Alert data augmentation<a class="headerlink" href="#alert-data-augmentation" title="Link to this heading">¶</a></h4>
<p>Fritz’s Kowalski backend augments the alert data with the following: [as of January 2021]</p>
<ul class="simple">
<li><p>Galactic coordinates</p></li>
<li><p>Cross-matches with external catalogs:</p>
<ul>
<li><p>2MASS_PSC (all matches within 2”)</p></li>
<li><p>AllWISE (all matches within 2”)</p></li>
<li><p>GALEX (all matches within 2”)</p></li>
<li><p>Gaia_DR2 (all matches within 2”)</p></li>
<li><p>Gaia_EDR3 (all matches within 2”)</p></li>
<li><p>Gaia_DR2_WD (all matches within 2”)</p></li>
<li><p>IPHAS_DR2 (all matches within 2”)</p></li>
<li><p>LAMOST_DR5_v3 (all matches within 2”)</p></li>
<li><p>PS1_DR1 (all matches within 2”)</p></li>
<li><p>PS1_STRM (all matches within 2”)</p></li>
<li><p>galaxy_redshifts_20200522 (all matches within 2”)</p></li>
<li><p>CLU_20190625 (<a class="reference external" href="https://github.com/dmitryduev/kowalski/blob/master/kowalski/alert_broker_ztf.py#L351">“elliptical” matches with close galaxies using 3x their size</a>)</p></li>
</ul>
</li>
</ul>
<p>For the detailed description of the available catalogs, see <a class="reference internal" href="#catalogs.html"><span class="xref myst">here</span></a></p>
<ul class="simple">
<li><p>Machine learning scores:</p>
<ul>
<li><p><a class="reference external" href="https://academic.oup.com/mnras/article/489/3/3582/5554758"><code class="docutils literal notranslate"><span class="pre">braai</span></code></a> version <code class="docutils literal notranslate"><span class="pre">d6_m9</span></code> – real/bogus classifier</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">acai_h</span></code> version <code class="docutils literal notranslate"><span class="pre">d1_dnn_20201130</span></code> – phenomenological classifier, “hosted”</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">acai_o</span></code> version <code class="docutils literal notranslate"><span class="pre">d1_dnn_20201130</span></code> – phenomenological classifier, “orphan”</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">acai_n</span></code> version <code class="docutils literal notranslate"><span class="pre">d1_dnn_20201130</span></code> – phenomenological classifier, “nuclear”</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">acai_v</span></code> version <code class="docutils literal notranslate"><span class="pre">d1_dnn_20201130</span></code> – phenomenological classifier, “variable star”</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">acai_b</span></code> version <code class="docutils literal notranslate"><span class="pre">d1_dnn_20201130</span></code> – phenomenological classifier, “bogus”</p></li>
</ul>
</li>
</ul>
<section id="acai">
<h5>ACAI<a class="headerlink" href="#acai" title="Link to this heading">¶</a></h5>
<p>In November 2020, we deployed a set of new phenomenological deep learning classifiers called
ACAI (Alert-Classifying AI; publication in prep.).
The system consists of 5 binary classifiers:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">acai_h</span></code> – “hosted” – genuine transient in the vicinity of a “host” with (some) morphology,
e.g. something one could call a galaxy; should catch SN, Novae etc</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">acai_o</span></code> – “orphan” – a genuine orphan transient, i.e. there are no identifiable “hosts” in its vicinity;
catches asteroids and hostless (or with hosts that are too faint) transients</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">acai_n</span></code> – “nuclear” – a genuine transient occurring in a galaxy/quasar nucleus; should catch AGN, TDEs, etc.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">acai_v</span></code> – “variable star” – variable star</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">acai_b</span></code> – “bogus” – a new version of the real/bogus classifier; could be thought of as (1 - braai)</p></li>
</ul>
<p>Each classifier takes as input 25 features from the candidate section of a ZTF alert packet and a stack of
full-sized thumbnails (science/reference (template)/difference) and produces a score from 0 to 1:</p>
<p><img alt="img/acai_h.d1_dnn_20201130.png" src="_images/acai_h.d1_dnn_20201130.png" /></p>
<p>All classifiers were trained on more than 200,000 diverse alerts covering a large part of the phase space.
The classifiers, although potentially correlated in their output, act independently and so can be
mixed and matched and applied alongside other alert features.</p>
</section>
</section>
</section>
<section id="filter-examples">
<h3>Filter examples<a class="headerlink" href="#filter-examples" title="Link to this heading">¶</a></h3>
<p>Let us explore some examples! The provided JSON files contain prepended upstream stages, but they are not shown in the
text below for brevity.</p>
<section id="simple-filter">
<h4>Simple filter<a class="headerlink" href="#simple-filter" title="Link to this heading">¶</a></h4>
<p>Let us start with a very simplistic example:</p>
<p><a class="reference download internal" download="" href="_downloads/3a45ff49357d80c6aaf7e59d4f9a6ecc/fritz_filter_101.json"><code class="xref download docutils literal notranslate"><span class="pre">fritz_filter_101.json</span></code></a></p>
<p>The first user-defined <a class="reference external" href="https://docs.mongodb.com/manual/reference/operator/aggregation/match/"><code class="docutils literal notranslate"><span class="pre">$match</span></code></a>
stage selects alerts with deep-learning-based real-bogus scores (<code class="docutils literal notranslate"><span class="pre">candidate.drb</span></code>) greater than 0.9999999
that don’t have any matches with the <code class="docutils literal notranslate"><span class="pre">Gaia_DR2</span></code> catalog
(the zeroth element of the corresponding array does not exist)</p>
<div class="highlight-json notranslate"><div class="highlight"><pre><span></span><span class="p">{</span>
<span class="w">  </span><span class="nt">&quot;$match&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nt">&quot;candidate.drb&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nt">&quot;$gt&quot;</span><span class="p">:</span><span class="w"> </span><span class="mf">0.9999999</span>
<span class="w">    </span><span class="p">},</span>
<span class="w">    </span><span class="nt">&quot;cross_matches.Gaia_DR2.0&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nt">&quot;$exists&quot;</span><span class="p">:</span><span class="w"> </span><span class="kc">false</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p>In case an alert passes the first stage, the output stage adds the annotations dictionary:</p>
<div class="highlight-json notranslate"><div class="highlight"><pre><span></span><span class="p">{</span>
<span class="w">  </span><span class="nt">&quot;$project&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nt">&quot;_id&quot;</span><span class="p">:</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span>
<span class="w">    </span><span class="nt">&quot;candid&quot;</span><span class="p">:</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span>
<span class="w">    </span><span class="nt">&quot;objectId&quot;</span><span class="p">:</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span>
<span class="w">    </span><span class="nt">&quot;annotations.author&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;dd&quot;</span><span class="p">,</span>
<span class="w">    </span><span class="nt">&quot;annotations.mean_rb&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nt">&quot;$avg&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;$prv_candidates.rb&quot;</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p><code class="docutils literal notranslate"><span class="pre">candid</span></code> and <code class="docutils literal notranslate"><span class="pre">objectId</span></code> are kept here for the debugging purposes, to see which alerts pass your filter.</p>
<p>The output of the filter will look something like this:</p>
<p><img alt="img/filter-05.png" src="_images/filter-05.png" /></p>
<p>This alert will be posted to the candidates page with these annotations.</p>
</section>
<section id="acai-hosted-filter">
<h4>ACAI-hosted filter<a class="headerlink" href="#acai-hosted-filter" title="Link to this heading">¶</a></h4>
<p>Let us build a filter that primarily relies on the ACAI ML models to select transients that are confidently
classified as “hosted” (and nothing else), and are a positive subtraction (<code class="docutils literal notranslate"><span class="pre">candidate.isdiffpos</span></code>) and
not a known Solar system object (<code class="docutils literal notranslate"><span class="pre">candidate.ssdistnr</span></code>):</p>
<div class="highlight-json notranslate"><div class="highlight"><pre><span></span><span class="p">[</span>
<span class="w">  </span><span class="p">{</span>
<span class="w">    </span><span class="nt">&quot;$match&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nt">&quot;classifications.acai_h&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="nt">&quot;$gte&quot;</span><span class="p">:</span><span class="w"> </span><span class="mf">0.8</span><span class="p">},</span>
<span class="w">      </span><span class="nt">&quot;classifications.acai_b&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="nt">&quot;$lt&quot;</span><span class="p">:</span><span class="w"> </span><span class="mf">0.1</span><span class="p">},</span>
<span class="w">      </span><span class="nt">&quot;classifications.acai_v&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="nt">&quot;$lt&quot;</span><span class="p">:</span><span class="w"> </span><span class="mf">0.1</span><span class="p">},</span>
<span class="w">      </span><span class="nt">&quot;classifications.acai_o&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="nt">&quot;$lt&quot;</span><span class="p">:</span><span class="w"> </span><span class="mf">0.4</span><span class="p">},</span>
<span class="w">      </span><span class="nt">&quot;classifications.acai_n&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="nt">&quot;$lt&quot;</span><span class="p">:</span><span class="w"> </span><span class="mf">0.4</span><span class="p">},</span>
<span class="w">      </span><span class="nt">&quot;candidate.ssdistnr&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="nt">&quot;$lt&quot;</span><span class="p">:</span><span class="w"> </span><span class="mi">0</span><span class="p">},</span>
<span class="w">      </span><span class="nt">&quot;candidate.isdiffpos&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="nt">&quot;$in&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;1&quot;</span><span class="p">,</span><span class="w"> </span><span class="kc">true</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;t&quot;</span><span class="p">]}</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">  </span><span class="p">},</span>
<span class="w">  </span><span class="p">{</span>
<span class="w">    </span><span class="nt">&quot;$project&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nt">&quot;annotations.age&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="nt">&quot;$round&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[{</span><span class="nt">&quot;$subtract&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="s2">&quot;$candidate.jd&quot;</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;$candidate.jdstarthist&quot;</span><span class="p">]},</span><span class="w"> </span><span class="mi">5</span><span class="p">]},</span>
<span class="w">      </span><span class="nt">&quot;annotations.n_det&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;$candidate.ndethist&quot;</span><span class="p">,</span>
<span class="w">      </span><span class="nt">&quot;annotations.candid&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="nt">&quot;$toString&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;$candid&quot;</span><span class="p">},</span>
<span class="w">      </span><span class="nt">&quot;annotations.acai_h&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="nt">&quot;$round&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="s2">&quot;$classifications.acai_h&quot;</span><span class="p">,</span><span class="w"> </span><span class="mi">5</span><span class="p">]},</span>
<span class="w">      </span><span class="nt">&quot;annotations.acai_v&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="nt">&quot;$round&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="s2">&quot;$classifications.acai_v&quot;</span><span class="p">,</span><span class="w"> </span><span class="mi">5</span><span class="p">]},</span>
<span class="w">      </span><span class="nt">&quot;annotations.acai_o&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="nt">&quot;$round&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="s2">&quot;$classifications.acai_o&quot;</span><span class="p">,</span><span class="w"> </span><span class="mi">5</span><span class="p">]},</span>
<span class="w">      </span><span class="nt">&quot;annotations.acai_n&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="nt">&quot;$round&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="s2">&quot;$classifications.acai_n&quot;</span><span class="p">,</span><span class="w"> </span><span class="mi">5</span><span class="p">]},</span>
<span class="w">      </span><span class="nt">&quot;annotations.acai_b&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="nt">&quot;$round&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="s2">&quot;$classifications.acai_b&quot;</span><span class="p">,</span><span class="w"> </span><span class="mi">5</span><span class="p">]}</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">]</span>
</pre></div>
</div>
</section>
<section id="clu-filter">
<h4>CLU filter<a class="headerlink" href="#clu-filter" title="Link to this heading">¶</a></h4>
<p>Now that we’ve looked at basic examples, let us explore a more complex case and build a filter for
the <a class="reference external" href="https://ui.adsabs.harvard.edu/abs/2020arXiv200409029D/abstract">Census of the Local Universe</a> program.</p>
<p>As a reference, we will use the filter definition (as of July 10, 2020)
from the GROWTH marshal translated into <code class="docutils literal notranslate"><span class="pre">python</span></code> code (copy-pasted here with no alterations):</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">clu_filter</span><span class="p">(</span><span class="n">current_observation</span><span class="p">):</span>
    <span class="n">filteron</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="n">annotations</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">calccount</span> <span class="o">=</span> <span class="mi">10000</span>
    <span class="n">bright</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="n">nopointunderneath</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="n">mover</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="n">real</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="n">tdiff</span> <span class="o">=</span> <span class="p">(</span><span class="o">-</span><span class="mf">99.0</span><span class="p">)</span>
    <span class="n">magdiff</span> <span class="o">=</span> <span class="p">(</span><span class="o">-</span><span class="mi">99</span><span class="p">)</span>
    <span class="n">riserate</span> <span class="o">=</span> <span class="p">(</span><span class="o">-</span><span class="mi">99</span><span class="p">)</span>
    <span class="n">decayrate</span> <span class="o">=</span> <span class="p">(</span><span class="o">-</span><span class="mi">99</span><span class="p">)</span>
    <span class="n">hostgr</span> <span class="o">=</span> <span class="p">(</span><span class="o">-</span><span class="mi">99</span><span class="p">)</span>
    <span class="n">hostri</span> <span class="o">=</span> <span class="p">(</span><span class="o">-</span><span class="mi">99</span><span class="p">)</span>
    <span class="n">positivesubtraction</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="n">brightstar</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="n">highlum</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="n">deltajd</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">prevcandidates</span> <span class="o">=</span> <span class="n">current_observation</span><span class="p">[</span><span class="s1">&#39;prv_candidates&#39;</span><span class="p">]</span>
    <span class="n">m_now</span> <span class="o">=</span> <span class="n">current_observation</span><span class="p">[</span><span class="s1">&#39;candidate&#39;</span><span class="p">][</span><span class="s1">&#39;magpsf&#39;</span><span class="p">]</span>
    <span class="n">m_app</span> <span class="o">=</span> <span class="n">current_observation</span><span class="p">[</span><span class="s1">&#39;candidate&#39;</span><span class="p">][</span><span class="s1">&#39;magap&#39;</span><span class="p">]</span>
    <span class="n">t_now</span> <span class="o">=</span> <span class="n">current_observation</span><span class="p">[</span><span class="s1">&#39;candidate&#39;</span><span class="p">][</span><span class="s1">&#39;jd&#39;</span><span class="p">]</span>
    <span class="n">fid_now</span> <span class="o">=</span> <span class="n">current_observation</span><span class="p">[</span><span class="s1">&#39;candidate&#39;</span><span class="p">][</span><span class="s1">&#39;fid&#39;</span><span class="p">]</span>
    <span class="n">sgscore</span> <span class="o">=</span> <span class="n">current_observation</span><span class="p">[</span><span class="s1">&#39;candidate&#39;</span><span class="p">][</span><span class="s1">&#39;sgscore1&#39;</span><span class="p">]</span>
    <span class="n">sgscore2</span> <span class="o">=</span> <span class="n">current_observation</span><span class="p">[</span><span class="s1">&#39;candidate&#39;</span><span class="p">][</span><span class="s1">&#39;sgscore2&#39;</span><span class="p">]</span>
    <span class="n">sgscore3</span> <span class="o">=</span> <span class="n">current_observation</span><span class="p">[</span><span class="s1">&#39;candidate&#39;</span><span class="p">][</span><span class="s1">&#39;sgscore3&#39;</span><span class="p">]</span>
    <span class="n">srmag</span> <span class="o">=</span> <span class="n">current_observation</span><span class="p">[</span><span class="s1">&#39;candidate&#39;</span><span class="p">][</span><span class="s1">&#39;srmag1&#39;</span><span class="p">]</span>
    <span class="n">srmag2</span> <span class="o">=</span> <span class="n">current_observation</span><span class="p">[</span><span class="s1">&#39;candidate&#39;</span><span class="p">][</span><span class="s1">&#39;srmag2&#39;</span><span class="p">]</span>
    <span class="n">srmag3</span> <span class="o">=</span> <span class="n">current_observation</span><span class="p">[</span><span class="s1">&#39;candidate&#39;</span><span class="p">][</span><span class="s1">&#39;srmag3&#39;</span><span class="p">]</span>
    <span class="n">sgmag</span> <span class="o">=</span> <span class="n">current_observation</span><span class="p">[</span><span class="s1">&#39;candidate&#39;</span><span class="p">][</span><span class="s1">&#39;sgmag1&#39;</span><span class="p">]</span>
    <span class="n">simag</span> <span class="o">=</span> <span class="n">current_observation</span><span class="p">[</span><span class="s1">&#39;candidate&#39;</span><span class="p">][</span><span class="s1">&#39;simag1&#39;</span><span class="p">]</span>
    <span class="n">rbscore</span> <span class="o">=</span> <span class="n">current_observation</span><span class="p">[</span><span class="s1">&#39;candidate&#39;</span><span class="p">][</span><span class="s1">&#39;rb&#39;</span><span class="p">]</span>
    <span class="n">magnr</span> <span class="o">=</span> <span class="n">current_observation</span><span class="p">[</span><span class="s1">&#39;candidate&#39;</span><span class="p">][</span><span class="s1">&#39;magnr&#39;</span><span class="p">]</span>
    <span class="n">distnr</span> <span class="o">=</span> <span class="n">current_observation</span><span class="p">[</span><span class="s1">&#39;candidate&#39;</span><span class="p">][</span><span class="s1">&#39;distnr&#39;</span><span class="p">]</span>
    <span class="n">distpsnr1</span> <span class="o">=</span> <span class="n">current_observation</span><span class="p">[</span><span class="s1">&#39;candidate&#39;</span><span class="p">][</span><span class="s1">&#39;distpsnr1&#39;</span><span class="p">]</span>
    <span class="n">distpsnr2</span> <span class="o">=</span> <span class="n">current_observation</span><span class="p">[</span><span class="s1">&#39;candidate&#39;</span><span class="p">][</span><span class="s1">&#39;distpsnr2&#39;</span><span class="p">]</span>
    <span class="n">distpsnr3</span> <span class="o">=</span> <span class="n">current_observation</span><span class="p">[</span><span class="s1">&#39;candidate&#39;</span><span class="p">][</span><span class="s1">&#39;distpsnr3&#39;</span><span class="p">]</span>
    <span class="n">scorr</span> <span class="o">=</span> <span class="n">current_observation</span><span class="p">[</span><span class="s1">&#39;candidate&#39;</span><span class="p">][</span><span class="s1">&#39;scorr&#39;</span><span class="p">]</span>
    <span class="n">fwhm</span> <span class="o">=</span> <span class="n">current_observation</span><span class="p">[</span><span class="s1">&#39;candidate&#39;</span><span class="p">][</span><span class="s1">&#39;fwhm&#39;</span><span class="p">]</span>
    <span class="n">elong</span> <span class="o">=</span> <span class="n">current_observation</span><span class="p">[</span><span class="s1">&#39;candidate&#39;</span><span class="p">][</span><span class="s1">&#39;elong&#39;</span><span class="p">]</span>
    <span class="n">nbad</span> <span class="o">=</span> <span class="n">current_observation</span><span class="p">[</span><span class="s1">&#39;candidate&#39;</span><span class="p">][</span><span class="s1">&#39;nbad&#39;</span><span class="p">]</span>
    <span class="n">chipsf</span> <span class="o">=</span> <span class="n">current_observation</span><span class="p">[</span><span class="s1">&#39;candidate&#39;</span><span class="p">][</span><span class="s1">&#39;chipsf&#39;</span><span class="p">]</span>
    <span class="n">gal_lat</span> <span class="o">=</span> <span class="n">current_observation</span><span class="p">[</span><span class="s1">&#39;candidate&#39;</span><span class="p">][</span><span class="s1">&#39;gal_lat&#39;</span><span class="p">]</span>
    <span class="n">jdstarthist</span> <span class="o">=</span> <span class="n">current_observation</span><span class="p">[</span><span class="s1">&#39;candidate&#39;</span><span class="p">][</span><span class="s1">&#39;jdstarthist&#39;</span><span class="p">]</span>
    <span class="n">jdendhist</span> <span class="o">=</span> <span class="n">current_observation</span><span class="p">[</span><span class="s1">&#39;candidate&#39;</span><span class="p">][</span><span class="s1">&#39;jdendhist&#39;</span><span class="p">]</span>
    <span class="n">ssdistnr</span> <span class="o">=</span> <span class="n">current_observation</span><span class="p">[</span><span class="s1">&#39;candidate&#39;</span><span class="p">][</span><span class="s1">&#39;ssdistnr&#39;</span><span class="p">]</span>
    <span class="n">ssmagnr</span> <span class="o">=</span> <span class="n">current_observation</span><span class="p">[</span><span class="s1">&#39;candidate&#39;</span><span class="p">][</span><span class="s1">&#39;ssmagnr&#39;</span><span class="p">]</span>
    <span class="n">drb</span> <span class="o">=</span> <span class="n">current_observation</span><span class="p">[</span><span class="s1">&#39;candidate&#39;</span><span class="p">][</span><span class="s1">&#39;drb&#39;</span><span class="p">]</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">jdstarthist</span> <span class="ow">and</span> <span class="n">jdendhist</span><span class="p">):</span>
        <span class="n">deltajd</span> <span class="o">=</span> <span class="n">jdendhist</span> <span class="o">-</span> <span class="n">jdstarthist</span>
        <span class="n">calccount</span> <span class="o">-=</span> <span class="mi">2</span>
    <span class="n">psfminap</span> <span class="o">=</span> <span class="n">m_now</span> <span class="o">-</span> <span class="n">m_app</span>
    <span class="n">bright</span> <span class="o">=</span> <span class="n">m_now</span> <span class="o">&lt;</span> <span class="mf">99.0</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">current_observation</span><span class="p">[</span><span class="s1">&#39;candidate&#39;</span><span class="p">][</span><span class="s1">&#39;isdiffpos&#39;</span><span class="p">]</span> <span class="ow">and</span> <span class="p">(</span><span class="n">current_observation</span><span class="p">[</span><span class="s1">&#39;candidate&#39;</span><span class="p">][</span><span class="s1">&#39;isdiffpos&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;t&#39;</span> <span class="ow">or</span> <span class="n">current_observation</span><span class="p">[</span><span class="s1">&#39;candidate&#39;</span><span class="p">][</span><span class="s1">&#39;isdiffpos&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;1&#39;</span><span class="p">)):</span>
        <span class="n">positivesubtraction</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="n">calccount</span> <span class="o">-=</span> <span class="mi">2</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">rbscore</span> <span class="ow">and</span> <span class="n">rbscore</span> <span class="o">&gt;</span> <span class="mf">0.3</span> <span class="ow">and</span> <span class="n">drb</span> <span class="o">&gt;</span> <span class="mf">0.5</span> <span class="ow">and</span> <span class="n">fwhm</span> <span class="o">&gt;</span> <span class="mf">0.5</span> <span class="ow">and</span> <span class="n">fwhm</span> <span class="o">&lt;</span> <span class="mi">8</span> <span class="ow">and</span> <span class="n">nbad</span> <span class="o">&lt;</span> <span class="mi">5</span> <span class="ow">and</span> <span class="p">(</span><span class="n">psfminap</span> <span class="o">&lt;</span> <span class="mf">0.75</span> <span class="ow">or</span> <span class="n">psfminap</span> <span class="o">&gt;</span> <span class="p">(</span><span class="o">-</span><span class="mf">0.75</span><span class="p">))):</span>
        <span class="n">real</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="n">calccount</span> <span class="o">-=</span> <span class="mi">2</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">sgscore</span> <span class="ow">and</span> <span class="n">distpsnr1</span> <span class="ow">and</span> <span class="n">sgscore</span> <span class="o">&gt;</span> <span class="mf">0.76</span> <span class="ow">and</span> <span class="n">distpsnr1</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">):</span>
        <span class="n">nopointunderneath</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="n">calccount</span> <span class="o">-=</span> <span class="mi">2</span>
    <span class="k">if</span> <span class="p">((</span><span class="n">distpsnr1</span> <span class="ow">and</span> <span class="n">srmag</span> <span class="ow">and</span> <span class="n">distpsnr1</span> <span class="o">&lt;</span> <span class="mi">20</span> <span class="ow">and</span> <span class="n">srmag</span> <span class="o">&lt;</span> <span class="mf">15.0</span> <span class="ow">and</span> <span class="n">srmag</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">sgscore</span> <span class="o">&gt;</span> <span class="mf">0.49</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="n">distpsnr2</span> <span class="ow">and</span> <span class="n">srmag2</span> <span class="ow">and</span> <span class="n">distpsnr2</span> <span class="o">&lt;</span> <span class="mi">20</span> <span class="ow">and</span> <span class="n">srmag2</span> <span class="o">&lt;</span> <span class="mf">15.0</span> <span class="ow">and</span> <span class="n">srmag2</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">sgscore2</span> <span class="o">&gt;</span> <span class="mf">0.49</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="n">distpsnr3</span> <span class="ow">and</span> <span class="n">srmag3</span> <span class="ow">and</span> <span class="n">distpsnr3</span> <span class="o">&lt;</span> <span class="mi">20</span> <span class="ow">and</span> <span class="n">srmag3</span> <span class="o">&lt;</span> <span class="mf">15.0</span> <span class="ow">and</span> <span class="n">srmag3</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">sgscore3</span> <span class="o">&gt;</span> <span class="mf">0.49</span><span class="p">)):</span>
        <span class="n">brightstar</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="n">calccount</span> <span class="o">-=</span> <span class="mi">2</span>
    <span class="k">for</span> <span class="n">candidate</span> <span class="ow">in</span> <span class="n">prevcandidates</span><span class="p">:</span>
        <span class="n">calccount</span> <span class="o">-=</span> <span class="mi">2</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">candidate</span><span class="p">[</span><span class="s1">&#39;jd&#39;</span><span class="p">]</span> <span class="ow">and</span> <span class="n">candidate</span><span class="p">[</span><span class="s1">&#39;magpsf&#39;</span><span class="p">]</span> <span class="ow">and</span> <span class="n">candidate</span><span class="p">[</span><span class="s1">&#39;fid&#39;</span><span class="p">]</span> <span class="ow">and</span> <span class="n">candidate</span><span class="p">[</span><span class="s1">&#39;isdiffpos&#39;</span><span class="p">]</span> <span class="ow">and</span> <span class="p">(</span><span class="n">candidate</span><span class="p">[</span><span class="s1">&#39;isdiffpos&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;t&#39;</span> <span class="ow">or</span> <span class="n">candidate</span><span class="p">[</span><span class="s1">&#39;isdiffpos&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;1&#39;</span><span class="p">)):</span>
            <span class="n">dt</span> <span class="o">=</span> <span class="n">t_now</span> <span class="o">-</span> <span class="n">candidate</span><span class="p">[</span><span class="s1">&#39;jd&#39;</span><span class="p">]</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">dt</span> <span class="o">&gt;</span> <span class="mf">0.02</span> <span class="ow">and</span> <span class="n">candidate</span><span class="p">[</span><span class="s1">&#39;magpsf&#39;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">99</span> <span class="ow">and</span> <span class="p">(</span><span class="n">ssdistnr</span> <span class="o">&gt;</span> <span class="mi">2</span> <span class="ow">or</span> <span class="n">ssdistnr</span> <span class="o">&lt;</span> <span class="p">(</span><span class="o">-</span><span class="mf">0.5</span><span class="p">))):</span>
                <span class="n">mover</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="n">calccount</span> <span class="o">-=</span> <span class="mi">2</span>
            <span class="n">calccount</span> <span class="o">-=</span> <span class="mi">3</span>
        <span class="k">if</span> <span class="n">calccount</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">break</span>
    <span class="n">prevcandidates</span> <span class="o">=</span> <span class="n">current_observation</span><span class="p">[</span><span class="s1">&#39;prv_candidates&#39;</span><span class="p">]</span>
    <span class="n">m_now</span> <span class="o">=</span> <span class="n">current_observation</span><span class="p">[</span><span class="s1">&#39;candidate&#39;</span><span class="p">][</span><span class="s1">&#39;magpsf&#39;</span><span class="p">]</span>
    <span class="n">m_max</span> <span class="o">=</span> <span class="n">current_observation</span><span class="p">[</span><span class="s1">&#39;candidate&#39;</span><span class="p">][</span><span class="s1">&#39;magpsf&#39;</span><span class="p">]</span>
    <span class="n">m_min</span> <span class="o">=</span> <span class="n">current_observation</span><span class="p">[</span><span class="s1">&#39;candidate&#39;</span><span class="p">][</span><span class="s1">&#39;magpsf&#39;</span><span class="p">]</span>
    <span class="n">t_now</span> <span class="o">=</span> <span class="n">current_observation</span><span class="p">[</span><span class="s1">&#39;candidate&#39;</span><span class="p">][</span><span class="s1">&#39;jd&#39;</span><span class="p">]</span>
    <span class="n">t_max</span> <span class="o">=</span> <span class="n">current_observation</span><span class="p">[</span><span class="s1">&#39;candidate&#39;</span><span class="p">][</span><span class="s1">&#39;jd&#39;</span><span class="p">]</span>
    <span class="n">t_min</span> <span class="o">=</span> <span class="n">current_observation</span><span class="p">[</span><span class="s1">&#39;candidate&#39;</span><span class="p">][</span><span class="s1">&#39;jd&#39;</span><span class="p">]</span>
    <span class="n">fid_now</span> <span class="o">=</span> <span class="n">current_observation</span><span class="p">[</span><span class="s1">&#39;candidate&#39;</span><span class="p">][</span><span class="s1">&#39;fid&#39;</span><span class="p">]</span>
    <span class="k">for</span> <span class="n">candidate</span> <span class="ow">in</span> <span class="n">prevcandidates</span><span class="p">:</span>
        <span class="n">calccount</span> <span class="o">-=</span> <span class="mi">2</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">candidate</span><span class="p">[</span><span class="s1">&#39;jd&#39;</span><span class="p">]</span> <span class="ow">and</span> <span class="n">candidate</span><span class="p">[</span><span class="s1">&#39;magpsf&#39;</span><span class="p">]</span> <span class="ow">and</span> <span class="n">candidate</span><span class="p">[</span><span class="s1">&#39;fid&#39;</span><span class="p">]</span> <span class="ow">and</span> <span class="n">candidate</span><span class="p">[</span><span class="s1">&#39;isdiffpos&#39;</span><span class="p">]</span> <span class="ow">and</span> <span class="p">(</span><span class="n">candidate</span><span class="p">[</span><span class="s1">&#39;isdiffpos&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;t&#39;</span> <span class="ow">or</span> <span class="n">candidate</span><span class="p">[</span><span class="s1">&#39;isdiffpos&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;1&#39;</span><span class="p">)):</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">candidate</span><span class="p">[</span><span class="s1">&#39;fid&#39;</span><span class="p">]</span> <span class="ow">and</span> <span class="n">candidate</span><span class="p">[</span><span class="s1">&#39;fid&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">fid_now</span><span class="p">):</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">m_now</span> <span class="o">&lt;</span> <span class="mi">99</span> <span class="ow">and</span> <span class="n">candidate</span><span class="p">[</span><span class="s1">&#39;magpsf&#39;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">99</span><span class="p">):</span>
                    <span class="k">if</span> <span class="p">(</span><span class="n">candidate</span><span class="p">[</span><span class="s1">&#39;magpsf&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">m_max</span><span class="p">):</span>
                        <span class="n">m_max</span> <span class="o">=</span> <span class="n">candidate</span><span class="p">[</span><span class="s1">&#39;magpsf&#39;</span><span class="p">]</span>
                        <span class="n">t_max</span> <span class="o">=</span> <span class="n">candidate</span><span class="p">[</span><span class="s1">&#39;jd&#39;</span><span class="p">]</span>
                        <span class="n">calccount</span> <span class="o">-=</span> <span class="mi">3</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="k">if</span> <span class="p">(</span><span class="n">candidate</span><span class="p">[</span><span class="s1">&#39;magpsf&#39;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">m_min</span><span class="p">):</span>
                            <span class="n">m_min</span> <span class="o">=</span> <span class="n">candidate</span><span class="p">[</span><span class="s1">&#39;magpsf&#39;</span><span class="p">]</span>
                            <span class="n">t_min</span> <span class="o">=</span> <span class="n">candidate</span><span class="p">[</span><span class="s1">&#39;jd&#39;</span><span class="p">]</span>
                            <span class="n">calccount</span> <span class="o">-=</span> <span class="mi">3</span>
                        <span class="n">calccount</span> <span class="o">-=</span> <span class="mi">2</span>
                    <span class="n">calccount</span> <span class="o">-=</span> <span class="mi">3</span>
                <span class="n">calccount</span> <span class="o">-=</span> <span class="mi">2</span>
            <span class="n">calccount</span> <span class="o">-=</span> <span class="mi">2</span>
        <span class="k">if</span> <span class="n">calccount</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">break</span>
    <span class="n">tdiff</span> <span class="o">=</span> <span class="n">t_max</span> <span class="o">-</span> <span class="n">t_min</span>
    <span class="n">magdiff</span> <span class="o">=</span> <span class="n">m_min</span> <span class="o">-</span> <span class="n">m_max</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">tdiff</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">):</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">tdiff</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">):</span>
            <span class="n">riserate</span> <span class="o">=</span> <span class="n">magdiff</span> <span class="o">/</span> <span class="n">tdiff</span>
            <span class="n">calccount</span> <span class="o">-=</span> <span class="mi">2</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">decayrate</span> <span class="o">=</span> <span class="p">(</span><span class="o">-</span><span class="n">magdiff</span><span class="p">)</span> <span class="o">/</span> <span class="n">tdiff</span>
            <span class="n">calccount</span> <span class="o">-=</span> <span class="mi">2</span>
        <span class="n">calccount</span> <span class="o">-=</span> <span class="mi">3</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">ssdistnr</span> <span class="o">&lt;</span> <span class="mi">2</span> <span class="ow">and</span> <span class="n">ssdistnr</span> <span class="o">&gt;</span> <span class="p">(</span><span class="o">-</span><span class="mf">0.5</span><span class="p">)):</span>
        <span class="n">mover</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="n">calccount</span> <span class="o">-=</span> <span class="mi">2</span>
    <span class="n">hostgr</span> <span class="o">=</span> <span class="n">sgmag</span> <span class="o">-</span> <span class="n">srmag</span>
    <span class="n">hostri</span> <span class="o">=</span> <span class="n">srmag</span> <span class="o">-</span> <span class="n">simag</span>
    <span class="n">annotations</span><span class="p">[</span><span class="s1">&#39;FWHM&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">fwhm</span>
    <span class="n">annotations</span><span class="p">[</span><span class="s1">&#39;host g-r&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">hostgr</span>
    <span class="n">annotations</span><span class="p">[</span><span class="s1">&#39;host r-i&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">hostri</span>
    <span class="n">annotations</span><span class="p">[</span><span class="s1">&#39;mag at max&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">m_max</span>
    <span class="n">annotations</span><span class="p">[</span><span class="s1">&#39;time at max&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">t_max</span>
    <span class="n">annotations</span><span class="p">[</span><span class="s1">&#39;min-mag&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">m_min</span>
    <span class="n">annotations</span><span class="p">[</span><span class="s1">&#39;min-time&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">t_min</span>
    <span class="n">annotations</span><span class="p">[</span><span class="s1">&#39;time difference&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">tdiff</span>
    <span class="n">annotations</span><span class="p">[</span><span class="s1">&#39;mag diff&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">magdiff</span>
    <span class="n">annotations</span><span class="p">[</span><span class="s1">&#39;rise rate&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">riserate</span>
    <span class="n">annotations</span><span class="p">[</span><span class="s1">&#39;decay rate&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">decayrate</span>
    <span class="n">annotations</span><span class="p">[</span><span class="s1">&#39;host ZTF ref PSF r-mag&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">magnr</span>
    <span class="n">annotations</span><span class="p">[</span><span class="s1">&#39;PS1 psf r-mag&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">srmag</span>
    <span class="n">annotations</span><span class="p">[</span><span class="s1">&#39;rb score&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">rbscore</span>
    <span class="n">annotations</span><span class="p">[</span><span class="s1">&#39;sgscore1&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">sgscore</span>
    <span class="n">annotations</span><span class="p">[</span><span class="s1">&#39;ZOGI scorr&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">scorr</span>
    <span class="n">annotations</span><span class="p">[</span><span class="s1">&#39;distpsnr1&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">distpsnr1</span>
    <span class="n">annotations</span><span class="p">[</span><span class="s1">&#39;distpsnr2&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">distpsnr2</span>
    <span class="n">annotations</span><span class="p">[</span><span class="s1">&#39;distpsnr3&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">distpsnr3</span>
    <span class="n">annotations</span><span class="p">[</span><span class="s1">&#39;magpsf&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">m_now</span>
    <span class="n">annotations</span><span class="p">[</span><span class="s1">&#39;elongation&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">elong</span>
    <span class="n">annotations</span><span class="p">[</span><span class="s1">&#39;magap_min_magpsf&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">psfminap</span>
    <span class="n">annotations</span><span class="p">[</span><span class="s1">&#39;gal_lat&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">gal_lat</span>
    <span class="n">annotations</span><span class="p">[</span><span class="s1">&#39;deltajd&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">deltajd</span>
    <span class="n">filteron</span> <span class="o">=</span> <span class="n">bright</span> <span class="ow">and</span> <span class="n">nopointunderneath</span> <span class="ow">and</span> <span class="p">((</span><span class="ow">not</span> <span class="n">mover</span><span class="p">))</span> <span class="ow">and</span> <span class="n">real</span> <span class="ow">and</span> <span class="n">positivesubtraction</span> <span class="ow">and</span> <span class="p">((</span><span class="ow">not</span> <span class="n">brightstar</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">filteron</span><span class="p">,</span> <span class="n">annotations</span>
</pre></div>
</div>
<p>The <code class="docutils literal notranslate"><span class="pre">Fritz</span></code>-implementation that can be loaded into Compass can be found here:</p>
<p><a class="reference download internal" download="" href="_downloads/4fd1b6e21733be8043f24c6d76fc0032/fritz_filter_clu.json"><code class="xref download docutils literal notranslate"><span class="pre">fritz_filter_clu.json</span></code></a></p>
<p>Let us explore it step-by-step and look at the individual user-defined stages, again omitting
the upstream part.</p>
<p>Note: try turning off the first stage of the pipeline that is pre-configured to select alerts by <code class="docutils literal notranslate"><span class="pre">objectId</span></code>
for demo purposes. When working with the 20200706 database, try a different <code class="docutils literal notranslate"><span class="pre">objectId</span></code>, for example <code class="docutils literal notranslate"><span class="pre">ZTF20abjoqjy</span></code>.</p>
<p>The first <a class="reference external" href="https://docs.mongodb.com/manual/reference/operator/aggregation/match/"><code class="docutils literal notranslate"><span class="pre">$match</span></code></a> stage checks whether
the alert has at least one match with the CLU catalog:</p>
<div class="highlight-json notranslate"><div class="highlight"><pre><span></span><span class="p">{</span>
<span class="w">  </span><span class="nt">&quot;$match&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nt">&quot;cross_matches.CLU_20190625.0&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nt">&quot;$exists&quot;</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p>In the following <a class="reference external" href="https://docs.mongodb.com/manual/reference/operator/aggregation/project/"><code class="docutils literal notranslate"><span class="pre">$project</span></code></a>
stage, we define the variables that will be used by the downstream stages.
Note how we are using the <a class="reference external" href="https://docs.mongodb.com/manual/reference/operator/aggregation/subtract/"><code class="docutils literal notranslate"><span class="pre">$subtract</span></code></a>
operator for the <code class="docutils literal notranslate"><span class="pre">deltajd</span></code> and <code class="docutils literal notranslate"><span class="pre">psfminap</span></code> fields.
Also, the <code class="docutils literal notranslate"><span class="pre">candidates_fid</span></code> field concatenates the previous &gt;3sigma detections in the same filter as <code class="docutils literal notranslate"><span class="pre">fid_now</span></code>
with the current photometric point, which we will use below.</p>
<p>For the full list of MongoDB’s aggregation pipeline operators,
see <a class="reference external" href="https://docs.mongodb.com/manual/reference/operator/aggregation/">here</a>.</p>
<div class="highlight-json notranslate"><div class="highlight"><pre><span></span><span class="p">{</span>
<span class="w">  </span><span class="nt">&quot;$project&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nt">&quot;_id&quot;</span><span class="p">:</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span>
<span class="w">    </span><span class="nt">&quot;candid&quot;</span><span class="p">:</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span>
<span class="w">    </span><span class="nt">&quot;objectId&quot;</span><span class="p">:</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span>
<span class="w">    </span><span class="nt">&quot;prv_candidates.jd&quot;</span><span class="p">:</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span>
<span class="w">    </span><span class="nt">&quot;prv_candidates.magpsf&quot;</span><span class="p">:</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span>
<span class="w">    </span><span class="nt">&quot;prv_candidates.fid&quot;</span><span class="p">:</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span>
<span class="w">    </span><span class="nt">&quot;prv_candidates.isdiffpos&quot;</span><span class="p">:</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span>
<span class="w">    </span><span class="nt">&quot;isdiffpos&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;$candidate.isdiffpos&quot;</span><span class="p">,</span>
<span class="w">    </span><span class="nt">&quot;m_now&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;$candidate.magpsf&quot;</span><span class="p">,</span>
<span class="w">    </span><span class="nt">&quot;m_app&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;$candidate.magap&quot;</span><span class="p">,</span>
<span class="w">    </span><span class="nt">&quot;t_now&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;$candidate.jd&quot;</span><span class="p">,</span>
<span class="w">    </span><span class="nt">&quot;fid_now&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;$candidate.fid&quot;</span><span class="p">,</span>
<span class="w">    </span><span class="nt">&quot;sgscore&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;$candidate.sgscore1&quot;</span><span class="p">,</span>
<span class="w">    </span><span class="nt">&quot;sgscore2&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;$candidate.sgscore2&quot;</span><span class="p">,</span>
<span class="w">    </span><span class="nt">&quot;sgscore3&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;$candidate.sgscore3&quot;</span><span class="p">,</span>
<span class="w">    </span><span class="nt">&quot;srmag&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;$candidate.srmag1&quot;</span><span class="p">,</span>
<span class="w">    </span><span class="nt">&quot;srmag2&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;$candidate.srmag2&quot;</span><span class="p">,</span>
<span class="w">    </span><span class="nt">&quot;srmag3&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;$candidate.srmag3&quot;</span><span class="p">,</span>
<span class="w">    </span><span class="nt">&quot;sgmag&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;$candidate.sgmag1&quot;</span><span class="p">,</span>
<span class="w">    </span><span class="nt">&quot;simag&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;$candidate.simag1&quot;</span><span class="p">,</span>
<span class="w">    </span><span class="nt">&quot;rbscore&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;$candidate.rb&quot;</span><span class="p">,</span>
<span class="w">    </span><span class="nt">&quot;drb&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;$candidate.drb&quot;</span><span class="p">,</span>
<span class="w">    </span><span class="nt">&quot;magnr&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;$candidate.magnr&quot;</span><span class="p">,</span>
<span class="w">    </span><span class="nt">&quot;distnr&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;$candidate.distnr&quot;</span><span class="p">,</span>
<span class="w">    </span><span class="nt">&quot;distpsnr1&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;$candidate.distpsnr1&quot;</span><span class="p">,</span>
<span class="w">    </span><span class="nt">&quot;distpsnr2&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;$candidate.distpsnr2&quot;</span><span class="p">,</span>
<span class="w">    </span><span class="nt">&quot;distpsnr3&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;$candidate.distpsnr3&quot;</span><span class="p">,</span>
<span class="w">    </span><span class="nt">&quot;scorr&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;$candidate.scorr&quot;</span><span class="p">,</span>
<span class="w">    </span><span class="nt">&quot;fwhm&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;$candidate.fwhm&quot;</span><span class="p">,</span>
<span class="w">    </span><span class="nt">&quot;elong&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;$candidate.elong&quot;</span><span class="p">,</span>
<span class="w">    </span><span class="nt">&quot;nbad&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;$candidate.nbad&quot;</span><span class="p">,</span>
<span class="w">    </span><span class="nt">&quot;chipsf&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;$candidate.chipsf&quot;</span><span class="p">,</span>
<span class="w">    </span><span class="nt">&quot;gal_lat&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;$coordinates.b&quot;</span><span class="p">,</span>
<span class="w">    </span><span class="nt">&quot;ssdistnr&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;$candidate.ssdistnr&quot;</span><span class="p">,</span>
<span class="w">    </span><span class="nt">&quot;ssmagnr&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;$candidate.ssmagnr&quot;</span><span class="p">,</span>
<span class="w">    </span><span class="nt">&quot;ssnamenr&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;$candidate.ssnamenr&quot;</span><span class="p">,</span>
<span class="w">    </span><span class="nt">&quot;jdstarthist&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;$candidate.jdstarthist&quot;</span><span class="p">,</span>
<span class="w">    </span><span class="nt">&quot;jdendhist&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;$candidate.jdendhist&quot;</span><span class="p">,</span>
<span class="w">    </span><span class="nt">&quot;deltajd&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nt">&quot;$subtract&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[</span>
<span class="w">        </span><span class="s2">&quot;$candidate.jdendhist&quot;</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;$candidate.jdstarthist&quot;</span>
<span class="w">      </span><span class="p">]</span>
<span class="w">    </span><span class="p">},</span>
<span class="w">    </span><span class="nt">&quot;psfminap&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nt">&quot;$subtract&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[</span>
<span class="w">        </span><span class="s2">&quot;$candidate.magpsf&quot;</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;$candidate.magap&quot;</span>
<span class="w">      </span><span class="p">]</span>
<span class="w">    </span><span class="p">},</span>
<span class="w">    </span><span class="nt">&quot;candidates_fid&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nt">&quot;$concatArrays&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[</span>
<span class="w">        </span><span class="p">{</span>
<span class="w">          </span><span class="nt">&quot;$filter&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="nt">&quot;input&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;$prv_candidates&quot;</span><span class="p">,</span>
<span class="w">            </span><span class="nt">&quot;as&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;cand&quot;</span><span class="p">,</span>
<span class="w">            </span><span class="nt">&quot;cond&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">              </span><span class="nt">&quot;$and&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[</span>
<span class="w">                </span><span class="p">{</span>
<span class="w">                  </span><span class="nt">&quot;$eq&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[</span>
<span class="w">                    </span><span class="s2">&quot;$$cand.fid&quot;</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;$candidate.fid&quot;</span>
<span class="w">                  </span><span class="p">]</span>
<span class="w">                </span><span class="p">},</span>
<span class="w">                </span><span class="p">{</span>
<span class="w">                  </span><span class="nt">&quot;$gt&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[</span>
<span class="w">                    </span><span class="s2">&quot;$$cand.magpsf&quot;</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span>
<span class="w">                  </span><span class="p">]</span>
<span class="w">                </span><span class="p">},</span>
<span class="w">                </span><span class="p">{</span>
<span class="w">                  </span><span class="nt">&quot;$lt&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[</span>
<span class="w">                    </span><span class="s2">&quot;$$cand.magpsf&quot;</span><span class="p">,</span><span class="w"> </span><span class="mi">99</span>
<span class="w">                  </span><span class="p">]</span>
<span class="w">                </span><span class="p">}</span>
<span class="w">              </span><span class="p">]</span>
<span class="w">            </span><span class="p">}</span>
<span class="w">          </span><span class="p">}</span>
<span class="w">        </span><span class="p">},</span>
<span class="w">        </span><span class="p">[</span>
<span class="w">          </span><span class="p">{</span>
<span class="w">            </span><span class="nt">&quot;jd&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;$candidate.jd&quot;</span><span class="p">,</span>
<span class="w">            </span><span class="nt">&quot;magpsf&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;$candidate.magpsf&quot;</span>
<span class="w">          </span><span class="p">}</span>
<span class="w">        </span><span class="p">]</span>
<span class="w">      </span><span class="p">]</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p>In the next stage, we define several boolean fields
(<code class="docutils literal notranslate"><span class="pre">bright</span></code>, <code class="docutils literal notranslate"><span class="pre">positivesubtraction</span></code>, <code class="docutils literal notranslate"><span class="pre">real</span></code>, <code class="docutils literal notranslate"><span class="pre">nopointunderneath</span></code>, <code class="docutils literal notranslate"><span class="pre">brightstar</span></code>, <code class="docutils literal notranslate"><span class="pre">variablesource</span></code>, <code class="docutils literal notranslate"><span class="pre">rock</span></code>, <code class="docutils literal notranslate"><span class="pre">stationary</span></code>),
pass several of the fields defined above (such as, e.g., <code class="docutils literal notranslate"><span class="pre">m_now</span></code>), and save indexes of the
maximum and minimum magnitudes in the <code class="docutils literal notranslate"><span class="pre">candidates_fid</span></code> array, which we will use in the next stage.</p>
<div class="highlight-json notranslate"><div class="highlight"><pre><span></span><span class="p">{</span>
<span class="w">  </span><span class="nt">&quot;$project&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nt">&quot;t_now&quot;</span><span class="p">:</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span>
<span class="w">    </span><span class="nt">&quot;m_now&quot;</span><span class="p">:</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span>
<span class="w">    </span><span class="nt">&quot;fid_now&quot;</span><span class="p">:</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span>
<span class="w">    </span><span class="nt">&quot;sgscore&quot;</span><span class="p">:</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span>
<span class="w">    </span><span class="nt">&quot;drbscore&quot;</span><span class="p">:</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span>
<span class="w">    </span><span class="nt">&quot;magnr&quot;</span><span class="p">:</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span>
<span class="w">    </span><span class="nt">&quot;distnr&quot;</span><span class="p">:</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span>
<span class="w">    </span><span class="nt">&quot;scorr&quot;</span><span class="p">:</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span>
<span class="w">    </span><span class="nt">&quot;ssdistnr&quot;</span><span class="p">:</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span>
<span class="w">    </span><span class="nt">&quot;ssnamenr&quot;</span><span class="p">:</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span>
<span class="w">    </span><span class="nt">&quot;rbscore&quot;</span><span class="p">:</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span>
<span class="w">    </span><span class="nt">&quot;drb&quot;</span><span class="p">:</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span>
<span class="w">    </span><span class="nt">&quot;sgmag&quot;</span><span class="p">:</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span>
<span class="w">    </span><span class="nt">&quot;srmag&quot;</span><span class="p">:</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span>
<span class="w">    </span><span class="nt">&quot;simag&quot;</span><span class="p">:</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span>
<span class="w">    </span><span class="nt">&quot;distpsnr1&quot;</span><span class="p">:</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span>
<span class="w">    </span><span class="nt">&quot;distpsnr2&quot;</span><span class="p">:</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span>
<span class="w">    </span><span class="nt">&quot;distpsnr3&quot;</span><span class="p">:</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span>
<span class="w">    </span><span class="nt">&quot;fwhm&quot;</span><span class="p">:</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span>
<span class="w">    </span><span class="nt">&quot;elong&quot;</span><span class="p">:</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span>
<span class="w">    </span><span class="nt">&quot;gal_lat&quot;</span><span class="p">:</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span>
<span class="w">    </span><span class="nt">&quot;jdstarthist&quot;</span><span class="p">:</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span>
<span class="w">    </span><span class="nt">&quot;jdendhist&quot;</span><span class="p">:</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span>
<span class="w">    </span><span class="nt">&quot;psfminap&quot;</span><span class="p">:</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span>
<span class="w">    </span><span class="nt">&quot;candidates_fid&quot;</span><span class="p">:</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span>
<span class="w">    </span><span class="nt">&quot;m_max_index&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nt">&quot;$indexOfArray&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[</span>
<span class="w">        </span><span class="s2">&quot;$candidates_fid.magpsf&quot;</span><span class="p">,</span><span class="w"> </span><span class="p">{</span>
<span class="w">          </span><span class="nt">&quot;$max&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[</span>
<span class="w">            </span><span class="s2">&quot;$candidates_fid.magpsf&quot;</span>
<span class="w">          </span><span class="p">]</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">      </span><span class="p">]</span>
<span class="w">    </span><span class="p">},</span>
<span class="w">    </span><span class="nt">&quot;m_min_index&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nt">&quot;$indexOfArray&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[</span>
<span class="w">        </span><span class="s2">&quot;$candidates_fid.magpsf&quot;</span><span class="p">,</span><span class="w"> </span><span class="p">{</span>
<span class="w">          </span><span class="nt">&quot;$min&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[</span>
<span class="w">            </span><span class="s2">&quot;$candidates_fid.magpsf&quot;</span>
<span class="w">          </span><span class="p">]</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">      </span><span class="p">]</span>
<span class="w">    </span><span class="p">},</span>
<span class="w">    </span><span class="nt">&quot;bright&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nt">&quot;$lt&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[</span>
<span class="w">        </span><span class="s2">&quot;$m_now&quot;</span><span class="p">,</span><span class="w"> </span><span class="mf">99.0</span>
<span class="w">      </span><span class="p">]</span>
<span class="w">    </span><span class="p">},</span>
<span class="w">    </span><span class="nt">&quot;positivesubtraction&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nt">&quot;$in&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[</span>
<span class="w">        </span><span class="s2">&quot;$isdiffpos&quot;</span><span class="p">,</span>
<span class="w">        </span><span class="p">[</span>
<span class="w">          </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;1&quot;</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;t&quot;</span><span class="p">,</span><span class="w"> </span><span class="kc">true</span>
<span class="w">        </span><span class="p">]</span>
<span class="w">      </span><span class="p">]</span>
<span class="w">    </span><span class="p">},</span>
<span class="w">    </span><span class="nt">&quot;real&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nt">&quot;$and&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[</span>
<span class="w">        </span><span class="p">{</span>
<span class="w">          </span><span class="nt">&quot;$gt&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[</span>
<span class="w">            </span><span class="s2">&quot;$rbscore&quot;</span><span class="p">,</span><span class="w"> </span><span class="mf">0.3</span>
<span class="w">          </span><span class="p">]</span>
<span class="w">        </span><span class="p">},</span><span class="w"> </span><span class="p">{</span>
<span class="w">          </span><span class="nt">&quot;$gt&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[</span>
<span class="w">            </span><span class="s2">&quot;$drb&quot;</span><span class="p">,</span><span class="w"> </span><span class="mf">0.5</span>
<span class="w">          </span><span class="p">]</span>
<span class="w">        </span><span class="p">},</span><span class="w"> </span><span class="p">{</span>
<span class="w">          </span><span class="nt">&quot;$gt&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[</span>
<span class="w">            </span><span class="s2">&quot;$fwhm&quot;</span><span class="p">,</span><span class="w"> </span><span class="mf">0.5</span>
<span class="w">          </span><span class="p">]</span>
<span class="w">        </span><span class="p">},</span><span class="w"> </span><span class="p">{</span>
<span class="w">          </span><span class="nt">&quot;$lt&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[</span>
<span class="w">            </span><span class="s2">&quot;$fwhm&quot;</span><span class="p">,</span><span class="w"> </span><span class="mi">8</span>
<span class="w">          </span><span class="p">]</span>
<span class="w">        </span><span class="p">},</span><span class="w"> </span><span class="p">{</span>
<span class="w">          </span><span class="nt">&quot;$lt&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[</span>
<span class="w">            </span><span class="s2">&quot;$nbad&quot;</span><span class="p">,</span><span class="w"> </span><span class="mi">5</span>
<span class="w">          </span><span class="p">]</span>
<span class="w">        </span><span class="p">},</span><span class="w"> </span><span class="p">{</span>
<span class="w">          </span><span class="nt">&quot;$lt&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[</span>
<span class="w">            </span><span class="p">{</span>
<span class="w">              </span><span class="nt">&quot;$abs&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;$psfminap&quot;</span>
<span class="w">            </span><span class="p">},</span><span class="w"> </span><span class="mf">0.75</span>
<span class="w">          </span><span class="p">]</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">      </span><span class="p">]</span>
<span class="w">    </span><span class="p">},</span>
<span class="w">    </span><span class="nt">&quot;nopointunderneath&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nt">&quot;$not&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[</span>
<span class="w">        </span><span class="p">{</span>
<span class="w">          </span><span class="nt">&quot;$and&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[</span>
<span class="w">            </span><span class="p">{</span>
<span class="w">              </span><span class="nt">&quot;$gt&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[</span>
<span class="w">                </span><span class="s2">&quot;$sgscore&quot;</span><span class="p">,</span><span class="w"> </span><span class="mf">0.76</span>
<span class="w">              </span><span class="p">]</span>
<span class="w">            </span><span class="p">},</span><span class="w"> </span><span class="p">{</span>
<span class="w">              </span><span class="nt">&quot;$lt&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[</span>
<span class="w">                </span><span class="s2">&quot;$distpsnr1&quot;</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span>
<span class="w">              </span><span class="p">]</span>
<span class="w">            </span><span class="p">}</span>
<span class="w">          </span><span class="p">]</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">      </span><span class="p">]</span>
<span class="w">    </span><span class="p">},</span>
<span class="w">    </span><span class="nt">&quot;brightstar&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nt">&quot;$or&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[</span>
<span class="w">        </span><span class="p">{</span>
<span class="w">          </span><span class="nt">&quot;$and&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[</span>
<span class="w">            </span><span class="p">{</span>
<span class="w">              </span><span class="nt">&quot;$lt&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[</span>
<span class="w">                </span><span class="s2">&quot;$distpsnr1&quot;</span><span class="p">,</span><span class="w"> </span><span class="mi">20</span>
<span class="w">              </span><span class="p">]</span>
<span class="w">            </span><span class="p">},</span><span class="w"> </span><span class="p">{</span>
<span class="w">              </span><span class="nt">&quot;$lt&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[</span>
<span class="w">                </span><span class="s2">&quot;$srmag&quot;</span><span class="p">,</span><span class="w"> </span><span class="mi">15</span>
<span class="w">              </span><span class="p">]</span>
<span class="w">            </span><span class="p">},</span><span class="w"> </span><span class="p">{</span>
<span class="w">              </span><span class="nt">&quot;$gt&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[</span>
<span class="w">                </span><span class="s2">&quot;$srmag&quot;</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span>
<span class="w">              </span><span class="p">]</span>
<span class="w">            </span><span class="p">},</span><span class="w"> </span><span class="p">{</span>
<span class="w">              </span><span class="nt">&quot;$gt&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[</span>
<span class="w">                </span><span class="s2">&quot;$sgscore&quot;</span><span class="p">,</span><span class="w"> </span><span class="mf">0.49</span>
<span class="w">              </span><span class="p">]</span>
<span class="w">            </span><span class="p">}</span>
<span class="w">          </span><span class="p">]</span>
<span class="w">        </span><span class="p">},</span><span class="w"> </span><span class="p">{</span>
<span class="w">          </span><span class="nt">&quot;$and&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[</span>
<span class="w">            </span><span class="p">{</span>
<span class="w">              </span><span class="nt">&quot;$lt&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[</span>
<span class="w">                </span><span class="s2">&quot;$distpsnr2&quot;</span><span class="p">,</span><span class="w"> </span><span class="mi">20</span>
<span class="w">              </span><span class="p">]</span>
<span class="w">            </span><span class="p">},</span><span class="w"> </span><span class="p">{</span>
<span class="w">              </span><span class="nt">&quot;$lt&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[</span>
<span class="w">                </span><span class="s2">&quot;$srmag2&quot;</span><span class="p">,</span><span class="w"> </span><span class="mi">15</span>
<span class="w">              </span><span class="p">]</span>
<span class="w">            </span><span class="p">},</span><span class="w"> </span><span class="p">{</span>
<span class="w">              </span><span class="nt">&quot;$gt&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[</span>
<span class="w">                </span><span class="s2">&quot;$srmag2&quot;</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span>
<span class="w">              </span><span class="p">]</span>
<span class="w">            </span><span class="p">},</span><span class="w"> </span><span class="p">{</span>
<span class="w">              </span><span class="nt">&quot;$gt&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[</span>
<span class="w">                </span><span class="s2">&quot;$sgscore2&quot;</span><span class="p">,</span><span class="w"> </span><span class="mf">0.49</span>
<span class="w">              </span><span class="p">]</span>
<span class="w">            </span><span class="p">}</span>
<span class="w">          </span><span class="p">]</span>
<span class="w">        </span><span class="p">},</span><span class="w"> </span><span class="p">{</span>
<span class="w">          </span><span class="nt">&quot;$and&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[</span>
<span class="w">            </span><span class="p">{</span>
<span class="w">              </span><span class="nt">&quot;$lt&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[</span>
<span class="w">                </span><span class="s2">&quot;$distpsnr3&quot;</span><span class="p">,</span><span class="w"> </span><span class="mi">20</span>
<span class="w">              </span><span class="p">]</span>
<span class="w">            </span><span class="p">},</span><span class="w"> </span><span class="p">{</span>
<span class="w">              </span><span class="nt">&quot;$lt&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[</span>
<span class="w">                </span><span class="s2">&quot;$srmag3&quot;</span><span class="p">,</span><span class="w"> </span><span class="mi">15</span>
<span class="w">              </span><span class="p">]</span>
<span class="w">            </span><span class="p">},</span><span class="w"> </span><span class="p">{</span>
<span class="w">              </span><span class="nt">&quot;$gt&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[</span>
<span class="w">                </span><span class="s2">&quot;$srmag3&quot;</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span>
<span class="w">              </span><span class="p">]</span>
<span class="w">            </span><span class="p">},</span><span class="w"> </span><span class="p">{</span>
<span class="w">              </span><span class="nt">&quot;$gt&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[</span>
<span class="w">                </span><span class="s2">&quot;$sgscore3&quot;</span><span class="p">,</span><span class="w"> </span><span class="mf">0.49</span>
<span class="w">              </span><span class="p">]</span>
<span class="w">            </span><span class="p">}</span>
<span class="w">          </span><span class="p">]</span>
<span class="w">        </span><span class="p">},</span><span class="w"> </span><span class="p">{</span>
<span class="w">          </span><span class="nt">&quot;$and&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[</span>
<span class="w">            </span><span class="p">{</span>
<span class="w">              </span><span class="nt">&quot;$eq&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[</span>
<span class="w">                </span><span class="s2">&quot;$sgscore&quot;</span><span class="p">,</span><span class="w"> </span><span class="mf">0.5</span>
<span class="w">              </span><span class="p">]</span>
<span class="w">            </span><span class="p">},</span><span class="w"> </span><span class="p">{</span>
<span class="w">              </span><span class="nt">&quot;$lt&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[</span>
<span class="w">                </span><span class="s2">&quot;$distpsnr1&quot;</span><span class="p">,</span><span class="w"> </span><span class="mf">0.5</span>
<span class="w">              </span><span class="p">]</span>
<span class="w">            </span><span class="p">},</span><span class="w"> </span><span class="p">{</span>
<span class="w">              </span><span class="nt">&quot;$or&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[</span>
<span class="w">                </span><span class="p">{</span>
<span class="w">                  </span><span class="nt">&quot;$lt&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[</span>
<span class="w">                    </span><span class="s2">&quot;$sgmag&quot;</span><span class="p">,</span><span class="w"> </span><span class="mi">17</span>
<span class="w">                  </span><span class="p">]</span>
<span class="w">                </span><span class="p">},</span><span class="w"> </span><span class="p">{</span>
<span class="w">                  </span><span class="nt">&quot;$lt&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[</span>
<span class="w">                    </span><span class="s2">&quot;$srmag&quot;</span><span class="p">,</span><span class="w"> </span><span class="mi">17</span>
<span class="w">                  </span><span class="p">]</span>
<span class="w">                </span><span class="p">},</span><span class="w"> </span><span class="p">{</span>
<span class="w">                  </span><span class="nt">&quot;$lt&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[</span>
<span class="w">                    </span><span class="s2">&quot;$simag&quot;</span><span class="p">,</span><span class="w"> </span><span class="mi">17</span>
<span class="w">                  </span><span class="p">]</span>
<span class="w">                </span><span class="p">}</span>
<span class="w">              </span><span class="p">]</span>
<span class="w">            </span><span class="p">}</span>
<span class="w">          </span><span class="p">]</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">      </span><span class="p">]</span>
<span class="w">    </span><span class="p">},</span>
<span class="w">    </span><span class="nt">&quot;variablesource&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nt">&quot;$or&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[</span>
<span class="w">        </span><span class="p">{</span>
<span class="w">          </span><span class="nt">&quot;$and&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[</span>
<span class="w">            </span><span class="p">{</span>
<span class="w">              </span><span class="nt">&quot;$lt&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[</span>
<span class="w">                </span><span class="s2">&quot;$distnr&quot;</span><span class="p">,</span><span class="w"> </span><span class="mf">0.4</span>
<span class="w">              </span><span class="p">]</span>
<span class="w">            </span><span class="p">},</span><span class="w"> </span><span class="p">{</span>
<span class="w">              </span><span class="nt">&quot;$lt&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[</span>
<span class="w">                </span><span class="s2">&quot;$magnr&quot;</span><span class="p">,</span><span class="w"> </span><span class="mi">19</span>
<span class="w">              </span><span class="p">]</span>
<span class="w">            </span><span class="p">},</span><span class="w"> </span><span class="p">{</span>
<span class="w">              </span><span class="nt">&quot;$gt&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[</span>
<span class="w">                </span><span class="s2">&quot;$age&quot;</span><span class="p">,</span><span class="w"> </span><span class="mi">90</span>
<span class="w">              </span><span class="p">]</span>
<span class="w">            </span><span class="p">}</span>
<span class="w">          </span><span class="p">]</span>
<span class="w">        </span><span class="p">},</span><span class="w"> </span><span class="p">{</span>
<span class="w">          </span><span class="nt">&quot;$and&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[</span>
<span class="w">            </span><span class="p">{</span>
<span class="w">              </span><span class="nt">&quot;$lt&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[</span>
<span class="w">                </span><span class="s2">&quot;$distnr&quot;</span><span class="p">,</span><span class="w"> </span><span class="mf">0.8</span>
<span class="w">              </span><span class="p">]</span>
<span class="w">            </span><span class="p">},</span><span class="w"> </span><span class="p">{</span>
<span class="w">              </span><span class="nt">&quot;$lt&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[</span>
<span class="w">                </span><span class="s2">&quot;$magnr&quot;</span><span class="p">,</span><span class="w"> </span><span class="mi">17</span>
<span class="w">              </span><span class="p">]</span>
<span class="w">            </span><span class="p">},</span><span class="w"> </span><span class="p">{</span>
<span class="w">              </span><span class="nt">&quot;$gt&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[</span>
<span class="w">                </span><span class="s2">&quot;$age&quot;</span><span class="p">,</span><span class="w"> </span><span class="mi">90</span>
<span class="w">              </span><span class="p">]</span>
<span class="w">            </span><span class="p">}</span>
<span class="w">          </span><span class="p">]</span>
<span class="w">        </span><span class="p">},</span><span class="w"> </span><span class="p">{</span>
<span class="w">          </span><span class="nt">&quot;$and&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[</span>
<span class="w">            </span><span class="p">{</span>
<span class="w">              </span><span class="nt">&quot;$lt&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[</span>
<span class="w">                </span><span class="s2">&quot;$distnr&quot;</span><span class="p">,</span><span class="w"> </span><span class="mf">1.2</span>
<span class="w">              </span><span class="p">]</span>
<span class="w">            </span><span class="p">},</span><span class="w"> </span><span class="p">{</span>
<span class="w">              </span><span class="nt">&quot;$lt&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[</span>
<span class="w">                </span><span class="s2">&quot;$magnr&quot;</span><span class="p">,</span><span class="w"> </span><span class="mi">15</span>
<span class="w">              </span><span class="p">]</span>
<span class="w">            </span><span class="p">},</span><span class="w"> </span><span class="p">{</span>
<span class="w">              </span><span class="nt">&quot;$gt&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[</span>
<span class="w">                </span><span class="s2">&quot;$age&quot;</span><span class="p">,</span><span class="w"> </span><span class="mi">90</span>
<span class="w">              </span><span class="p">]</span>
<span class="w">            </span><span class="p">}</span>
<span class="w">          </span><span class="p">]</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">      </span><span class="p">]</span>
<span class="w">    </span><span class="p">},</span>
<span class="w">    </span><span class="nt">&quot;rock&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nt">&quot;$and&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[</span>
<span class="w">        </span><span class="p">{</span>
<span class="w">          </span><span class="nt">&quot;$gte&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[</span>
<span class="w">            </span><span class="s2">&quot;$ssdistnr&quot;</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span>
<span class="w">          </span><span class="p">]</span>
<span class="w">        </span><span class="p">},</span><span class="w"> </span><span class="p">{</span>
<span class="w">          </span><span class="nt">&quot;$lt&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[</span>
<span class="w">            </span><span class="s2">&quot;$ssdistnr&quot;</span><span class="p">,</span><span class="w"> </span><span class="mi">12</span>
<span class="w">          </span><span class="p">]</span>
<span class="w">        </span><span class="p">},</span><span class="w"> </span><span class="p">{</span>
<span class="w">          </span><span class="nt">&quot;$lt&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[</span>
<span class="w">            </span><span class="p">{</span>
<span class="w">              </span><span class="nt">&quot;$abs&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;$ssmagnr&quot;</span>
<span class="w">            </span><span class="p">},</span><span class="w"> </span><span class="mi">20</span>
<span class="w">          </span><span class="p">]</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">      </span><span class="p">]</span>
<span class="w">    </span><span class="p">},</span>
<span class="w">    </span><span class="nt">&quot;stationary&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nt">&quot;$anyElementTrue&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nt">&quot;$map&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">          </span><span class="nt">&quot;input&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;$prv_candidates&quot;</span><span class="p">,</span>
<span class="w">          </span><span class="nt">&quot;as&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;cand&quot;</span><span class="p">,</span>
<span class="w">          </span><span class="nt">&quot;in&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="nt">&quot;$and&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[</span>
<span class="w">              </span><span class="p">{</span>
<span class="w">                </span><span class="nt">&quot;$gt&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[</span>
<span class="w">                  </span><span class="p">{</span>
<span class="w">                    </span><span class="nt">&quot;$abs&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">                      </span><span class="nt">&quot;$subtract&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[</span>
<span class="w">                        </span><span class="s2">&quot;$t_now&quot;</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;$$cand.jd&quot;</span>
<span class="w">                      </span><span class="p">]</span>
<span class="w">                    </span><span class="p">}</span>
<span class="w">                  </span><span class="p">},</span><span class="w"> </span><span class="mf">0.02</span>
<span class="w">                </span><span class="p">]</span>
<span class="w">              </span><span class="p">},</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="nt">&quot;$lt&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[</span>
<span class="w">                  </span><span class="s2">&quot;$$cand.magpsf&quot;</span><span class="p">,</span><span class="w"> </span><span class="mi">99</span>
<span class="w">                </span><span class="p">]</span>
<span class="w">              </span><span class="p">},</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="nt">&quot;$in&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[</span>
<span class="w">                  </span><span class="s2">&quot;$$cand.isdiffpos&quot;</span><span class="p">,</span><span class="w"> </span><span class="p">[</span>
<span class="w">                    </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;1&quot;</span><span class="p">,</span><span class="w"> </span><span class="kc">true</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;t&quot;</span>
<span class="w">                  </span><span class="p">]</span>
<span class="w">                </span><span class="p">]</span>
<span class="w">              </span><span class="p">},</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="nt">&quot;$or&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[</span>
<span class="w">                  </span><span class="p">{</span>
<span class="w">                    </span><span class="nt">&quot;$lt&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[</span>
<span class="w">                      </span><span class="s2">&quot;$ssdistnr&quot;</span><span class="p">,</span><span class="w"> </span><span class="mf">-0.5</span>
<span class="w">                    </span><span class="p">]</span>
<span class="w">                  </span><span class="p">},</span><span class="w"> </span><span class="p">{</span>
<span class="w">                    </span><span class="nt">&quot;$gt&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[</span>
<span class="w">                      </span><span class="s2">&quot;$ssdistnr&quot;</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span>
<span class="w">                    </span><span class="p">]</span>
<span class="w">                  </span><span class="p">}</span>
<span class="w">                </span><span class="p">]</span>
<span class="w">              </span><span class="p">}</span>
<span class="w">            </span><span class="p">]</span>
<span class="w">          </span><span class="p">}</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">      </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p>Let us take a closer look at a few of the fields defined above:</p>
<ol class="arabic simple">
<li><p>In the definition of <code class="docutils literal notranslate"><span class="pre">m_max_index</span></code>,
the <a class="reference external" href="https://docs.mongodb.com/manual/reference/operator/aggregation/indexOfArray/"><code class="docutils literal notranslate"><span class="pre">$indexOfArray</span></code></a>
operator returns the index of the maximum value of the <code class="docutils literal notranslate"><span class="pre">magpsf</span></code> field in the detection history:</p></li>
</ol>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">$candidates_fid.magpsf</span></code> returns an array containing the filtered <code class="docutils literal notranslate"><span class="pre">magpsf</span></code>s</p></li>
<li><p>the <a class="reference external" href="https://docs.mongodb.com/manual/reference/operator/aggregation/max/"><code class="docutils literal notranslate"><span class="pre">$max</span></code></a> operator takes the maximum of that
array</p></li>
</ul>
<ol class="arabic simple" start="2">
<li><p>In the definition of <code class="docutils literal notranslate"><span class="pre">stationary</span></code>, we evaluate a boolean statement (expressed using the<code class="docutils literal notranslate"><span class="pre">$and</span></code> operator)
on each entry in the full detection history stored in the <code class="docutils literal notranslate"><span class="pre">prv_candidates</span></code> array using the
<a class="reference external" href="https://docs.mongodb.com/manual/reference/operator/aggregation/map/"><code class="docutils literal notranslate"><span class="pre">$map</span></code></a> operator.</p></li>
</ol>
<p>In the following <code class="docutils literal notranslate"><span class="pre">$project</span></code> stage, we compute the maximum and minimum magnitudes
for the source and the corresponding time stamps using the <code class="docutils literal notranslate"><span class="pre">m_max_index</span></code> and <code class="docutils literal notranslate"><span class="pre">m_min_index</span></code> values computed above:</p>
<div class="highlight-json notranslate"><div class="highlight"><pre><span></span><span class="p">{</span>
<span class="w">  </span><span class="nt">&quot;$project&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nt">&quot;m_max&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nt">&quot;$arrayElemAt&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[</span>
<span class="w">        </span><span class="s2">&quot;$candidates_fid.magpsf&quot;</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;$m_max_index&quot;</span>
<span class="w">      </span><span class="p">]</span>
<span class="w">    </span><span class="p">},</span>
<span class="w">    </span><span class="nt">&quot;m_min&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nt">&quot;$arrayElemAt&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[</span>
<span class="w">        </span><span class="s2">&quot;$candidates_fid.magpsf&quot;</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;$m_min_index&quot;</span>
<span class="w">      </span><span class="p">]</span>
<span class="w">    </span><span class="p">},</span>
<span class="w">    </span><span class="nt">&quot;t_max&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nt">&quot;$arrayElemAt&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[</span>
<span class="w">        </span><span class="s2">&quot;$candidates_fid.jd&quot;</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;$m_max_index&quot;</span>
<span class="w">      </span><span class="p">]</span>
<span class="w">    </span><span class="p">},</span>
<span class="w">    </span><span class="nt">&quot;t_min&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nt">&quot;$arrayElemAt&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[</span>
<span class="w">        </span><span class="s2">&quot;$candidates_fid.jd&quot;</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;$m_min_index&quot;</span>
<span class="w">      </span><span class="p">]</span>
<span class="w">    </span><span class="p">},</span>
<span class="w">    </span><span class="nt">&quot;t_now&quot;</span><span class="p">:</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span>
<span class="w">    </span><span class="nt">&quot;m_now&quot;</span><span class="p">:</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span>
<span class="w">    </span><span class="nt">&quot;fid_now&quot;</span><span class="p">:</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span>
<span class="w">    </span><span class="nt">&quot;sgscore&quot;</span><span class="p">:</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span>
<span class="w">    </span><span class="nt">&quot;drbscore&quot;</span><span class="p">:</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span>
<span class="w">    </span><span class="nt">&quot;magnr&quot;</span><span class="p">:</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span>
<span class="w">    </span><span class="nt">&quot;distnr&quot;</span><span class="p">:</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span>
<span class="w">    </span><span class="nt">&quot;scorr&quot;</span><span class="p">:</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span>
<span class="w">    </span><span class="nt">&quot;gal_lat&quot;</span><span class="p">:</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span>
<span class="w">    </span><span class="nt">&quot;ssdistnr&quot;</span><span class="p">:</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span>
<span class="w">    </span><span class="nt">&quot;ssnamenr&quot;</span><span class="p">:</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span>
<span class="w">    </span><span class="nt">&quot;rbscore&quot;</span><span class="p">:</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span>
<span class="w">    </span><span class="nt">&quot;drb&quot;</span><span class="p">:</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span>
<span class="w">    </span><span class="nt">&quot;sgmag&quot;</span><span class="p">:</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span>
<span class="w">    </span><span class="nt">&quot;srmag&quot;</span><span class="p">:</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span>
<span class="w">    </span><span class="nt">&quot;simag&quot;</span><span class="p">:</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span>
<span class="w">    </span><span class="nt">&quot;distpsnr1&quot;</span><span class="p">:</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span>
<span class="w">    </span><span class="nt">&quot;distpsnr2&quot;</span><span class="p">:</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span>
<span class="w">    </span><span class="nt">&quot;distpsnr3&quot;</span><span class="p">:</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span>
<span class="w">    </span><span class="nt">&quot;fwhm&quot;</span><span class="p">:</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span>
<span class="w">    </span><span class="nt">&quot;elong&quot;</span><span class="p">:</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span>
<span class="w">    </span><span class="nt">&quot;jdstarthist&quot;</span><span class="p">:</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span>
<span class="w">    </span><span class="nt">&quot;jdendhist&quot;</span><span class="p">:</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span>
<span class="w">    </span><span class="nt">&quot;psfminap&quot;</span><span class="p">:</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span>
<span class="w">    </span><span class="nt">&quot;bright&quot;</span><span class="p">:</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span>
<span class="w">    </span><span class="nt">&quot;positivesubtraction&quot;</span><span class="p">:</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span>
<span class="w">    </span><span class="nt">&quot;real&quot;</span><span class="p">:</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span>
<span class="w">    </span><span class="nt">&quot;nopointunderneath&quot;</span><span class="p">:</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span>
<span class="w">    </span><span class="nt">&quot;brightstar&quot;</span><span class="p">:</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span>
<span class="w">    </span><span class="nt">&quot;variablesource&quot;</span><span class="p">:</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span>
<span class="w">    </span><span class="nt">&quot;rock&quot;</span><span class="p">:</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span>
<span class="w">    </span><span class="nt">&quot;stationary&quot;</span><span class="p">:</span><span class="w"> </span><span class="mi">1</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p>The alert is selected or rejected by our filter with a
<a class="reference external" href="https://docs.mongodb.com/manual/reference/operator/aggregation/match/"><code class="docutils literal notranslate"><span class="pre">$match</span></code></a>
stage based on the values of the boolean fields defined above:</p>
<div class="highlight-json notranslate"><div class="highlight"><pre><span></span><span class="p">{</span>
<span class="w">  </span><span class="nt">&quot;$match&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nt">&quot;bright&quot;</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="p">,</span>
<span class="w">    </span><span class="nt">&quot;nopointunderneath&quot;</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="p">,</span>
<span class="w">    </span><span class="nt">&quot;positivesubtraction&quot;</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="p">,</span>
<span class="w">    </span><span class="nt">&quot;real&quot;</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="p">,</span>
<span class="w">    </span><span class="nt">&quot;stationary&quot;</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="p">,</span>
<span class="w">    </span><span class="nt">&quot;brightstar&quot;</span><span class="p">:</span><span class="w"> </span><span class="kc">false</span><span class="p">,</span>
<span class="w">    </span><span class="nt">&quot;rock&quot;</span><span class="p">:</span><span class="w"> </span><span class="kc">false</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p>The final stage adds annotations to a passing alert:</p>
<div class="highlight-json notranslate"><div class="highlight"><pre><span></span><span class="p">{</span>
<span class="w">    </span><span class="nt">&quot;$project&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nt">&quot;annotations.FWHM&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;$fwhm&quot;</span><span class="p">,</span>
<span class="w">      </span><span class="nt">&quot;annotations.drb&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;$drb&quot;</span><span class="p">,</span>
<span class="w">      </span><span class="nt">&quot;annotations.host g-r&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nt">&quot;$subtract&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[</span>
<span class="w">          </span><span class="s2">&quot;$sgmag&quot;</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;$srmag&quot;</span>
<span class="w">        </span><span class="p">]</span>
<span class="w">      </span><span class="p">},</span>
<span class="w">      </span><span class="nt">&quot;annotations.host r-i&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nt">&quot;$subtract&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[</span>
<span class="w">          </span><span class="s2">&quot;$srmag&quot;</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;$simag&quot;</span>
<span class="w">        </span><span class="p">]</span>
<span class="w">      </span><span class="p">},</span>
<span class="w">      </span><span class="nt">&quot;annotations.mag at max&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;$m_max&quot;</span><span class="p">,</span>
<span class="w">      </span><span class="nt">&quot;annotations.time at max&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;$t_max&quot;</span><span class="p">,</span>
<span class="w">      </span><span class="nt">&quot;annotations.min-mag&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;$m_min&quot;</span><span class="p">,</span>
<span class="w">      </span><span class="nt">&quot;annotations.min-time&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;$t_min&quot;</span><span class="p">,</span>
<span class="w">      </span><span class="nt">&quot;annotations.time difference&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nt">&quot;$subtract&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[</span>
<span class="w">          </span><span class="s2">&quot;$t_max&quot;</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;$t_min&quot;</span>
<span class="w">        </span><span class="p">]</span>
<span class="w">      </span><span class="p">},</span>
<span class="w">      </span><span class="nt">&quot;annotations.mag diff&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nt">&quot;$subtract&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[</span>
<span class="w">          </span><span class="s2">&quot;$m_min&quot;</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;$m_max&quot;</span>
<span class="w">        </span><span class="p">]</span>
<span class="w">      </span><span class="p">},</span>
<span class="w">      </span><span class="nt">&quot;annotations.rise rate&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nt">&quot;$cond&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">          </span><span class="nt">&quot;if&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="nt">&quot;$gt&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[</span>
<span class="w">              </span><span class="p">{</span>
<span class="w">                </span><span class="nt">&quot;$subtract&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[</span>
<span class="w">                  </span><span class="s2">&quot;$t_max&quot;</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;$t_min&quot;</span>
<span class="w">                </span><span class="p">]</span>
<span class="w">              </span><span class="p">},</span><span class="w"> </span><span class="mi">0</span>
<span class="w">            </span><span class="p">]</span>
<span class="w">          </span><span class="p">},</span>
<span class="w">          </span><span class="nt">&quot;then&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="nt">&quot;$divide&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[</span>
<span class="w">              </span><span class="p">{</span>
<span class="w">                </span><span class="nt">&quot;$subtract&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[</span>
<span class="w">                  </span><span class="s2">&quot;$m_min&quot;</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;$m_max&quot;</span>
<span class="w">                </span><span class="p">]</span>
<span class="w">              </span><span class="p">},</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="nt">&quot;$subtract&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[</span>
<span class="w">                  </span><span class="s2">&quot;$t_max&quot;</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;$t_min&quot;</span>
<span class="w">                </span><span class="p">]</span>
<span class="w">              </span><span class="p">}</span>
<span class="w">            </span><span class="p">]</span>
<span class="w">          </span><span class="p">},</span>
<span class="w">          </span><span class="nt">&quot;else&quot;</span><span class="p">:</span><span class="w"> </span><span class="kc">null</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">      </span><span class="p">},</span>
<span class="w">      </span><span class="nt">&quot;annotations.decay rate&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nt">&quot;$cond&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">          </span><span class="nt">&quot;if&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="nt">&quot;$lt&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[</span>
<span class="w">              </span><span class="p">{</span>
<span class="w">                </span><span class="nt">&quot;$subtract&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[</span>
<span class="w">                  </span><span class="s2">&quot;$t_max&quot;</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;$t_min&quot;</span>
<span class="w">                </span><span class="p">]</span>
<span class="w">              </span><span class="p">},</span><span class="w"> </span><span class="mi">0</span>
<span class="w">            </span><span class="p">]</span>
<span class="w">          </span><span class="p">},</span>
<span class="w">          </span><span class="nt">&quot;then&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="nt">&quot;$divide&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[</span>
<span class="w">              </span><span class="p">{</span>
<span class="w">                </span><span class="nt">&quot;$subtract&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[</span>
<span class="w">                  </span><span class="s2">&quot;$m_max&quot;</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;$m_min&quot;</span>
<span class="w">                </span><span class="p">]</span>
<span class="w">              </span><span class="p">},</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="nt">&quot;$subtract&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[</span>
<span class="w">                  </span><span class="s2">&quot;$t_max&quot;</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;$t_min&quot;</span>
<span class="w">                </span><span class="p">]</span>
<span class="w">              </span><span class="p">}</span>
<span class="w">            </span><span class="p">]</span>
<span class="w">          </span><span class="p">},</span>
<span class="w">          </span><span class="nt">&quot;else&quot;</span><span class="p">:</span><span class="w"> </span><span class="kc">null</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">      </span><span class="p">},</span>
<span class="w">      </span><span class="nt">&quot;annotations.host ZTF ref PSF r-mag&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;$magnr&quot;</span><span class="p">,</span>
<span class="w">      </span><span class="nt">&quot;annotations.PS1 psf r-mag&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;$srmag&quot;</span><span class="p">,</span>
<span class="w">      </span><span class="nt">&quot;annotations.rb score&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;$rbscore&quot;</span><span class="p">,</span>
<span class="w">      </span><span class="nt">&quot;annotations.sgscore1&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;$sgscore&quot;</span><span class="p">,</span>
<span class="w">      </span><span class="nt">&quot;annotations.ZOGI scorr&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;$scorr&quot;</span><span class="p">,</span>
<span class="w">      </span><span class="nt">&quot;annotations.distpsnr1&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;$distpsnr1&quot;</span><span class="p">,</span>
<span class="w">      </span><span class="nt">&quot;annotations.distpsnr2&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;$distpsnr2&quot;</span><span class="p">,</span>
<span class="w">      </span><span class="nt">&quot;annotations.distpsnr3&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;$distpsnr3&quot;</span><span class="p">,</span>
<span class="w">      </span><span class="nt">&quot;annotations.magpsf&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;$m_now&quot;</span><span class="p">,</span>
<span class="w">      </span><span class="nt">&quot;annotations.elongation&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;$elong&quot;</span><span class="p">,</span>
<span class="w">      </span><span class="nt">&quot;annotations.magap_min_magpsf&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;$psfminap&quot;</span><span class="p">,</span>
<span class="w">      </span><span class="nt">&quot;annotations.gal_lat&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;$gal_lat&quot;</span><span class="p">,</span>
<span class="w">      </span><span class="nt">&quot;annotations.deltajd&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nt">&quot;$subtract&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[</span>
<span class="w">          </span><span class="s2">&quot;$jdendhist&quot;</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;$jdstarthist&quot;</span>
<span class="w">        </span><span class="p">]</span>
<span class="w">      </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">  </span><span class="p">}</span>
</pre></div>
</div>
</section>
<section id="bts-rcf-program-simplified-filter">
<h4>BTS/RCF program (simplified) filter<a class="headerlink" href="#bts-rcf-program-simplified-filter" title="Link to this heading">¶</a></h4>
<p>As another example, below you will find a simplified version of the Bright Transient Survey filter
(the Redshift Completeness Factor program)</p>
<p><a class="reference download internal" download="" href="_downloads/7635b578501ac8a5f11574b26308387e/fritz_filter_rcf_simple.json"><code class="xref download docutils literal notranslate"><span class="pre">fritz_filter_rcf.json</span></code></a></p>
<div class="highlight-js notranslate"><div class="highlight"><pre><span></span><span class="p">[</span>
<span class="w">  </span><span class="cm">/* UPSTREAM STAGES */</span>
<span class="w">  </span><span class="c1">// For this example, select alerts by objectId. In practice, alert is selected by candid</span>
<span class="w">  </span><span class="p">{</span>
<span class="w">    </span><span class="s2">&quot;$match&quot;</span><span class="o">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="s2">&quot;objectId&quot;</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;ZTF20aacbyec&quot;</span><span class="p">,</span>
<span class="w">      </span><span class="s2">&quot;candidate.programid&quot;</span><span class="o">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="s2">&quot;$in&quot;</span><span class="o">:</span><span class="w"> </span><span class="p">[</span>
<span class="w">          </span><span class="mf">1</span>
<span class="w">        </span><span class="p">]</span>
<span class="w">      </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">  </span><span class="p">},</span>
<span class="w">  </span><span class="p">{</span>
<span class="w">    </span><span class="s2">&quot;$project&quot;</span><span class="o">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="s2">&quot;cutoutScience&quot;</span><span class="o">:</span><span class="w"> </span><span class="mf">0</span><span class="p">,</span>
<span class="w">      </span><span class="s2">&quot;cutoutTemplate&quot;</span><span class="o">:</span><span class="w"> </span><span class="mf">0</span><span class="p">,</span>
<span class="w">      </span><span class="s2">&quot;cutoutDifference&quot;</span><span class="o">:</span><span class="w"> </span><span class="mf">0</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">  </span><span class="p">},</span>
<span class="w">  </span><span class="p">{</span>
<span class="w">    </span><span class="s2">&quot;$lookup&quot;</span><span class="o">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="s2">&quot;from&quot;</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;ZTF_alerts_aux&quot;</span><span class="p">,</span>
<span class="w">      </span><span class="s2">&quot;localField&quot;</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;objectId&quot;</span><span class="p">,</span>
<span class="w">      </span><span class="s2">&quot;foreignField&quot;</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;_id&quot;</span><span class="p">,</span>
<span class="w">      </span><span class="s2">&quot;as&quot;</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;aux&quot;</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">  </span><span class="p">},</span>
<span class="w">  </span><span class="p">{</span>
<span class="w">    </span><span class="s2">&quot;$project&quot;</span><span class="o">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="s2">&quot;cross_matches&quot;</span><span class="o">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="s2">&quot;$arrayElemAt&quot;</span><span class="o">:</span><span class="w"> </span><span class="p">[</span>
<span class="w">          </span><span class="s2">&quot;$aux.cross_matches&quot;</span><span class="p">,</span><span class="w"> </span><span class="mf">0</span>
<span class="w">        </span><span class="p">]</span>
<span class="w">      </span><span class="p">},</span>
<span class="w">      </span><span class="s2">&quot;prv_candidates&quot;</span><span class="o">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="s2">&quot;$filter&quot;</span><span class="o">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">          </span><span class="s2">&quot;input&quot;</span><span class="o">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="s2">&quot;$arrayElemAt&quot;</span><span class="o">:</span><span class="w"> </span><span class="p">[</span>
<span class="w">              </span><span class="s2">&quot;$aux.prv_candidates&quot;</span><span class="p">,</span><span class="w"> </span><span class="mf">0</span>
<span class="w">            </span><span class="p">]</span>
<span class="w">          </span><span class="p">},</span>
<span class="w">          </span><span class="s2">&quot;as&quot;</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;item&quot;</span><span class="p">,</span>
<span class="w">          </span><span class="s2">&quot;cond&quot;</span><span class="o">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="s2">&quot;$in&quot;</span><span class="o">:</span><span class="w"> </span><span class="p">[</span>
<span class="w">              </span><span class="s2">&quot;$$item.programid&quot;</span><span class="p">,</span><span class="w"> </span><span class="p">[</span>
<span class="w">                </span><span class="mf">1</span>
<span class="w">              </span><span class="p">]</span>
<span class="w">            </span><span class="p">]</span>
<span class="w">          </span><span class="p">}</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">      </span><span class="p">},</span>
<span class="w">      </span><span class="s2">&quot;schemavsn&quot;</span><span class="o">:</span><span class="w"> </span><span class="mf">1</span><span class="p">,</span>
<span class="w">      </span><span class="s2">&quot;publisher&quot;</span><span class="o">:</span><span class="w"> </span><span class="mf">1</span><span class="p">,</span>
<span class="w">      </span><span class="s2">&quot;objectId&quot;</span><span class="o">:</span><span class="w"> </span><span class="mf">1</span><span class="p">,</span>
<span class="w">      </span><span class="s2">&quot;candid&quot;</span><span class="o">:</span><span class="w"> </span><span class="mf">1</span><span class="p">,</span>
<span class="w">      </span><span class="s2">&quot;candidate&quot;</span><span class="o">:</span><span class="w"> </span><span class="mf">1</span><span class="p">,</span>
<span class="w">      </span><span class="s2">&quot;classifications&quot;</span><span class="o">:</span><span class="w"> </span><span class="mf">1</span><span class="p">,</span>
<span class="w">      </span><span class="s2">&quot;coordinates&quot;</span><span class="o">:</span><span class="w"> </span><span class="mf">1</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">  </span><span class="p">},</span>
<span class="w">  </span><span class="cm">/* USER-DEFINED PART */</span>
<span class="w">  </span><span class="p">{</span>
<span class="w">    </span><span class="s2">&quot;$project&quot;</span><span class="o">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="s2">&quot;_id&quot;</span><span class="o">:</span><span class="w"> </span><span class="mf">0</span><span class="p">,</span>
<span class="w">      </span><span class="s2">&quot;candid&quot;</span><span class="o">:</span><span class="w"> </span><span class="mf">1</span><span class="p">,</span>
<span class="w">      </span><span class="s2">&quot;objectId&quot;</span><span class="o">:</span><span class="w"> </span><span class="mf">1</span><span class="p">,</span>
<span class="w">      </span><span class="s2">&quot;prv_candidates.jd&quot;</span><span class="o">:</span><span class="w"> </span><span class="mf">1</span><span class="p">,</span>
<span class="w">      </span><span class="s2">&quot;prv_candidates.magpsf&quot;</span><span class="o">:</span><span class="w"> </span><span class="mf">1</span><span class="p">,</span>
<span class="w">      </span><span class="s2">&quot;prv_candidates.fid&quot;</span><span class="o">:</span><span class="w"> </span><span class="mf">1</span><span class="p">,</span>
<span class="w">      </span><span class="s2">&quot;prv_candidates.isdiffpos&quot;</span><span class="o">:</span><span class="w"> </span><span class="mf">1</span><span class="p">,</span>
<span class="w">      </span><span class="s2">&quot;isdiffpos&quot;</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;$candidate.isdiffpos&quot;</span><span class="p">,</span>
<span class="w">      </span><span class="s2">&quot;m_now&quot;</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;$candidate.magpsf&quot;</span><span class="p">,</span>
<span class="w">      </span><span class="s2">&quot;m_app&quot;</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;$candidate.magap&quot;</span><span class="p">,</span>
<span class="w">      </span><span class="s2">&quot;t_now&quot;</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;$candidate.jd&quot;</span><span class="p">,</span>
<span class="w">      </span><span class="s2">&quot;fid_now&quot;</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;$candidate.fid&quot;</span><span class="p">,</span>
<span class="w">      </span><span class="s2">&quot;sgscore&quot;</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;$candidate.sgscore1&quot;</span><span class="p">,</span>
<span class="w">      </span><span class="s2">&quot;sgscore2&quot;</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;$candidate.sgscore2&quot;</span><span class="p">,</span>
<span class="w">      </span><span class="s2">&quot;sgscore3&quot;</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;$candidate.sgscore3&quot;</span><span class="p">,</span>
<span class="w">      </span><span class="s2">&quot;srmag&quot;</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;$candidate.srmag1&quot;</span><span class="p">,</span>
<span class="w">      </span><span class="s2">&quot;srmag2&quot;</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;$candidate.srmag2&quot;</span><span class="p">,</span>
<span class="w">      </span><span class="s2">&quot;srmag3&quot;</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;$candidate.srmag3&quot;</span><span class="p">,</span>
<span class="w">      </span><span class="s2">&quot;sgmag&quot;</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;$candidate.sgmag1&quot;</span><span class="p">,</span>
<span class="w">      </span><span class="s2">&quot;simag&quot;</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;$candidate.simag1&quot;</span><span class="p">,</span>
<span class="w">      </span><span class="s2">&quot;drbscore&quot;</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;$candidate.drb&quot;</span><span class="p">,</span>
<span class="w">      </span><span class="s2">&quot;magnr&quot;</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;$candidate.magnr&quot;</span><span class="p">,</span>
<span class="w">      </span><span class="s2">&quot;distnr&quot;</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;$candidate.distnr&quot;</span><span class="p">,</span>
<span class="w">      </span><span class="s2">&quot;distpsnr1&quot;</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;$candidate.distpsnr1&quot;</span><span class="p">,</span>
<span class="w">      </span><span class="s2">&quot;distpsnr2&quot;</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;$candidate.distpsnr2&quot;</span><span class="p">,</span>
<span class="w">      </span><span class="s2">&quot;distpsnr3&quot;</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;$candidate.distpsnr3&quot;</span><span class="p">,</span>
<span class="w">      </span><span class="s2">&quot;scorr&quot;</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;$candidate.scorr&quot;</span><span class="p">,</span>
<span class="w">      </span><span class="s2">&quot;fwhm&quot;</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;$candidate.fwhm&quot;</span><span class="p">,</span>
<span class="w">      </span><span class="s2">&quot;elong&quot;</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;$candidate.elong&quot;</span><span class="p">,</span>
<span class="w">      </span><span class="s2">&quot;nbad&quot;</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;$candidate.nbad&quot;</span><span class="p">,</span>
<span class="w">      </span><span class="s2">&quot;chipsf&quot;</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;$candidate.chipsf&quot;</span><span class="p">,</span>
<span class="w">      </span><span class="s2">&quot;gal_lat&quot;</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;$coordinates.b&quot;</span><span class="p">,</span>
<span class="w">      </span><span class="s2">&quot;ssdistnr&quot;</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;$candidate.ssdistnr&quot;</span><span class="p">,</span>
<span class="w">      </span><span class="s2">&quot;ssmagnr&quot;</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;$candidate.ssmagnr&quot;</span><span class="p">,</span>
<span class="w">      </span><span class="s2">&quot;ssnamenr&quot;</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;$candidate.ssnamenr&quot;</span><span class="p">,</span>
<span class="w">      </span><span class="s2">&quot;t_start&quot;</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;$candidate.jdstarthist&quot;</span><span class="p">,</span>
<span class="w">      </span><span class="s2">&quot;age&quot;</span><span class="o">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="s2">&quot;$subtract&quot;</span><span class="o">:</span><span class="w"> </span><span class="p">[</span>
<span class="w">          </span><span class="s2">&quot;$candidate.jd&quot;</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;$candidate.jdstarthist&quot;</span>
<span class="w">        </span><span class="p">]</span>
<span class="w">      </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">  </span><span class="p">},</span>
<span class="w">  </span><span class="p">{</span>
<span class="w">    </span><span class="s2">&quot;$project&quot;</span><span class="o">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="s2">&quot;objectId&quot;</span><span class="o">:</span><span class="w"> </span><span class="mf">1</span><span class="p">,</span>
<span class="w">      </span><span class="s2">&quot;t_now&quot;</span><span class="o">:</span><span class="w"> </span><span class="mf">1</span><span class="p">,</span>
<span class="w">      </span><span class="s2">&quot;m_now&quot;</span><span class="o">:</span><span class="w"> </span><span class="mf">1</span><span class="p">,</span>
<span class="w">      </span><span class="s2">&quot;fid_now&quot;</span><span class="o">:</span><span class="w"> </span><span class="mf">1</span><span class="p">,</span>
<span class="w">      </span><span class="s2">&quot;sgscore&quot;</span><span class="o">:</span><span class="w"> </span><span class="mf">1</span><span class="p">,</span>
<span class="w">      </span><span class="s2">&quot;drbscore&quot;</span><span class="o">:</span><span class="w"> </span><span class="mf">1</span><span class="p">,</span>
<span class="w">      </span><span class="s2">&quot;magnr&quot;</span><span class="o">:</span><span class="w"> </span><span class="mf">1</span><span class="p">,</span>
<span class="w">      </span><span class="s2">&quot;distnr&quot;</span><span class="o">:</span><span class="w"> </span><span class="mf">1</span><span class="p">,</span>
<span class="w">      </span><span class="s2">&quot;scorr&quot;</span><span class="o">:</span><span class="w"> </span><span class="mf">1</span><span class="p">,</span>
<span class="w">      </span><span class="s2">&quot;gal_lat&quot;</span><span class="o">:</span><span class="w"> </span><span class="mf">1</span><span class="p">,</span>
<span class="w">      </span><span class="s2">&quot;ssdistnr&quot;</span><span class="o">:</span><span class="w"> </span><span class="mf">1</span><span class="p">,</span>
<span class="w">      </span><span class="s2">&quot;ssnamenr&quot;</span><span class="o">:</span><span class="w"> </span><span class="mf">1</span><span class="p">,</span>
<span class="w">      </span><span class="s2">&quot;age&quot;</span><span class="o">:</span><span class="w"> </span><span class="mf">1</span><span class="p">,</span>
<span class="w">      </span><span class="s2">&quot;peakmag&quot;</span><span class="o">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="s2">&quot;$min&quot;</span><span class="o">:</span><span class="w"> </span><span class="p">[</span>
<span class="w">          </span><span class="p">{</span>
<span class="w">            </span><span class="s2">&quot;$map&quot;</span><span class="o">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">              </span><span class="s2">&quot;input&quot;</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;$prv_candidates&quot;</span><span class="p">,</span>
<span class="w">              </span><span class="s2">&quot;as&quot;</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;cand&quot;</span><span class="p">,</span>
<span class="w">              </span><span class="s2">&quot;in&quot;</span><span class="o">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="s2">&quot;$cond&quot;</span><span class="o">:</span><span class="w"> </span><span class="p">[</span>
<span class="w">                  </span><span class="p">{</span>
<span class="w">                    </span><span class="s2">&quot;$eq&quot;</span><span class="o">:</span><span class="w"> </span><span class="p">[</span>
<span class="w">                      </span><span class="s2">&quot;$$cand.fid&quot;</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;$fid_now&quot;</span>
<span class="w">                    </span><span class="p">]</span>
<span class="w">                  </span><span class="p">},</span><span class="w"> </span><span class="s2">&quot;$$cand.magpsf&quot;</span><span class="p">,</span><span class="w"> </span><span class="kc">null</span>
<span class="w">                </span><span class="p">]</span>
<span class="w">              </span><span class="p">}</span>
<span class="w">            </span><span class="p">}</span>
<span class="w">          </span><span class="p">},</span><span class="w"> </span><span class="s2">&quot;$m_now&quot;</span>
<span class="w">        </span><span class="p">]</span>
<span class="w">      </span><span class="p">},</span>
<span class="w">      </span><span class="s2">&quot;bright&quot;</span><span class="o">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="s2">&quot;$or&quot;</span><span class="o">:</span><span class="w"> </span><span class="p">[</span>
<span class="w">          </span><span class="p">{</span>
<span class="w">            </span><span class="s2">&quot;$lt&quot;</span><span class="o">:</span><span class="w"> </span><span class="p">[</span>
<span class="w">              </span><span class="s2">&quot;$m_now&quot;</span><span class="p">,</span><span class="w"> </span><span class="mf">19.0</span>
<span class="w">            </span><span class="p">]</span>
<span class="w">          </span><span class="p">},</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="s2">&quot;$map&quot;</span><span class="o">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">              </span><span class="s2">&quot;input&quot;</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;$prv_candidates&quot;</span><span class="p">,</span>
<span class="w">              </span><span class="s2">&quot;as&quot;</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;cand&quot;</span><span class="p">,</span>
<span class="w">              </span><span class="s2">&quot;in&quot;</span><span class="o">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="s2">&quot;$and&quot;</span><span class="o">:</span><span class="w"> </span><span class="p">[</span>
<span class="w">                  </span><span class="p">{</span>
<span class="w">                    </span><span class="s2">&quot;$lt&quot;</span><span class="o">:</span><span class="w"> </span><span class="p">[</span>
<span class="w">                      </span><span class="p">{</span>
<span class="w">                        </span><span class="s2">&quot;$abs&quot;</span><span class="o">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">                          </span><span class="s2">&quot;$subtract&quot;</span><span class="o">:</span><span class="w"> </span><span class="p">[</span>
<span class="w">                            </span><span class="s2">&quot;$t_now&quot;</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;$$cand.jd&quot;</span>
<span class="w">                          </span><span class="p">]</span>
<span class="w">                        </span><span class="p">}</span>
<span class="w">                      </span><span class="p">},</span><span class="w"> </span><span class="mf">0.75</span>
<span class="w">                    </span><span class="p">]</span>
<span class="w">                  </span><span class="p">},</span><span class="w"> </span><span class="p">{</span>
<span class="w">                    </span><span class="s2">&quot;$in&quot;</span><span class="o">:</span><span class="w"> </span><span class="p">[</span>
<span class="w">                      </span><span class="s2">&quot;$isdiffpos&quot;</span><span class="p">,</span><span class="w"> </span><span class="p">[</span>
<span class="w">                        </span><span class="mf">1</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;1&quot;</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;t&quot;</span><span class="p">,</span><span class="w"> </span><span class="kc">true</span>
<span class="w">                      </span><span class="p">]</span>
<span class="w">                    </span><span class="p">]</span>
<span class="w">                  </span><span class="p">},</span><span class="w"> </span><span class="p">{</span>
<span class="w">                    </span><span class="s2">&quot;$gt&quot;</span><span class="o">:</span><span class="w"> </span><span class="p">[</span>
<span class="w">                      </span><span class="s2">&quot;$$cand.magpsf&quot;</span><span class="p">,</span><span class="w"> </span><span class="mf">0</span>
<span class="w">                    </span><span class="p">]</span>
<span class="w">                  </span><span class="p">},</span><span class="w"> </span><span class="p">{</span>
<span class="w">                    </span><span class="s2">&quot;$lt&quot;</span><span class="o">:</span><span class="w"> </span><span class="p">[</span>
<span class="w">                      </span><span class="s2">&quot;$$cand.magpsf&quot;</span><span class="p">,</span><span class="w"> </span><span class="mf">19</span>
<span class="w">                    </span><span class="p">]</span>
<span class="w">                  </span><span class="p">}</span>
<span class="w">                </span><span class="p">]</span>
<span class="w">              </span><span class="p">}</span>
<span class="w">            </span><span class="p">}</span>
<span class="w">          </span><span class="p">}</span>
<span class="w">        </span><span class="p">]</span>
<span class="w">      </span><span class="p">},</span>
<span class="w">      </span><span class="s2">&quot;latitude&quot;</span><span class="o">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="s2">&quot;$gte&quot;</span><span class="o">:</span><span class="w"> </span><span class="p">[</span>
<span class="w">          </span><span class="p">{</span>
<span class="w">            </span><span class="s2">&quot;$abs&quot;</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;$gal_lat&quot;</span>
<span class="w">          </span><span class="p">},</span><span class="w"> </span><span class="mf">7</span>
<span class="w">        </span><span class="p">]</span>
<span class="w">      </span><span class="p">},</span>
<span class="w">      </span><span class="s2">&quot;positivesubtraction&quot;</span><span class="o">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="s2">&quot;$in&quot;</span><span class="o">:</span><span class="w"> </span><span class="p">[</span>
<span class="w">          </span><span class="s2">&quot;$isdiffpos&quot;</span><span class="p">,</span><span class="w"> </span><span class="p">[</span>
<span class="w">            </span><span class="mf">1</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;1&quot;</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;t&quot;</span><span class="p">,</span><span class="w"> </span><span class="kc">true</span>
<span class="w">          </span><span class="p">]</span>
<span class="w">        </span><span class="p">]</span>
<span class="w">      </span><span class="p">},</span>
<span class="w">      </span><span class="s2">&quot;real&quot;</span><span class="o">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="s2">&quot;$gt&quot;</span><span class="o">:</span><span class="w"> </span><span class="p">[</span>
<span class="w">          </span><span class="s2">&quot;$drbscore&quot;</span><span class="p">,</span><span class="w"> </span><span class="mf">0.5</span>
<span class="w">        </span><span class="p">]</span>
<span class="w">      </span><span class="p">},</span>
<span class="w">      </span><span class="s2">&quot;nopointunderneath&quot;</span><span class="o">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="s2">&quot;$not&quot;</span><span class="o">:</span><span class="w"> </span><span class="p">[</span>
<span class="w">          </span><span class="p">{</span>
<span class="w">            </span><span class="s2">&quot;$and&quot;</span><span class="o">:</span><span class="w"> </span><span class="p">[</span>
<span class="w">              </span><span class="p">{</span>
<span class="w">                </span><span class="s2">&quot;$gt&quot;</span><span class="o">:</span><span class="w"> </span><span class="p">[</span>
<span class="w">                  </span><span class="s2">&quot;$sgscore&quot;</span><span class="p">,</span><span class="w"> </span><span class="mf">0.76</span>
<span class="w">                </span><span class="p">]</span>
<span class="w">              </span><span class="p">},</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="s2">&quot;$lt&quot;</span><span class="o">:</span><span class="w"> </span><span class="p">[</span>
<span class="w">                  </span><span class="s2">&quot;$distpsnr1&quot;</span><span class="p">,</span><span class="w"> </span><span class="mf">2</span>
<span class="w">                </span><span class="p">]</span>
<span class="w">              </span><span class="p">}</span>
<span class="w">            </span><span class="p">]</span>
<span class="w">          </span><span class="p">}</span>
<span class="w">        </span><span class="p">]</span>
<span class="w">      </span><span class="p">},</span>
<span class="w">      </span><span class="s2">&quot;brightstar&quot;</span><span class="o">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="s2">&quot;$or&quot;</span><span class="o">:</span><span class="w"> </span><span class="p">[</span>
<span class="w">          </span><span class="p">{</span>
<span class="w">            </span><span class="s2">&quot;$and&quot;</span><span class="o">:</span><span class="w"> </span><span class="p">[</span>
<span class="w">              </span><span class="p">{</span>
<span class="w">                </span><span class="s2">&quot;$lt&quot;</span><span class="o">:</span><span class="w"> </span><span class="p">[</span>
<span class="w">                  </span><span class="s2">&quot;$distpsnr1&quot;</span><span class="p">,</span><span class="w"> </span><span class="mf">20</span>
<span class="w">                </span><span class="p">]</span>
<span class="w">              </span><span class="p">},</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="s2">&quot;$lt&quot;</span><span class="o">:</span><span class="w"> </span><span class="p">[</span>
<span class="w">                  </span><span class="s2">&quot;$srmag&quot;</span><span class="p">,</span><span class="w"> </span><span class="mf">15</span>
<span class="w">                </span><span class="p">]</span>
<span class="w">              </span><span class="p">},</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="s2">&quot;$gt&quot;</span><span class="o">:</span><span class="w"> </span><span class="p">[</span>
<span class="w">                  </span><span class="s2">&quot;$srmag&quot;</span><span class="p">,</span><span class="w"> </span><span class="mf">0</span>
<span class="w">                </span><span class="p">]</span>
<span class="w">              </span><span class="p">},</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="s2">&quot;$gt&quot;</span><span class="o">:</span><span class="w"> </span><span class="p">[</span>
<span class="w">                  </span><span class="s2">&quot;$sgscore&quot;</span><span class="p">,</span><span class="w"> </span><span class="mf">0.49</span>
<span class="w">                </span><span class="p">]</span>
<span class="w">              </span><span class="p">}</span>
<span class="w">            </span><span class="p">]</span>
<span class="w">          </span><span class="p">},</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="s2">&quot;$and&quot;</span><span class="o">:</span><span class="w"> </span><span class="p">[</span>
<span class="w">              </span><span class="p">{</span>
<span class="w">                </span><span class="s2">&quot;$lt&quot;</span><span class="o">:</span><span class="w"> </span><span class="p">[</span>
<span class="w">                  </span><span class="s2">&quot;$distpsnr2&quot;</span><span class="p">,</span><span class="w"> </span><span class="mf">20</span>
<span class="w">                </span><span class="p">]</span>
<span class="w">              </span><span class="p">},</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="s2">&quot;$lt&quot;</span><span class="o">:</span><span class="w"> </span><span class="p">[</span>
<span class="w">                  </span><span class="s2">&quot;$srmag2&quot;</span><span class="p">,</span><span class="w"> </span><span class="mf">15</span>
<span class="w">                </span><span class="p">]</span>
<span class="w">              </span><span class="p">},</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="s2">&quot;$gt&quot;</span><span class="o">:</span><span class="w"> </span><span class="p">[</span>
<span class="w">                  </span><span class="s2">&quot;$srmag2&quot;</span><span class="p">,</span><span class="w"> </span><span class="mf">0</span>
<span class="w">                </span><span class="p">]</span>
<span class="w">              </span><span class="p">},</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="s2">&quot;$gt&quot;</span><span class="o">:</span><span class="w"> </span><span class="p">[</span>
<span class="w">                  </span><span class="s2">&quot;$sgscore2&quot;</span><span class="p">,</span><span class="w"> </span><span class="mf">0.49</span>
<span class="w">                </span><span class="p">]</span>
<span class="w">              </span><span class="p">}</span>
<span class="w">            </span><span class="p">]</span>
<span class="w">          </span><span class="p">},</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="s2">&quot;$and&quot;</span><span class="o">:</span><span class="w"> </span><span class="p">[</span>
<span class="w">              </span><span class="p">{</span>
<span class="w">                </span><span class="s2">&quot;$lt&quot;</span><span class="o">:</span><span class="w"> </span><span class="p">[</span>
<span class="w">                  </span><span class="s2">&quot;$distpsnr3&quot;</span><span class="p">,</span><span class="w"> </span><span class="mf">20</span>
<span class="w">                </span><span class="p">]</span>
<span class="w">              </span><span class="p">},</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="s2">&quot;$lt&quot;</span><span class="o">:</span><span class="w"> </span><span class="p">[</span>
<span class="w">                  </span><span class="s2">&quot;$srmag3&quot;</span><span class="p">,</span><span class="w"> </span><span class="mf">15</span>
<span class="w">                </span><span class="p">]</span>
<span class="w">              </span><span class="p">},</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="s2">&quot;$gt&quot;</span><span class="o">:</span><span class="w"> </span><span class="p">[</span>
<span class="w">                  </span><span class="s2">&quot;$srmag3&quot;</span><span class="p">,</span><span class="w"> </span><span class="mf">0</span>
<span class="w">                </span><span class="p">]</span>
<span class="w">              </span><span class="p">},</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="s2">&quot;$gt&quot;</span><span class="o">:</span><span class="w"> </span><span class="p">[</span>
<span class="w">                  </span><span class="s2">&quot;$sgscore3&quot;</span><span class="p">,</span><span class="w"> </span><span class="mf">0.49</span>
<span class="w">                </span><span class="p">]</span>
<span class="w">              </span><span class="p">}</span>
<span class="w">            </span><span class="p">]</span>
<span class="w">          </span><span class="p">},</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="s2">&quot;$and&quot;</span><span class="o">:</span><span class="w"> </span><span class="p">[</span>
<span class="w">              </span><span class="p">{</span>
<span class="w">                </span><span class="s2">&quot;$eq&quot;</span><span class="o">:</span><span class="w"> </span><span class="p">[</span>
<span class="w">                  </span><span class="s2">&quot;$sgscore&quot;</span><span class="p">,</span><span class="w"> </span><span class="mf">0.5</span>
<span class="w">                </span><span class="p">]</span>
<span class="w">              </span><span class="p">},</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="s2">&quot;$lt&quot;</span><span class="o">:</span><span class="w"> </span><span class="p">[</span>
<span class="w">                  </span><span class="s2">&quot;$distpsnr1&quot;</span><span class="p">,</span><span class="w"> </span><span class="mf">0.5</span>
<span class="w">                </span><span class="p">]</span>
<span class="w">              </span><span class="p">},</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="s2">&quot;$or&quot;</span><span class="o">:</span><span class="w"> </span><span class="p">[</span>
<span class="w">                  </span><span class="p">{</span>
<span class="w">                    </span><span class="s2">&quot;$lt&quot;</span><span class="o">:</span><span class="w"> </span><span class="p">[</span>
<span class="w">                      </span><span class="s2">&quot;$sgmag&quot;</span><span class="p">,</span><span class="w"> </span><span class="mf">17</span>
<span class="w">                    </span><span class="p">]</span>
<span class="w">                  </span><span class="p">},</span><span class="w"> </span><span class="p">{</span>
<span class="w">                    </span><span class="s2">&quot;$lt&quot;</span><span class="o">:</span><span class="w"> </span><span class="p">[</span>
<span class="w">                      </span><span class="s2">&quot;$srmag&quot;</span><span class="p">,</span><span class="w"> </span><span class="mf">17</span>
<span class="w">                    </span><span class="p">]</span>
<span class="w">                  </span><span class="p">},</span><span class="w"> </span><span class="p">{</span>
<span class="w">                    </span><span class="s2">&quot;$lt&quot;</span><span class="o">:</span><span class="w"> </span><span class="p">[</span>
<span class="w">                      </span><span class="s2">&quot;$simag&quot;</span><span class="p">,</span><span class="w"> </span><span class="mf">17</span>
<span class="w">                    </span><span class="p">]</span>
<span class="w">                  </span><span class="p">}</span>
<span class="w">                </span><span class="p">]</span>
<span class="w">              </span><span class="p">}</span>
<span class="w">            </span><span class="p">]</span>
<span class="w">          </span><span class="p">}</span>
<span class="w">        </span><span class="p">]</span>
<span class="w">      </span><span class="p">},</span>
<span class="w">      </span><span class="s2">&quot;variablesource&quot;</span><span class="o">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="s2">&quot;$or&quot;</span><span class="o">:</span><span class="w"> </span><span class="p">[</span>
<span class="w">          </span><span class="p">{</span>
<span class="w">            </span><span class="s2">&quot;$and&quot;</span><span class="o">:</span><span class="w"> </span><span class="p">[</span>
<span class="w">              </span><span class="p">{</span>
<span class="w">                </span><span class="s2">&quot;$lt&quot;</span><span class="o">:</span><span class="w"> </span><span class="p">[</span>
<span class="w">                  </span><span class="s2">&quot;$distnr&quot;</span><span class="p">,</span><span class="w"> </span><span class="mf">0.4</span>
<span class="w">                </span><span class="p">]</span>
<span class="w">              </span><span class="p">},</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="s2">&quot;$lt&quot;</span><span class="o">:</span><span class="w"> </span><span class="p">[</span>
<span class="w">                  </span><span class="s2">&quot;$magnr&quot;</span><span class="p">,</span><span class="w"> </span><span class="mf">19</span>
<span class="w">                </span><span class="p">]</span>
<span class="w">              </span><span class="p">},</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="s2">&quot;$gt&quot;</span><span class="o">:</span><span class="w"> </span><span class="p">[</span>
<span class="w">                  </span><span class="s2">&quot;$age&quot;</span><span class="p">,</span><span class="w"> </span><span class="mf">90</span>
<span class="w">                </span><span class="p">]</span>
<span class="w">              </span><span class="p">}</span>
<span class="w">            </span><span class="p">]</span>
<span class="w">          </span><span class="p">},</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="s2">&quot;$and&quot;</span><span class="o">:</span><span class="w"> </span><span class="p">[</span>
<span class="w">              </span><span class="p">{</span>
<span class="w">                </span><span class="s2">&quot;$lt&quot;</span><span class="o">:</span><span class="w"> </span><span class="p">[</span>
<span class="w">                  </span><span class="s2">&quot;$distnr&quot;</span><span class="p">,</span><span class="w"> </span><span class="mf">0.8</span>
<span class="w">                </span><span class="p">]</span>
<span class="w">              </span><span class="p">},</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="s2">&quot;$lt&quot;</span><span class="o">:</span><span class="w"> </span><span class="p">[</span>
<span class="w">                  </span><span class="s2">&quot;$magnr&quot;</span><span class="p">,</span><span class="w"> </span><span class="mf">17</span>
<span class="w">                </span><span class="p">]</span>
<span class="w">              </span><span class="p">},</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="s2">&quot;$gt&quot;</span><span class="o">:</span><span class="w"> </span><span class="p">[</span>
<span class="w">                  </span><span class="s2">&quot;$age&quot;</span><span class="p">,</span><span class="w"> </span><span class="mf">90</span>
<span class="w">                </span><span class="p">]</span>
<span class="w">              </span><span class="p">}</span>
<span class="w">            </span><span class="p">]</span>
<span class="w">          </span><span class="p">},</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="s2">&quot;$and&quot;</span><span class="o">:</span><span class="w"> </span><span class="p">[</span>
<span class="w">              </span><span class="p">{</span>
<span class="w">                </span><span class="s2">&quot;$lt&quot;</span><span class="o">:</span><span class="w"> </span><span class="p">[</span>
<span class="w">                  </span><span class="s2">&quot;$distnr&quot;</span><span class="p">,</span><span class="w"> </span><span class="mf">1.2</span>
<span class="w">                </span><span class="p">]</span>
<span class="w">              </span><span class="p">},</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="s2">&quot;$lt&quot;</span><span class="o">:</span><span class="w"> </span><span class="p">[</span>
<span class="w">                  </span><span class="s2">&quot;$magnr&quot;</span><span class="p">,</span><span class="w"> </span><span class="mf">15</span>
<span class="w">                </span><span class="p">]</span>
<span class="w">              </span><span class="p">},</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="s2">&quot;$gt&quot;</span><span class="o">:</span><span class="w"> </span><span class="p">[</span>
<span class="w">                  </span><span class="s2">&quot;$age&quot;</span><span class="p">,</span><span class="w"> </span><span class="mf">90</span>
<span class="w">                </span><span class="p">]</span>
<span class="w">              </span><span class="p">}</span>
<span class="w">            </span><span class="p">]</span>
<span class="w">          </span><span class="p">}</span>
<span class="w">        </span><span class="p">]</span>
<span class="w">      </span><span class="p">},</span>
<span class="w">      </span><span class="s2">&quot;rock&quot;</span><span class="o">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="s2">&quot;$and&quot;</span><span class="o">:</span><span class="w"> </span><span class="p">[</span>
<span class="w">          </span><span class="p">{</span>
<span class="w">            </span><span class="s2">&quot;$gte&quot;</span><span class="o">:</span><span class="w"> </span><span class="p">[</span>
<span class="w">              </span><span class="s2">&quot;$ssdistnr&quot;</span><span class="p">,</span><span class="w"> </span><span class="mf">0</span>
<span class="w">            </span><span class="p">]</span>
<span class="w">          </span><span class="p">},</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="s2">&quot;$lt&quot;</span><span class="o">:</span><span class="w"> </span><span class="p">[</span>
<span class="w">              </span><span class="s2">&quot;$ssdistnr&quot;</span><span class="p">,</span><span class="w"> </span><span class="mf">12</span>
<span class="w">            </span><span class="p">]</span>
<span class="w">          </span><span class="p">},</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="s2">&quot;$lt&quot;</span><span class="o">:</span><span class="w"> </span><span class="p">[</span>
<span class="w">              </span><span class="p">{</span>
<span class="w">                </span><span class="s2">&quot;$abs&quot;</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;$ssmagnr&quot;</span>
<span class="w">              </span><span class="p">},</span><span class="w"> </span><span class="mf">20</span>
<span class="w">            </span><span class="p">]</span>
<span class="w">          </span><span class="p">}</span>
<span class="w">        </span><span class="p">]</span>
<span class="w">      </span><span class="p">},</span>
<span class="w">      </span><span class="s2">&quot;stationary&quot;</span><span class="o">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="s2">&quot;$anyElementTrue&quot;</span><span class="o">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">          </span><span class="s2">&quot;$map&quot;</span><span class="o">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="s2">&quot;input&quot;</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;$prv_candidates&quot;</span><span class="p">,</span>
<span class="w">            </span><span class="s2">&quot;as&quot;</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;cand&quot;</span><span class="p">,</span>
<span class="w">            </span><span class="s2">&quot;in&quot;</span><span class="o">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">              </span><span class="s2">&quot;$and&quot;</span><span class="o">:</span><span class="w"> </span><span class="p">[</span>
<span class="w">                </span><span class="p">{</span>
<span class="w">                  </span><span class="s2">&quot;$gt&quot;</span><span class="o">:</span><span class="w"> </span><span class="p">[</span>
<span class="w">                    </span><span class="p">{</span>
<span class="w">                      </span><span class="s2">&quot;$abs&quot;</span><span class="o">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">                        </span><span class="s2">&quot;$subtract&quot;</span><span class="o">:</span><span class="w"> </span><span class="p">[</span>
<span class="w">                          </span><span class="s2">&quot;$t_now&quot;</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;$$cand.jd&quot;</span>
<span class="w">                        </span><span class="p">]</span>
<span class="w">                      </span><span class="p">}</span>
<span class="w">                    </span><span class="p">},</span><span class="w"> </span><span class="mf">0.02</span>
<span class="w">                  </span><span class="p">]</span>
<span class="w">                </span><span class="p">},</span><span class="w"> </span><span class="p">{</span>
<span class="w">                  </span><span class="s2">&quot;$lt&quot;</span><span class="o">:</span><span class="w"> </span><span class="p">[</span>
<span class="w">                    </span><span class="s2">&quot;$$cand.magpsf&quot;</span><span class="p">,</span><span class="w"> </span><span class="mf">99</span>
<span class="w">                  </span><span class="p">]</span>
<span class="w">                </span><span class="p">},</span><span class="w"> </span><span class="p">{</span>
<span class="w">                  </span><span class="s2">&quot;$in&quot;</span><span class="o">:</span><span class="w"> </span><span class="p">[</span>
<span class="w">                    </span><span class="s2">&quot;$$cand.isdiffpos&quot;</span><span class="p">,</span><span class="w"> </span><span class="p">[</span>
<span class="w">                      </span><span class="mf">1</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;1&quot;</span><span class="p">,</span><span class="w"> </span><span class="kc">true</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;t&quot;</span>
<span class="w">                    </span><span class="p">]</span>
<span class="w">                  </span><span class="p">]</span>
<span class="w">                </span><span class="p">}</span>
<span class="w">              </span><span class="p">]</span>
<span class="w">            </span><span class="p">}</span>
<span class="w">          </span><span class="p">}</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">      </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">  </span><span class="p">},</span>
<span class="w">  </span><span class="p">{</span>
<span class="w">    </span><span class="s2">&quot;$match&quot;</span><span class="o">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="s2">&quot;latitude&quot;</span><span class="o">:</span><span class="w"> </span><span class="kc">true</span><span class="p">,</span>
<span class="w">      </span><span class="s2">&quot;bright&quot;</span><span class="o">:</span><span class="w"> </span><span class="kc">true</span><span class="p">,</span>
<span class="w">      </span><span class="s2">&quot;nopointunderneath&quot;</span><span class="o">:</span><span class="w"> </span><span class="kc">true</span><span class="p">,</span>
<span class="w">      </span><span class="s2">&quot;positivesubtraction&quot;</span><span class="o">:</span><span class="w"> </span><span class="kc">true</span><span class="p">,</span>
<span class="w">      </span><span class="s2">&quot;real&quot;</span><span class="o">:</span><span class="w"> </span><span class="kc">true</span><span class="p">,</span>
<span class="w">      </span><span class="s2">&quot;stationary&quot;</span><span class="o">:</span><span class="w"> </span><span class="kc">true</span><span class="p">,</span>
<span class="w">      </span><span class="s2">&quot;brightstar&quot;</span><span class="o">:</span><span class="w"> </span><span class="kc">false</span><span class="p">,</span>
<span class="w">      </span><span class="s2">&quot;rock&quot;</span><span class="o">:</span><span class="w"> </span><span class="kc">false</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">  </span><span class="p">},</span>
<span class="w">  </span><span class="p">{</span>
<span class="w">    </span><span class="s2">&quot;$project&quot;</span><span class="o">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="s2">&quot;objectId&quot;</span><span class="o">:</span><span class="w"> </span><span class="mf">1</span><span class="p">,</span>
<span class="w">      </span><span class="s2">&quot;annotations.jd&quot;</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;$t_now&quot;</span><span class="p">,</span>
<span class="w">      </span><span class="s2">&quot;annotations.magnitude&quot;</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;$m_now&quot;</span><span class="p">,</span>
<span class="w">      </span><span class="s2">&quot;annotations.sgscore&quot;</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;$sgscore&quot;</span><span class="p">,</span>
<span class="w">      </span><span class="s2">&quot;annotations.peakmag&quot;</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;$peakmag&quot;</span><span class="p">,</span>
<span class="w">      </span><span class="s2">&quot;annotations.atpeak&quot;</span><span class="o">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="s2">&quot;$eq&quot;</span><span class="o">:</span><span class="w"> </span><span class="p">[</span>
<span class="w">          </span><span class="s2">&quot;$m_now&quot;</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;$peakmag&quot;</span>
<span class="w">        </span><span class="p">]</span>
<span class="w">      </span><span class="p">},</span>
<span class="w">      </span><span class="s2">&quot;annotations.age&quot;</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;$age&quot;</span><span class="p">,</span>
<span class="w">      </span><span class="s2">&quot;annotations.drb&quot;</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;$drbscore&quot;</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">]</span>
</pre></div>
</div>
</section>
<section id="bts-rcf-program-full-filter">
<h4>BTS/RCF program full filter<a class="headerlink" href="#bts-rcf-program-full-filter" title="Link to this heading">¶</a></h4>
<p>Here you will find the full version (as of December 2020) of the Bright Transient Survey filter
(the Redshift Completeness Factor program)</p>
<p><a class="reference download internal" download="" href="_downloads/362b617616293d2d5c513ba054d22d43/fritz_filter_rcf.json"><code class="xref download docutils literal notranslate"><span class="pre">fritz_filter_rcf.json</span></code></a></p>
</section>
<section id="fast-transients-program-filter">
<h4>Fast Transients program filter<a class="headerlink" href="#fast-transients-program-filter" title="Link to this heading">¶</a></h4>
<p>In this example, we will see how to adapt the Fast Transients’ program filter that has been using Kowalski for the
initial search.</p>
<p><a class="reference download internal" download="" href="_downloads/0d9e822457e27108abb8cb59fd37715c/fritz_filter_fast.json"><code class="xref download docutils literal notranslate"><span class="pre">fritz_filter_fast.json</span></code></a></p>
<p>In the <code class="docutils literal notranslate"><span class="pre">python</span></code> code snippet below, courtesy of Anna Ho and Yuhan Yao, a coarse search is run using Kowalski and then a
number of logical expressions would be evaluated on the query result:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">astropy.time</span> <span class="kn">import</span> <span class="n">Time</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">from</span> <span class="nn">penquins</span> <span class="kn">import</span> <span class="n">Kowalski</span>

<span class="c1"># Set search window</span>
<span class="n">obst</span> <span class="o">=</span> <span class="n">obs</span><span class="p">[</span><span class="s1">&#39;UT_START&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>
<span class="n">start</span> <span class="o">=</span> <span class="n">Time</span><span class="p">(</span><span class="n">obst</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="nb">format</span><span class="o">=</span><span class="s1">&#39;isot&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">jd</span> <span class="o">-</span> <span class="mf">0.02</span>
<span class="n">end</span> <span class="o">=</span> <span class="n">Time</span><span class="p">(</span><span class="n">obst</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="nb">format</span><span class="o">=</span><span class="s1">&#39;isot&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">jd</span> <span class="o">+</span> <span class="mf">0.02</span>
<span class="c1"># gt is greater than, lt is lower than</span>
<span class="n">q</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;query_type&quot;</span><span class="p">:</span> <span class="s2">&quot;find&quot;</span><span class="p">,</span>
     <span class="s2">&quot;query&quot;</span><span class="p">:</span> <span class="p">{</span>
         <span class="s2">&quot;catalog&quot;</span><span class="p">:</span> <span class="s2">&quot;ZTF_alerts&quot;</span><span class="p">,</span>
         <span class="s2">&quot;filter&quot;</span><span class="p">:</span> <span class="p">{</span>
                 <span class="s1">&#39;candidate.jd&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;$gt&#39;</span><span class="p">:</span> <span class="n">start</span><span class="p">,</span> <span class="s1">&#39;$lt&#39;</span><span class="p">:</span> <span class="n">end</span><span class="p">},</span>
                 <span class="s1">&#39;candidate.magpsf&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;$lt&#39;</span><span class="p">:</span> <span class="mi">20</span><span class="p">},</span>
                 <span class="s1">&#39;candidate.isdiffpos&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;$in&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;1&#39;</span><span class="p">,</span> <span class="s1">&#39;t&#39;</span><span class="p">]},</span>
                 <span class="s1">&#39;candidate.programid&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;$gt&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">},</span>
                 <span class="s1">&#39;candidate.ssdistnr&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;$lt&#39;</span><span class="p">:</span> <span class="o">-</span><span class="mi">1</span><span class="p">},</span>
                 <span class="s1">&#39;candidate.drb&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;$gt&#39;</span><span class="p">:</span> <span class="mf">0.65</span><span class="p">},</span> <span class="c1"># That gives a 1.7% FNR and FPR.</span>
         <span class="p">},</span>
         <span class="s2">&quot;projection&quot;</span><span class="p">:</span> <span class="p">{</span>
                 <span class="s2">&quot;objectId&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
                 <span class="s2">&quot;candidate.distpsnr1&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
                 <span class="s2">&quot;candidate.sgscore1&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
                 <span class="s2">&quot;candidate.srmag1&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
                 <span class="s2">&quot;candidate.sgmag1&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
                 <span class="s2">&quot;candidate.simag1&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
                 <span class="s2">&quot;candidate.szmag1&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
         <span class="p">}</span>
     <span class="p">}</span>
     <span class="p">}</span>
<span class="n">kowalski</span> <span class="o">=</span> <span class="n">Kowalski</span><span class="p">()</span>
<span class="n">query_result</span> <span class="o">=</span> <span class="n">kowalski</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">query</span><span class="o">=</span><span class="n">q</span><span class="p">)</span>
<span class="n">out</span> <span class="o">=</span> <span class="n">query_result</span><span class="p">[</span><span class="s1">&#39;data&#39;</span><span class="p">]</span>
<span class="n">names_all</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">val</span><span class="p">[</span><span class="s1">&#39;objectId&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">val</span> <span class="ow">in</span> <span class="n">out</span><span class="p">])</span>
<span class="n">names</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">names_all</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;There are </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">names</span><span class="p">)</span><span class="si">}</span><span class="s2"> unique cands from this initial filter.&quot;</span><span class="p">)</span>

<span class="n">dist</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">val</span><span class="p">[</span><span class="s1">&#39;candidate&#39;</span><span class="p">][</span><span class="s1">&#39;distpsnr1&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">val</span> <span class="ow">in</span> <span class="n">out</span><span class="p">])</span>
<span class="n">sg</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">val</span><span class="p">[</span><span class="s1">&#39;candidate&#39;</span><span class="p">][</span><span class="s1">&#39;sgscore1&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">val</span> <span class="ow">in</span> <span class="n">out</span><span class="p">])</span>
<span class="n">rmag</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">val</span><span class="p">[</span><span class="s1">&#39;candidate&#39;</span><span class="p">][</span><span class="s1">&#39;srmag1&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">val</span> <span class="ow">in</span> <span class="n">out</span><span class="p">])</span>
<span class="n">gmag</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">val</span><span class="p">[</span><span class="s1">&#39;candidate&#39;</span><span class="p">][</span><span class="s1">&#39;sgmag1&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">val</span> <span class="ow">in</span> <span class="n">out</span><span class="p">])</span>
<span class="n">imag</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">val</span><span class="p">[</span><span class="s1">&#39;candidate&#39;</span><span class="p">][</span><span class="s1">&#39;simag1&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">val</span> <span class="ow">in</span> <span class="n">out</span><span class="p">])</span>
<span class="n">zmag</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">val</span><span class="p">[</span><span class="s1">&#39;candidate&#39;</span><span class="p">][</span><span class="s1">&#39;szmag1&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">val</span> <span class="ow">in</span> <span class="n">out</span><span class="p">])</span>

<span class="n">pointunderneath</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">names_all</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">bool</span><span class="p">)</span>

<span class="n">crit</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">logical_and</span><span class="o">.</span><span class="n">reduce</span><span class="p">((</span><span class="n">dist</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">,</span> <span class="n">dist</span><span class="o">&lt;</span><span class="mi">2</span><span class="p">,</span> <span class="n">sg</span><span class="o">&gt;</span><span class="mf">0.76</span><span class="p">))</span>
<span class="n">pointunderneath</span><span class="p">[</span><span class="n">crit</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>

<span class="n">crit</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">logical_and</span><span class="p">(</span>
        <span class="n">np</span><span class="o">.</span><span class="n">logical_and</span><span class="o">.</span><span class="n">reduce</span><span class="p">((</span><span class="n">sg</span><span class="o">==</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">dist</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">,</span> <span class="n">dist</span><span class="o">&lt;</span><span class="mf">0.5</span><span class="p">)),</span>
        <span class="n">np</span><span class="o">.</span><span class="n">logical_or</span><span class="o">.</span><span class="n">reduce</span><span class="p">((</span>
            <span class="n">np</span><span class="o">.</span><span class="n">logical_and</span><span class="p">(</span><span class="n">rmag</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">,</span><span class="n">rmag</span><span class="o">&lt;</span><span class="mi">17</span><span class="p">),</span>
            <span class="n">np</span><span class="o">.</span><span class="n">logical_and</span><span class="p">(</span><span class="n">gmag</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">,</span><span class="n">gmag</span><span class="o">&lt;</span><span class="mi">17</span><span class="p">),</span>
            <span class="n">np</span><span class="o">.</span><span class="n">logical_and</span><span class="p">(</span><span class="n">imag</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">,</span><span class="n">imag</span><span class="o">&lt;</span><span class="mi">17</span><span class="p">),</span>
            <span class="n">np</span><span class="o">.</span><span class="n">logical_and</span><span class="p">(</span><span class="n">zmag</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">,</span><span class="n">zmag</span><span class="o">&lt;</span><span class="mi">17</span><span class="p">),</span>
        <span class="p">)))</span>
<span class="n">pointunderneath</span><span class="p">[</span><span class="n">crit</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>

<span class="n">crit</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">logical_or</span><span class="o">.</span><span class="n">reduce</span><span class="p">((</span>
    <span class="n">np</span><span class="o">.</span><span class="n">logical_and</span><span class="o">.</span><span class="n">reduce</span><span class="p">((</span><span class="n">rmag</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">,</span> <span class="n">rmag</span> <span class="o">&lt;</span> <span class="mi">12</span><span class="p">,</span> <span class="n">sg</span> <span class="o">&gt;</span> <span class="mf">0.49</span><span class="p">,</span> <span class="n">dist</span> <span class="o">&lt;</span> <span class="mi">20</span><span class="p">)),</span>
    <span class="n">np</span><span class="o">.</span><span class="n">logical_and</span><span class="o">.</span><span class="n">reduce</span><span class="p">((</span><span class="n">rmag</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">,</span> <span class="n">rmag</span> <span class="o">&lt;</span> <span class="mi">15</span><span class="p">,</span> <span class="n">sg</span> <span class="o">&gt;</span> <span class="mf">0.49</span><span class="p">,</span> <span class="n">dist</span> <span class="o">&lt;</span> <span class="mi">5</span><span class="p">)),</span>
    <span class="n">np</span><span class="o">.</span><span class="n">logical_and</span><span class="o">.</span><span class="n">reduce</span><span class="p">((</span><span class="n">rmag</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">,</span> <span class="n">rmag</span> <span class="o">&lt;</span> <span class="mi">15</span><span class="p">,</span> <span class="n">sg</span> <span class="o">&gt;</span> <span class="mf">0.8</span><span class="p">,</span> <span class="n">dist</span> <span class="o">&lt;</span> <span class="mi">20</span><span class="p">)),</span>
    <span class="n">np</span><span class="o">.</span><span class="n">logical_and</span><span class="o">.</span><span class="n">reduce</span><span class="p">((</span><span class="n">gmag</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">,</span> <span class="n">gmag</span> <span class="o">&lt;</span> <span class="mi">12</span><span class="p">,</span> <span class="n">sg</span> <span class="o">&gt;</span> <span class="mf">0.49</span><span class="p">,</span> <span class="n">dist</span> <span class="o">&lt;</span> <span class="mi">20</span><span class="p">)),</span>
    <span class="n">np</span><span class="o">.</span><span class="n">logical_and</span><span class="o">.</span><span class="n">reduce</span><span class="p">((</span><span class="n">gmag</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">,</span> <span class="n">gmag</span> <span class="o">&lt;</span> <span class="mi">15</span><span class="p">,</span> <span class="n">sg</span> <span class="o">&gt;</span> <span class="mf">0.8</span><span class="p">,</span> <span class="n">dist</span> <span class="o">&lt;</span> <span class="mi">20</span><span class="p">)),</span>
    <span class="n">np</span><span class="o">.</span><span class="n">logical_and</span><span class="o">.</span><span class="n">reduce</span><span class="p">((</span><span class="n">imag</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">,</span> <span class="n">imag</span> <span class="o">&lt;</span> <span class="mi">12</span><span class="p">,</span> <span class="n">sg</span> <span class="o">&gt;</span> <span class="mf">0.49</span><span class="p">,</span> <span class="n">dist</span> <span class="o">&lt;</span> <span class="mi">20</span><span class="p">)),</span>
    <span class="n">np</span><span class="o">.</span><span class="n">logical_and</span><span class="o">.</span><span class="n">reduce</span><span class="p">((</span><span class="n">imag</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">,</span> <span class="n">imag</span> <span class="o">&lt;</span> <span class="mf">11.5</span><span class="p">,</span> <span class="n">sg</span> <span class="o">&gt;</span> <span class="mf">0.49</span><span class="p">,</span> <span class="n">dist</span> <span class="o">&lt;</span> <span class="mi">20</span><span class="p">)),</span>
    <span class="n">np</span><span class="o">.</span><span class="n">logical_and</span><span class="o">.</span><span class="n">reduce</span><span class="p">((</span><span class="n">imag</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">,</span> <span class="n">imag</span> <span class="o">&lt;</span> <span class="mf">14.5</span><span class="p">,</span> <span class="n">sg</span> <span class="o">&gt;</span> <span class="mf">0.49</span><span class="p">,</span> <span class="n">dist</span> <span class="o">&lt;</span> <span class="mi">5</span><span class="p">)),</span>
    <span class="n">np</span><span class="o">.</span><span class="n">logical_and</span><span class="o">.</span><span class="n">reduce</span><span class="p">((</span><span class="n">imag</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">,</span> <span class="n">imag</span> <span class="o">&lt;</span> <span class="mi">15</span><span class="p">,</span> <span class="n">sg</span> <span class="o">&gt;</span> <span class="mf">0.8</span><span class="p">,</span> <span class="n">dist</span> <span class="o">&lt;</span> <span class="mi">20</span><span class="p">)),</span>
    <span class="n">np</span><span class="o">.</span><span class="n">logical_and</span><span class="o">.</span><span class="n">reduce</span><span class="p">((</span><span class="n">zmag</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">,</span> <span class="n">zmag</span> <span class="o">&lt;</span> <span class="mf">11.5</span><span class="p">,</span> <span class="n">sg</span> <span class="o">&gt;</span> <span class="mf">0.49</span><span class="p">,</span> <span class="n">dist</span> <span class="o">&lt;</span> <span class="mi">10</span><span class="p">)),</span>
    <span class="n">np</span><span class="o">.</span><span class="n">logical_and</span><span class="o">.</span><span class="n">reduce</span><span class="p">((</span><span class="n">zmag</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">,</span> <span class="n">zmag</span> <span class="o">&lt;</span> <span class="mf">14.0</span><span class="p">,</span> <span class="n">sg</span> <span class="o">&gt;</span> <span class="mf">0.49</span><span class="p">,</span> <span class="n">dist</span> <span class="o">&lt;</span> <span class="mf">2.5</span><span class="p">)),</span>
    <span class="n">np</span><span class="o">.</span><span class="n">logical_and</span><span class="o">.</span><span class="n">reduce</span><span class="p">((</span><span class="n">zmag</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">,</span> <span class="n">zmag</span> <span class="o">&lt;</span> <span class="mi">15</span><span class="p">,</span> <span class="n">sg</span> <span class="o">&gt;</span> <span class="mf">0.8</span><span class="p">,</span> <span class="n">dist</span> <span class="o">&lt;</span> <span class="mi">20</span><span class="p">))))</span>
<span class="n">pointunderneath</span><span class="p">[</span><span class="n">crit</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>

<span class="n">names_no_star</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">names_all</span><span class="p">[</span><span class="n">pointunderneath</span><span class="o">==</span><span class="kc">False</span><span class="p">])</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;There are </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">names_no_star</span><span class="p">)</span><span class="si">}</span><span class="s2"> that are not stars.&quot;</span><span class="p">)</span>
<span class="n">passed</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">names_no_star</span><span class="p">)</span>

</pre></div>
</div>
<p>As we have seen above, we can build these kinds of logical expressions right into our filter:</p>
<div class="highlight-js notranslate"><div class="highlight"><pre><span></span><span class="p">[</span>
<span class="w">  </span><span class="p">{</span>
<span class="w">    </span><span class="s2">&quot;$project&quot;</span><span class="o">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="s2">&quot;cutoutScience&quot;</span><span class="o">:</span><span class="w"> </span><span class="mf">0</span><span class="p">,</span>
<span class="w">      </span><span class="s2">&quot;cutoutTemplate&quot;</span><span class="o">:</span><span class="w"> </span><span class="mf">0</span><span class="p">,</span>
<span class="w">      </span><span class="s2">&quot;cutoutDifference&quot;</span><span class="o">:</span><span class="w"> </span><span class="mf">0</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">  </span><span class="p">},</span>
<span class="w">  </span><span class="p">{</span>
<span class="w">    </span><span class="s2">&quot;$lookup&quot;</span><span class="o">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="s2">&quot;from&quot;</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;ZTF_alerts_aux&quot;</span><span class="p">,</span>
<span class="w">      </span><span class="s2">&quot;localField&quot;</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;objectId&quot;</span><span class="p">,</span>
<span class="w">      </span><span class="s2">&quot;foreignField&quot;</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;_id&quot;</span><span class="p">,</span>
<span class="w">      </span><span class="s2">&quot;as&quot;</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;aux&quot;</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">  </span><span class="p">},</span>
<span class="w">  </span><span class="p">{</span>
<span class="w">    </span><span class="s2">&quot;$project&quot;</span><span class="o">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="s2">&quot;cross_matches&quot;</span><span class="o">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="s2">&quot;$arrayElemAt&quot;</span><span class="o">:</span><span class="w"> </span><span class="p">[</span>
<span class="w">          </span><span class="s2">&quot;$aux.cross_matches&quot;</span><span class="p">,</span><span class="w"> </span><span class="mf">0</span>
<span class="w">        </span><span class="p">]</span>
<span class="w">      </span><span class="p">},</span>
<span class="w">      </span><span class="s2">&quot;prv_candidates&quot;</span><span class="o">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="s2">&quot;$filter&quot;</span><span class="o">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">          </span><span class="s2">&quot;input&quot;</span><span class="o">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="s2">&quot;$arrayElemAt&quot;</span><span class="o">:</span><span class="w"> </span><span class="p">[</span>
<span class="w">              </span><span class="s2">&quot;$aux.prv_candidates&quot;</span><span class="p">,</span><span class="w"> </span><span class="mf">0</span>
<span class="w">            </span><span class="p">]</span>
<span class="w">          </span><span class="p">},</span>
<span class="w">          </span><span class="s2">&quot;as&quot;</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;item&quot;</span><span class="p">,</span>
<span class="w">          </span><span class="s2">&quot;cond&quot;</span><span class="o">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="s2">&quot;$and&quot;</span><span class="o">:</span><span class="w"> </span><span class="p">[</span>
<span class="w">              </span><span class="p">{</span>
<span class="w">                </span><span class="s2">&quot;$in&quot;</span><span class="o">:</span><span class="w"> </span><span class="p">[</span>
<span class="w">                  </span><span class="s2">&quot;$$item.programid&quot;</span><span class="p">,</span><span class="w"> </span><span class="p">[</span>
<span class="w">                    </span><span class="mf">1</span><span class="p">,</span><span class="w"> </span><span class="mf">2</span><span class="p">,</span><span class="w"> </span><span class="mf">3</span>
<span class="w">                  </span><span class="p">]</span>
<span class="w">                </span><span class="p">]</span>
<span class="w">              </span><span class="p">},</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="s2">&quot;$lt&quot;</span><span class="o">:</span><span class="w"> </span><span class="p">[</span>
<span class="w">                  </span><span class="p">{</span>
<span class="w">                    </span><span class="s2">&quot;$subtract&quot;</span><span class="o">:</span><span class="w"> </span><span class="p">[</span>
<span class="w">                      </span><span class="s2">&quot;$candidate.jd&quot;</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;$$item.jd&quot;</span>
<span class="w">                    </span><span class="p">]</span>
<span class="w">                  </span><span class="p">},</span><span class="w"> </span><span class="mf">100</span>
<span class="w">                </span><span class="p">]</span>
<span class="w">              </span><span class="p">}</span>
<span class="w">            </span><span class="p">]</span>
<span class="w">          </span><span class="p">}</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">      </span><span class="p">},</span>
<span class="w">      </span><span class="s2">&quot;schemavsn&quot;</span><span class="o">:</span><span class="w"> </span><span class="mf">1</span><span class="p">,</span>
<span class="w">      </span><span class="s2">&quot;publisher&quot;</span><span class="o">:</span><span class="w"> </span><span class="mf">1</span><span class="p">,</span>
<span class="w">      </span><span class="s2">&quot;objectId&quot;</span><span class="o">:</span><span class="w"> </span><span class="mf">1</span><span class="p">,</span>
<span class="w">      </span><span class="s2">&quot;candid&quot;</span><span class="o">:</span><span class="w"> </span><span class="mf">1</span><span class="p">,</span>
<span class="w">      </span><span class="s2">&quot;candidate&quot;</span><span class="o">:</span><span class="w"> </span><span class="mf">1</span><span class="p">,</span>
<span class="w">      </span><span class="s2">&quot;classifications&quot;</span><span class="o">:</span><span class="w"> </span><span class="mf">1</span><span class="p">,</span>
<span class="w">      </span><span class="s2">&quot;coordinates&quot;</span><span class="o">:</span><span class="w"> </span><span class="mf">1</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">  </span><span class="p">},</span>
<span class="w">  </span><span class="p">{</span>
<span class="w">    </span><span class="s2">&quot;$match&quot;</span><span class="o">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="s2">&quot;candidate.magpsf&quot;</span><span class="o">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="s2">&quot;$lt&quot;</span><span class="o">:</span><span class="w"> </span><span class="mf">20</span>
<span class="w">      </span><span class="p">},</span>
<span class="w">      </span><span class="s2">&quot;candidate.isdiffpos&quot;</span><span class="o">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="s2">&quot;$in&quot;</span><span class="o">:</span><span class="w"> </span><span class="p">[</span>
<span class="w">          </span><span class="s2">&quot;1&quot;</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;t&quot;</span>
<span class="w">        </span><span class="p">]</span>
<span class="w">      </span><span class="p">},</span>
<span class="w">      </span><span class="s2">&quot;candidate.programid&quot;</span><span class="o">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="s2">&quot;$gt&quot;</span><span class="o">:</span><span class="w"> </span><span class="mf">0</span>
<span class="w">      </span><span class="p">},</span>
<span class="w">      </span><span class="s2">&quot;candidate.ssdistnr&quot;</span><span class="o">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="s2">&quot;$lt&quot;</span><span class="o">:</span><span class="w"> </span><span class="o">-</span><span class="mf">1</span>
<span class="w">      </span><span class="p">},</span>
<span class="w">      </span><span class="s2">&quot;candidate.drb&quot;</span><span class="o">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="s2">&quot;$gt&quot;</span><span class="o">:</span><span class="w"> </span><span class="mf">0.65</span>
<span class="w">      </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">  </span><span class="p">},</span>
<span class="w">  </span><span class="p">{</span>
<span class="w">    </span><span class="s2">&quot;$project&quot;</span><span class="o">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="s2">&quot;objectId&quot;</span><span class="o">:</span><span class="w"> </span><span class="mf">1</span><span class="p">,</span>
<span class="w">      </span><span class="s2">&quot;dist&quot;</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;$candidate.distpsnr1&quot;</span><span class="p">,</span>
<span class="w">      </span><span class="s2">&quot;sg&quot;</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;$candidate.sgscore1&quot;</span><span class="p">,</span>
<span class="w">      </span><span class="s2">&quot;rmag&quot;</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;$candidate.srmag1&quot;</span><span class="p">,</span>
<span class="w">      </span><span class="s2">&quot;gmag&quot;</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;$candidate.sgmag1&quot;</span><span class="p">,</span>
<span class="w">      </span><span class="s2">&quot;imag&quot;</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;$candidate.simag1&quot;</span><span class="p">,</span>
<span class="w">      </span><span class="s2">&quot;zmag&quot;</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;$candidate.szmag1&quot;</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">  </span><span class="p">},</span>
<span class="w">  </span><span class="p">{</span>
<span class="w">    </span><span class="s2">&quot;$project&quot;</span><span class="o">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="s2">&quot;_id&quot;</span><span class="o">:</span><span class="w"> </span><span class="mf">0</span><span class="p">,</span>
<span class="w">      </span><span class="s2">&quot;objectId&quot;</span><span class="o">:</span><span class="w"> </span><span class="mf">1</span><span class="p">,</span>
<span class="w">      </span><span class="s2">&quot;pointunderneath&quot;</span><span class="o">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="s2">&quot;$or&quot;</span><span class="o">:</span><span class="w"> </span><span class="p">[</span>
<span class="w">          </span><span class="p">{</span>
<span class="w">            </span><span class="s2">&quot;$and&quot;</span><span class="o">:</span><span class="w"> </span><span class="p">[</span>
<span class="w">              </span><span class="p">{</span>
<span class="w">                </span><span class="s2">&quot;$gt&quot;</span><span class="o">:</span><span class="w"> </span><span class="p">[</span>
<span class="w">                  </span><span class="s2">&quot;$dist&quot;</span><span class="p">,</span><span class="w"> </span><span class="mf">0</span>
<span class="w">                </span><span class="p">]</span>
<span class="w">              </span><span class="p">},</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="s2">&quot;$lt&quot;</span><span class="o">:</span><span class="w"> </span><span class="p">[</span>
<span class="w">                  </span><span class="s2">&quot;$dist&quot;</span><span class="p">,</span><span class="w"> </span><span class="mf">2</span>
<span class="w">                </span><span class="p">]</span>
<span class="w">              </span><span class="p">},</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="s2">&quot;$gt&quot;</span><span class="o">:</span><span class="w"> </span><span class="p">[</span>
<span class="w">                  </span><span class="s2">&quot;sg&quot;</span><span class="p">,</span><span class="w"> </span><span class="mf">0.76</span>
<span class="w">                </span><span class="p">]</span>
<span class="w">              </span><span class="p">}</span>
<span class="w">            </span><span class="p">]</span>
<span class="w">          </span><span class="p">},</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="s2">&quot;$and&quot;</span><span class="o">:</span><span class="w"> </span><span class="p">[</span>
<span class="w">              </span><span class="p">{</span>
<span class="w">                </span><span class="s2">&quot;$and&quot;</span><span class="o">:</span><span class="w"> </span><span class="p">[</span>
<span class="w">                  </span><span class="p">{</span>
<span class="w">                    </span><span class="s2">&quot;$gt&quot;</span><span class="o">:</span><span class="w"> </span><span class="p">[</span>
<span class="w">                      </span><span class="s2">&quot;$dist&quot;</span><span class="p">,</span><span class="w"> </span><span class="mf">0</span>
<span class="w">                    </span><span class="p">]</span>
<span class="w">                  </span><span class="p">},</span><span class="w"> </span><span class="p">{</span>
<span class="w">                    </span><span class="s2">&quot;$lt&quot;</span><span class="o">:</span><span class="w"> </span><span class="p">[</span>
<span class="w">                      </span><span class="s2">&quot;$dist&quot;</span><span class="p">,</span><span class="w"> </span><span class="mf">0.5</span>
<span class="w">                    </span><span class="p">]</span>
<span class="w">                  </span><span class="p">},</span><span class="w"> </span><span class="p">{</span>
<span class="w">                    </span><span class="s2">&quot;$eq&quot;</span><span class="o">:</span><span class="w"> </span><span class="p">[</span>
<span class="w">                      </span><span class="s2">&quot;sg&quot;</span><span class="p">,</span><span class="w"> </span><span class="mf">0.5</span>
<span class="w">                    </span><span class="p">]</span>
<span class="w">                  </span><span class="p">}</span>
<span class="w">                </span><span class="p">]</span>
<span class="w">              </span><span class="p">},</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="s2">&quot;$or&quot;</span><span class="o">:</span><span class="w"> </span><span class="p">[</span>
<span class="w">                  </span><span class="p">{</span>
<span class="w">                    </span><span class="s2">&quot;$and&quot;</span><span class="o">:</span><span class="w"> </span><span class="p">[</span>
<span class="w">                      </span><span class="p">{</span>
<span class="w">                        </span><span class="s2">&quot;$gt&quot;</span><span class="o">:</span><span class="w"> </span><span class="p">[</span>
<span class="w">                          </span><span class="s2">&quot;$rmag&quot;</span><span class="p">,</span><span class="w"> </span><span class="mf">0</span>
<span class="w">                        </span><span class="p">]</span>
<span class="w">                      </span><span class="p">},</span><span class="w"> </span><span class="p">{</span>
<span class="w">                        </span><span class="s2">&quot;$lt&quot;</span><span class="o">:</span><span class="w"> </span><span class="p">[</span>
<span class="w">                          </span><span class="s2">&quot;$rmag&quot;</span><span class="p">,</span><span class="w"> </span><span class="mf">17</span>
<span class="w">                        </span><span class="p">]</span>
<span class="w">                      </span><span class="p">}</span>
<span class="w">                    </span><span class="p">]</span>
<span class="w">                  </span><span class="p">},</span><span class="w"> </span><span class="p">{</span>
<span class="w">                    </span><span class="s2">&quot;$and&quot;</span><span class="o">:</span><span class="w"> </span><span class="p">[</span>
<span class="w">                      </span><span class="p">{</span>
<span class="w">                        </span><span class="s2">&quot;$gt&quot;</span><span class="o">:</span><span class="w"> </span><span class="p">[</span>
<span class="w">                          </span><span class="s2">&quot;$gmag&quot;</span><span class="p">,</span><span class="w"> </span><span class="mf">0</span>
<span class="w">                        </span><span class="p">]</span>
<span class="w">                      </span><span class="p">},</span><span class="w"> </span><span class="p">{</span>
<span class="w">                        </span><span class="s2">&quot;$lt&quot;</span><span class="o">:</span><span class="w"> </span><span class="p">[</span>
<span class="w">                          </span><span class="s2">&quot;$gmag&quot;</span><span class="p">,</span><span class="w"> </span><span class="mf">17</span>
<span class="w">                        </span><span class="p">]</span>
<span class="w">                      </span><span class="p">}</span>
<span class="w">                    </span><span class="p">]</span>
<span class="w">                  </span><span class="p">},</span><span class="w"> </span><span class="p">{</span>
<span class="w">                    </span><span class="s2">&quot;$and&quot;</span><span class="o">:</span><span class="w"> </span><span class="p">[</span>
<span class="w">                      </span><span class="p">{</span>
<span class="w">                        </span><span class="s2">&quot;$gt&quot;</span><span class="o">:</span><span class="w"> </span><span class="p">[</span>
<span class="w">                          </span><span class="s2">&quot;$imag&quot;</span><span class="p">,</span><span class="w"> </span><span class="mf">0</span>
<span class="w">                        </span><span class="p">]</span>
<span class="w">                      </span><span class="p">},</span><span class="w"> </span><span class="p">{</span>
<span class="w">                        </span><span class="s2">&quot;$lt&quot;</span><span class="o">:</span><span class="w"> </span><span class="p">[</span>
<span class="w">                          </span><span class="s2">&quot;$imag&quot;</span><span class="p">,</span><span class="w"> </span><span class="mf">17</span>
<span class="w">                        </span><span class="p">]</span>
<span class="w">                      </span><span class="p">}</span>
<span class="w">                    </span><span class="p">]</span>
<span class="w">                  </span><span class="p">},</span><span class="w"> </span><span class="p">{</span>
<span class="w">                    </span><span class="s2">&quot;$and&quot;</span><span class="o">:</span><span class="w"> </span><span class="p">[</span>
<span class="w">                      </span><span class="p">{</span>
<span class="w">                        </span><span class="s2">&quot;$gt&quot;</span><span class="o">:</span><span class="w"> </span><span class="p">[</span>
<span class="w">                          </span><span class="s2">&quot;$zmag&quot;</span><span class="p">,</span><span class="w"> </span><span class="mf">0</span>
<span class="w">                        </span><span class="p">]</span>
<span class="w">                      </span><span class="p">},</span><span class="w"> </span><span class="p">{</span>
<span class="w">                        </span><span class="s2">&quot;$lt&quot;</span><span class="o">:</span><span class="w"> </span><span class="p">[</span>
<span class="w">                          </span><span class="s2">&quot;$zmag&quot;</span><span class="p">,</span><span class="w"> </span><span class="mf">17</span>
<span class="w">                        </span><span class="p">]</span>
<span class="w">                      </span><span class="p">}</span>
<span class="w">                    </span><span class="p">]</span>
<span class="w">                  </span><span class="p">}</span>
<span class="w">                </span><span class="p">]</span>
<span class="w">              </span><span class="p">}</span>
<span class="w">            </span><span class="p">]</span>
<span class="w">          </span><span class="p">},</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="s2">&quot;$or&quot;</span><span class="o">:</span><span class="w"> </span><span class="p">[</span>
<span class="w">              </span><span class="p">{</span>
<span class="w">                </span><span class="s2">&quot;$and&quot;</span><span class="o">:</span><span class="w"> </span><span class="p">[</span>
<span class="w">                  </span><span class="p">{</span>
<span class="w">                    </span><span class="s2">&quot;$gt&quot;</span><span class="o">:</span><span class="w"> </span><span class="p">[</span>
<span class="w">                      </span><span class="s2">&quot;$rmag&quot;</span><span class="p">,</span><span class="w"> </span><span class="mf">0</span>
<span class="w">                    </span><span class="p">]</span>
<span class="w">                  </span><span class="p">},</span><span class="w"> </span><span class="p">{</span>
<span class="w">                    </span><span class="s2">&quot;$lt&quot;</span><span class="o">:</span><span class="w"> </span><span class="p">[</span>
<span class="w">                      </span><span class="s2">&quot;$rmag&quot;</span><span class="p">,</span><span class="w"> </span><span class="mf">12</span>
<span class="w">                    </span><span class="p">]</span>
<span class="w">                  </span><span class="p">},</span><span class="w"> </span><span class="p">{</span>
<span class="w">                    </span><span class="s2">&quot;$gt&quot;</span><span class="o">:</span><span class="w"> </span><span class="p">[</span>
<span class="w">                      </span><span class="s2">&quot;sg&quot;</span><span class="p">,</span><span class="w"> </span><span class="mf">0.49</span>
<span class="w">                    </span><span class="p">]</span>
<span class="w">                  </span><span class="p">},</span><span class="w"> </span><span class="p">{</span>
<span class="w">                    </span><span class="s2">&quot;$lt&quot;</span><span class="o">:</span><span class="w"> </span><span class="p">[</span>
<span class="w">                      </span><span class="s2">&quot;$dist&quot;</span><span class="p">,</span><span class="w"> </span><span class="mf">20</span>
<span class="w">                    </span><span class="p">]</span>
<span class="w">                  </span><span class="p">}</span>
<span class="w">                </span><span class="p">]</span>
<span class="w">              </span><span class="p">},</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="s2">&quot;$and&quot;</span><span class="o">:</span><span class="w"> </span><span class="p">[</span>
<span class="w">                  </span><span class="p">{</span>
<span class="w">                    </span><span class="s2">&quot;$gt&quot;</span><span class="o">:</span><span class="w"> </span><span class="p">[</span>
<span class="w">                      </span><span class="s2">&quot;$rmag&quot;</span><span class="p">,</span><span class="w"> </span><span class="mf">0</span>
<span class="w">                    </span><span class="p">]</span>
<span class="w">                  </span><span class="p">},</span><span class="w"> </span><span class="p">{</span>
<span class="w">                    </span><span class="s2">&quot;$lt&quot;</span><span class="o">:</span><span class="w"> </span><span class="p">[</span>
<span class="w">                      </span><span class="s2">&quot;$rmag&quot;</span><span class="p">,</span><span class="w"> </span><span class="mf">15</span>
<span class="w">                    </span><span class="p">]</span>
<span class="w">                  </span><span class="p">},</span><span class="w"> </span><span class="p">{</span>
<span class="w">                    </span><span class="s2">&quot;$gt&quot;</span><span class="o">:</span><span class="w"> </span><span class="p">[</span>
<span class="w">                      </span><span class="s2">&quot;sg&quot;</span><span class="p">,</span><span class="w"> </span><span class="mf">0.49</span>
<span class="w">                    </span><span class="p">]</span>
<span class="w">                  </span><span class="p">},</span><span class="w"> </span><span class="p">{</span>
<span class="w">                    </span><span class="s2">&quot;$lt&quot;</span><span class="o">:</span><span class="w"> </span><span class="p">[</span>
<span class="w">                      </span><span class="s2">&quot;$dist&quot;</span><span class="p">,</span><span class="w"> </span><span class="mf">5</span>
<span class="w">                    </span><span class="p">]</span>
<span class="w">                  </span><span class="p">}</span>
<span class="w">                </span><span class="p">]</span>
<span class="w">              </span><span class="p">},</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="s2">&quot;$and&quot;</span><span class="o">:</span><span class="w"> </span><span class="p">[</span>
<span class="w">                  </span><span class="p">{</span>
<span class="w">                    </span><span class="s2">&quot;$gt&quot;</span><span class="o">:</span><span class="w"> </span><span class="p">[</span>
<span class="w">                      </span><span class="s2">&quot;$rmag&quot;</span><span class="p">,</span><span class="w"> </span><span class="mf">0</span>
<span class="w">                    </span><span class="p">]</span>
<span class="w">                  </span><span class="p">},</span><span class="w"> </span><span class="p">{</span>
<span class="w">                    </span><span class="s2">&quot;$lt&quot;</span><span class="o">:</span><span class="w"> </span><span class="p">[</span>
<span class="w">                      </span><span class="s2">&quot;$rmag&quot;</span><span class="p">,</span><span class="w"> </span><span class="mf">15</span>
<span class="w">                    </span><span class="p">]</span>
<span class="w">                  </span><span class="p">},</span><span class="w"> </span><span class="p">{</span>
<span class="w">                    </span><span class="s2">&quot;$gt&quot;</span><span class="o">:</span><span class="w"> </span><span class="p">[</span>
<span class="w">                      </span><span class="s2">&quot;sg&quot;</span><span class="p">,</span><span class="w"> </span><span class="mf">0.8</span>
<span class="w">                    </span><span class="p">]</span>
<span class="w">                  </span><span class="p">},</span><span class="w"> </span><span class="p">{</span>
<span class="w">                    </span><span class="s2">&quot;$lt&quot;</span><span class="o">:</span><span class="w"> </span><span class="p">[</span>
<span class="w">                      </span><span class="s2">&quot;$dist&quot;</span><span class="p">,</span><span class="w"> </span><span class="mf">20</span>
<span class="w">                    </span><span class="p">]</span>
<span class="w">                  </span><span class="p">}</span>
<span class="w">                </span><span class="p">]</span>
<span class="w">              </span><span class="p">},</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="s2">&quot;$and&quot;</span><span class="o">:</span><span class="w"> </span><span class="p">[</span>
<span class="w">                  </span><span class="p">{</span>
<span class="w">                    </span><span class="s2">&quot;$gt&quot;</span><span class="o">:</span><span class="w"> </span><span class="p">[</span>
<span class="w">                      </span><span class="s2">&quot;$gmag&quot;</span><span class="p">,</span><span class="w"> </span><span class="mf">0</span>
<span class="w">                    </span><span class="p">]</span>
<span class="w">                  </span><span class="p">},</span><span class="w"> </span><span class="p">{</span>
<span class="w">                    </span><span class="s2">&quot;$lt&quot;</span><span class="o">:</span><span class="w"> </span><span class="p">[</span>
<span class="w">                      </span><span class="s2">&quot;$gmag&quot;</span><span class="p">,</span><span class="w"> </span><span class="mf">12</span>
<span class="w">                    </span><span class="p">]</span>
<span class="w">                  </span><span class="p">},</span><span class="w"> </span><span class="p">{</span>
<span class="w">                    </span><span class="s2">&quot;$gt&quot;</span><span class="o">:</span><span class="w"> </span><span class="p">[</span>
<span class="w">                      </span><span class="s2">&quot;sg&quot;</span><span class="p">,</span><span class="w"> </span><span class="mf">0.49</span>
<span class="w">                    </span><span class="p">]</span>
<span class="w">                  </span><span class="p">},</span><span class="w"> </span><span class="p">{</span>
<span class="w">                    </span><span class="s2">&quot;$lt&quot;</span><span class="o">:</span><span class="w"> </span><span class="p">[</span>
<span class="w">                      </span><span class="s2">&quot;$dist&quot;</span><span class="p">,</span><span class="w"> </span><span class="mf">20</span>
<span class="w">                    </span><span class="p">]</span>
<span class="w">                  </span><span class="p">}</span>
<span class="w">                </span><span class="p">]</span>
<span class="w">              </span><span class="p">},</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="s2">&quot;$and&quot;</span><span class="o">:</span><span class="w"> </span><span class="p">[</span>
<span class="w">                  </span><span class="p">{</span>
<span class="w">                    </span><span class="s2">&quot;$gt&quot;</span><span class="o">:</span><span class="w"> </span><span class="p">[</span>
<span class="w">                      </span><span class="s2">&quot;$gmag&quot;</span><span class="p">,</span><span class="w"> </span><span class="mf">0</span>
<span class="w">                    </span><span class="p">]</span>
<span class="w">                  </span><span class="p">},</span><span class="w"> </span><span class="p">{</span>
<span class="w">                    </span><span class="s2">&quot;$lt&quot;</span><span class="o">:</span><span class="w"> </span><span class="p">[</span>
<span class="w">                      </span><span class="s2">&quot;$gmag&quot;</span><span class="p">,</span><span class="w"> </span><span class="mf">12</span>
<span class="w">                    </span><span class="p">]</span>
<span class="w">                  </span><span class="p">},</span><span class="w"> </span><span class="p">{</span>
<span class="w">                    </span><span class="s2">&quot;$gt&quot;</span><span class="o">:</span><span class="w"> </span><span class="p">[</span>
<span class="w">                      </span><span class="s2">&quot;sg&quot;</span><span class="p">,</span><span class="w"> </span><span class="mf">0.8</span>
<span class="w">                    </span><span class="p">]</span>
<span class="w">                  </span><span class="p">},</span><span class="w"> </span><span class="p">{</span>
<span class="w">                    </span><span class="s2">&quot;$lt&quot;</span><span class="o">:</span><span class="w"> </span><span class="p">[</span>
<span class="w">                      </span><span class="s2">&quot;$dist&quot;</span><span class="p">,</span><span class="w"> </span><span class="mf">20</span>
<span class="w">                    </span><span class="p">]</span>
<span class="w">                  </span><span class="p">}</span>
<span class="w">                </span><span class="p">]</span>
<span class="w">              </span><span class="p">},</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="s2">&quot;$and&quot;</span><span class="o">:</span><span class="w"> </span><span class="p">[</span>
<span class="w">                  </span><span class="p">{</span>
<span class="w">                    </span><span class="s2">&quot;$gt&quot;</span><span class="o">:</span><span class="w"> </span><span class="p">[</span>
<span class="w">                      </span><span class="s2">&quot;$imag&quot;</span><span class="p">,</span><span class="w"> </span><span class="mf">0</span>
<span class="w">                    </span><span class="p">]</span>
<span class="w">                  </span><span class="p">},</span><span class="w"> </span><span class="p">{</span>
<span class="w">                    </span><span class="s2">&quot;$lt&quot;</span><span class="o">:</span><span class="w"> </span><span class="p">[</span>
<span class="w">                      </span><span class="s2">&quot;$imag&quot;</span><span class="p">,</span><span class="w"> </span><span class="mf">12</span>
<span class="w">                    </span><span class="p">]</span>
<span class="w">                  </span><span class="p">},</span><span class="w"> </span><span class="p">{</span>
<span class="w">                    </span><span class="s2">&quot;$gt&quot;</span><span class="o">:</span><span class="w"> </span><span class="p">[</span>
<span class="w">                      </span><span class="s2">&quot;sg&quot;</span><span class="p">,</span><span class="w"> </span><span class="mf">0.49</span>
<span class="w">                    </span><span class="p">]</span>
<span class="w">                  </span><span class="p">},</span><span class="w"> </span><span class="p">{</span>
<span class="w">                    </span><span class="s2">&quot;$lt&quot;</span><span class="o">:</span><span class="w"> </span><span class="p">[</span>
<span class="w">                      </span><span class="s2">&quot;$dist&quot;</span><span class="p">,</span><span class="w"> </span><span class="mf">20</span>
<span class="w">                    </span><span class="p">]</span>
<span class="w">                  </span><span class="p">}</span>
<span class="w">                </span><span class="p">]</span>
<span class="w">              </span><span class="p">},</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="s2">&quot;$and&quot;</span><span class="o">:</span><span class="w"> </span><span class="p">[</span>
<span class="w">                  </span><span class="p">{</span>
<span class="w">                    </span><span class="s2">&quot;$gt&quot;</span><span class="o">:</span><span class="w"> </span><span class="p">[</span>
<span class="w">                      </span><span class="s2">&quot;$imag&quot;</span><span class="p">,</span><span class="w"> </span><span class="mf">0</span>
<span class="w">                    </span><span class="p">]</span>
<span class="w">                  </span><span class="p">},</span><span class="w"> </span><span class="p">{</span>
<span class="w">                    </span><span class="s2">&quot;$lt&quot;</span><span class="o">:</span><span class="w"> </span><span class="p">[</span>
<span class="w">                      </span><span class="s2">&quot;$imag&quot;</span><span class="p">,</span><span class="w"> </span><span class="mf">14.5</span>
<span class="w">                    </span><span class="p">]</span>
<span class="w">                  </span><span class="p">},</span><span class="w"> </span><span class="p">{</span>
<span class="w">                    </span><span class="s2">&quot;$gt&quot;</span><span class="o">:</span><span class="w"> </span><span class="p">[</span>
<span class="w">                      </span><span class="s2">&quot;sg&quot;</span><span class="p">,</span><span class="w"> </span><span class="mf">0.49</span>
<span class="w">                    </span><span class="p">]</span>
<span class="w">                  </span><span class="p">},</span><span class="w"> </span><span class="p">{</span>
<span class="w">                    </span><span class="s2">&quot;$lt&quot;</span><span class="o">:</span><span class="w"> </span><span class="p">[</span>
<span class="w">                      </span><span class="s2">&quot;$dist&quot;</span><span class="p">,</span><span class="w"> </span><span class="mf">5</span>
<span class="w">                    </span><span class="p">]</span>
<span class="w">                  </span><span class="p">}</span>
<span class="w">                </span><span class="p">]</span>
<span class="w">              </span><span class="p">},</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="s2">&quot;$and&quot;</span><span class="o">:</span><span class="w"> </span><span class="p">[</span>
<span class="w">                  </span><span class="p">{</span>
<span class="w">                    </span><span class="s2">&quot;$gt&quot;</span><span class="o">:</span><span class="w"> </span><span class="p">[</span>
<span class="w">                      </span><span class="s2">&quot;$imag&quot;</span><span class="p">,</span><span class="w"> </span><span class="mf">0</span>
<span class="w">                    </span><span class="p">]</span>
<span class="w">                  </span><span class="p">},</span><span class="w"> </span><span class="p">{</span>
<span class="w">                    </span><span class="s2">&quot;$lt&quot;</span><span class="o">:</span><span class="w"> </span><span class="p">[</span>
<span class="w">                      </span><span class="s2">&quot;$imag&quot;</span><span class="p">,</span><span class="w"> </span><span class="mf">15</span>
<span class="w">                    </span><span class="p">]</span>
<span class="w">                  </span><span class="p">},</span><span class="w"> </span><span class="p">{</span>
<span class="w">                    </span><span class="s2">&quot;$gt&quot;</span><span class="o">:</span><span class="w"> </span><span class="p">[</span>
<span class="w">                      </span><span class="s2">&quot;sg&quot;</span><span class="p">,</span><span class="w"> </span><span class="mf">0.8</span>
<span class="w">                    </span><span class="p">]</span>
<span class="w">                  </span><span class="p">},</span><span class="w"> </span><span class="p">{</span>
<span class="w">                    </span><span class="s2">&quot;$lt&quot;</span><span class="o">:</span><span class="w"> </span><span class="p">[</span>
<span class="w">                      </span><span class="s2">&quot;$dist&quot;</span><span class="p">,</span><span class="w"> </span><span class="mf">20</span>
<span class="w">                    </span><span class="p">]</span>
<span class="w">                  </span><span class="p">}</span>
<span class="w">                </span><span class="p">]</span>
<span class="w">              </span><span class="p">},</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="s2">&quot;$and&quot;</span><span class="o">:</span><span class="w"> </span><span class="p">[</span>
<span class="w">                  </span><span class="p">{</span>
<span class="w">                    </span><span class="s2">&quot;$gt&quot;</span><span class="o">:</span><span class="w"> </span><span class="p">[</span>
<span class="w">                      </span><span class="s2">&quot;$zmag&quot;</span><span class="p">,</span><span class="w"> </span><span class="mf">0</span>
<span class="w">                    </span><span class="p">]</span>
<span class="w">                  </span><span class="p">},</span><span class="w"> </span><span class="p">{</span>
<span class="w">                    </span><span class="s2">&quot;$lt&quot;</span><span class="o">:</span><span class="w"> </span><span class="p">[</span>
<span class="w">                      </span><span class="s2">&quot;$zmag&quot;</span><span class="p">,</span><span class="w"> </span><span class="mf">11.5</span>
<span class="w">                    </span><span class="p">]</span>
<span class="w">                  </span><span class="p">},</span><span class="w"> </span><span class="p">{</span>
<span class="w">                    </span><span class="s2">&quot;$gt&quot;</span><span class="o">:</span><span class="w"> </span><span class="p">[</span>
<span class="w">                      </span><span class="s2">&quot;sg&quot;</span><span class="p">,</span><span class="w"> </span><span class="mf">0.49</span>
<span class="w">                    </span><span class="p">]</span>
<span class="w">                  </span><span class="p">},</span><span class="w"> </span><span class="p">{</span>
<span class="w">                    </span><span class="s2">&quot;$lt&quot;</span><span class="o">:</span><span class="w"> </span><span class="p">[</span>
<span class="w">                      </span><span class="s2">&quot;$dist&quot;</span><span class="p">,</span><span class="w"> </span><span class="mf">10</span>
<span class="w">                    </span><span class="p">]</span>
<span class="w">                  </span><span class="p">}</span>
<span class="w">                </span><span class="p">]</span>
<span class="w">              </span><span class="p">},</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="s2">&quot;$and&quot;</span><span class="o">:</span><span class="w"> </span><span class="p">[</span>
<span class="w">                  </span><span class="p">{</span>
<span class="w">                    </span><span class="s2">&quot;$gt&quot;</span><span class="o">:</span><span class="w"> </span><span class="p">[</span>
<span class="w">                      </span><span class="s2">&quot;$zmag&quot;</span><span class="p">,</span><span class="w"> </span><span class="mf">0</span>
<span class="w">                    </span><span class="p">]</span>
<span class="w">                  </span><span class="p">},</span><span class="w"> </span><span class="p">{</span>
<span class="w">                    </span><span class="s2">&quot;$lt&quot;</span><span class="o">:</span><span class="w"> </span><span class="p">[</span>
<span class="w">                      </span><span class="s2">&quot;$zmag&quot;</span><span class="p">,</span><span class="w"> </span><span class="mf">14</span>
<span class="w">                    </span><span class="p">]</span>
<span class="w">                  </span><span class="p">},</span><span class="w"> </span><span class="p">{</span>
<span class="w">                    </span><span class="s2">&quot;$gt&quot;</span><span class="o">:</span><span class="w"> </span><span class="p">[</span>
<span class="w">                      </span><span class="s2">&quot;sg&quot;</span><span class="p">,</span><span class="w"> </span><span class="mf">0.49</span>
<span class="w">                    </span><span class="p">]</span>
<span class="w">                  </span><span class="p">},</span><span class="w"> </span><span class="p">{</span>
<span class="w">                    </span><span class="s2">&quot;$lt&quot;</span><span class="o">:</span><span class="w"> </span><span class="p">[</span>
<span class="w">                      </span><span class="s2">&quot;$dist&quot;</span><span class="p">,</span><span class="w"> </span><span class="mf">2.5</span>
<span class="w">                    </span><span class="p">]</span>
<span class="w">                  </span><span class="p">}</span>
<span class="w">                </span><span class="p">]</span>
<span class="w">              </span><span class="p">},</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="s2">&quot;$and&quot;</span><span class="o">:</span><span class="w"> </span><span class="p">[</span>
<span class="w">                  </span><span class="p">{</span>
<span class="w">                    </span><span class="s2">&quot;$gt&quot;</span><span class="o">:</span><span class="w"> </span><span class="p">[</span>
<span class="w">                      </span><span class="s2">&quot;$zmag&quot;</span><span class="p">,</span><span class="w"> </span><span class="mf">0</span>
<span class="w">                    </span><span class="p">]</span>
<span class="w">                  </span><span class="p">},</span><span class="w"> </span><span class="p">{</span>
<span class="w">                    </span><span class="s2">&quot;$lt&quot;</span><span class="o">:</span><span class="w"> </span><span class="p">[</span>
<span class="w">                      </span><span class="s2">&quot;$zmag&quot;</span><span class="p">,</span><span class="w"> </span><span class="mf">15</span>
<span class="w">                    </span><span class="p">]</span>
<span class="w">                  </span><span class="p">},</span><span class="w"> </span><span class="p">{</span>
<span class="w">                    </span><span class="s2">&quot;$gt&quot;</span><span class="o">:</span><span class="w"> </span><span class="p">[</span>
<span class="w">                      </span><span class="s2">&quot;sg&quot;</span><span class="p">,</span><span class="w"> </span><span class="mf">0.8</span>
<span class="w">                    </span><span class="p">]</span>
<span class="w">                  </span><span class="p">},</span><span class="w"> </span><span class="p">{</span>
<span class="w">                    </span><span class="s2">&quot;$lt&quot;</span><span class="o">:</span><span class="w"> </span><span class="p">[</span>
<span class="w">                      </span><span class="s2">&quot;$dist&quot;</span><span class="p">,</span><span class="w"> </span><span class="mf">20</span>
<span class="w">                    </span><span class="p">]</span>
<span class="w">                  </span><span class="p">}</span>
<span class="w">                </span><span class="p">]</span>
<span class="w">              </span><span class="p">}</span>
<span class="w">            </span><span class="p">]</span>
<span class="w">          </span><span class="p">}</span>
<span class="w">        </span><span class="p">]</span>
<span class="w">      </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">  </span><span class="p">},</span>
<span class="w">  </span><span class="p">{</span>
<span class="w">    </span><span class="s2">&quot;$match&quot;</span><span class="o">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="s2">&quot;pointunderneath&quot;</span><span class="o">:</span><span class="w"> </span><span class="kc">false</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">  </span><span class="p">},</span>
<span class="w">  </span><span class="p">{</span>
<span class="w">    </span><span class="s2">&quot;$project&quot;</span><span class="o">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="s2">&quot;candid&quot;</span><span class="o">:</span><span class="w"> </span><span class="mf">1</span><span class="p">,</span>
<span class="w">      </span><span class="s2">&quot;objectId&quot;</span><span class="o">:</span><span class="w"> </span><span class="mf">1</span><span class="p">,</span>
<span class="w">      </span><span class="s2">&quot;annotations.comment&quot;</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;fast!&quot;</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">]</span>
</pre></div>
</div>
</section>
</section>
<section id="watch-lists">
<h3>Watch lists<a class="headerlink" href="#watch-lists" title="Link to this heading">¶</a></h3>
<p>Fritz’s alert stream filters allow implementing watch lists for sets of objects of interest.</p>
<p>In the example below, we define two named sky positions of interest. The coordinates are given in degrees.
Any alert from an object within 2 arcseconds from these positions will pass this filter.</p>
<p><a class="reference download internal" download="" href="_downloads/30e2bb4ca9b8170a083c4fdc699b10cc/watchlist.json"><code class="xref download docutils literal notranslate"><span class="pre">watchlist.json</span></code></a></p>
<div class="highlight-js notranslate"><div class="highlight"><pre><span></span><span class="p">[</span>
<span class="w">  </span><span class="c1">// This is the only stage you would need to modify to set up your own watch list:</span>
<span class="w">  </span><span class="p">{</span>
<span class="w">    </span><span class="s2">&quot;$project&quot;</span><span class="o">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="s2">&quot;_id&quot;</span><span class="o">:</span><span class="w"> </span><span class="mf">0</span><span class="p">,</span>
<span class="w">      </span><span class="s2">&quot;watchlist&quot;</span><span class="o">:</span><span class="w"> </span><span class="p">[</span>
<span class="w">        </span><span class="p">{</span>
<span class="w">          </span><span class="s2">&quot;name&quot;</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;my_favorite_spot&quot;</span><span class="p">,</span>
<span class="w">          </span><span class="s2">&quot;ra&quot;</span><span class="o">:</span><span class="w"> </span><span class="mf">134.0779551</span><span class="p">,</span>
<span class="w">          </span><span class="s2">&quot;dec&quot;</span><span class="o">:</span><span class="w"> </span><span class="o">-</span><span class="mf">0.4421303</span>
<span class="w">        </span><span class="p">},</span>
<span class="w">        </span><span class="p">{</span>
<span class="w">          </span><span class="s2">&quot;name&quot;</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;my_star&quot;</span><span class="p">,</span>
<span class="w">          </span><span class="s2">&quot;ra&quot;</span><span class="o">:</span><span class="w"> </span><span class="mf">14.5551</span><span class="p">,</span>
<span class="w">          </span><span class="s2">&quot;dec&quot;</span><span class="o">:</span><span class="w"> </span><span class="mf">37.4451303</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">      </span><span class="p">],</span>
<span class="w">      </span><span class="s2">&quot;max_distance_arcsec&quot;</span><span class="o">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="s2">&quot;$literal&quot;</span><span class="o">:</span><span class="w"> </span><span class="mf">2.0</span>
<span class="w">      </span><span class="p">},</span>
<span class="w">      </span><span class="s2">&quot;ra&quot;</span><span class="o">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="s2">&quot;$degreesToRadians&quot;</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;$candidate.ra&quot;</span>
<span class="w">      </span><span class="p">},</span>
<span class="w">      </span><span class="s2">&quot;dec&quot;</span><span class="o">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="s2">&quot;$degreesToRadians&quot;</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;$candidate.dec&quot;</span>
<span class="w">      </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">  </span><span class="p">},</span>
<span class="w">  </span><span class="c1">// In this stage, we prepare the quantities that will be needed for the spherical distance computations</span>
<span class="w">  </span><span class="p">{</span>
<span class="w">    </span><span class="s2">&quot;$project&quot;</span><span class="o">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="s2">&quot;watchlist&quot;</span><span class="o">:</span><span class="w"> </span><span class="mf">1</span><span class="p">,</span>
<span class="w">      </span><span class="s2">&quot;max_distance_arcsec&quot;</span><span class="o">:</span><span class="w"> </span><span class="mf">1</span><span class="p">,</span>
<span class="w">      </span><span class="s2">&quot;dec&quot;</span><span class="o">:</span><span class="w"> </span><span class="mf">1</span><span class="p">,</span>
<span class="w">      </span><span class="s2">&quot;dra_dec&quot;</span><span class="o">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="s2">&quot;$zip&quot;</span><span class="o">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">          </span><span class="s2">&quot;inputs&quot;</span><span class="o">:</span><span class="w"> </span><span class="p">[</span>
<span class="w">            </span><span class="p">{</span>
<span class="w">              </span><span class="s2">&quot;$map&quot;</span><span class="o">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="s2">&quot;input&quot;</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;$watchlist&quot;</span><span class="p">,</span>
<span class="w">                </span><span class="s2">&quot;as&quot;</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;object&quot;</span><span class="p">,</span>
<span class="w">                </span><span class="s2">&quot;in&quot;</span><span class="o">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">                  </span><span class="s2">&quot;$subtract&quot;</span><span class="o">:</span><span class="w"> </span><span class="p">[</span>
<span class="w">                    </span><span class="s2">&quot;$ra&quot;</span><span class="p">,</span><span class="w"> </span><span class="p">{</span>
<span class="w">                      </span><span class="s2">&quot;$degreesToRadians&quot;</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;$$object.ra&quot;</span>
<span class="w">                    </span><span class="p">}</span>
<span class="w">                  </span><span class="p">]</span>
<span class="w">                </span><span class="p">}</span>
<span class="w">              </span><span class="p">}</span>
<span class="w">            </span><span class="p">},</span><span class="w"> </span><span class="p">{</span>
<span class="w">              </span><span class="s2">&quot;$map&quot;</span><span class="o">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="s2">&quot;input&quot;</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;$watchlist&quot;</span><span class="p">,</span>
<span class="w">                </span><span class="s2">&quot;as&quot;</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;object&quot;</span><span class="p">,</span>
<span class="w">                </span><span class="s2">&quot;in&quot;</span><span class="o">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">                  </span><span class="s2">&quot;$degreesToRadians&quot;</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;$$object.dec&quot;</span>
<span class="w">                </span><span class="p">}</span>
<span class="w">              </span><span class="p">}</span>
<span class="w">            </span><span class="p">}</span>
<span class="w">          </span><span class="p">]</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">      </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">  </span><span class="p">},</span>
<span class="w">  </span><span class="c1">// In this stage, we perform an accurate spherical distance computation</span>
<span class="w">  </span><span class="c1">// for all objects in the watch list and convert the results to arcseconds:</span>
<span class="w">  </span><span class="p">{</span>
<span class="w">    </span><span class="s2">&quot;$project&quot;</span><span class="o">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="s2">&quot;watchlist&quot;</span><span class="o">:</span><span class="w"> </span><span class="mf">1</span><span class="p">,</span>
<span class="w">      </span><span class="s2">&quot;max_distance_arcsec&quot;</span><span class="o">:</span><span class="w"> </span><span class="mf">1</span><span class="p">,</span>
<span class="w">      </span><span class="s2">&quot;distances_arcsec&quot;</span><span class="o">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="s2">&quot;$map&quot;</span><span class="o">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">          </span><span class="s2">&quot;input&quot;</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;$dra_dec&quot;</span><span class="p">,</span>
<span class="w">          </span><span class="s2">&quot;as&quot;</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;s&quot;</span><span class="p">,</span>
<span class="w">          </span><span class="s2">&quot;in&quot;</span><span class="o">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="s2">&quot;$multiply&quot;</span><span class="o">:</span><span class="w"> </span><span class="p">[</span>
<span class="w">              </span><span class="mf">3600.0</span><span class="p">,</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="s2">&quot;$radiansToDegrees&quot;</span><span class="o">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">                  </span><span class="s2">&quot;$atan2&quot;</span><span class="o">:</span><span class="w"> </span><span class="p">[</span>
<span class="w">                    </span><span class="p">{</span>
<span class="w">                      </span><span class="s2">&quot;$sqrt&quot;</span><span class="o">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">                        </span><span class="s2">&quot;$add&quot;</span><span class="o">:</span><span class="w"> </span><span class="p">[</span>
<span class="w">                          </span><span class="p">{</span>
<span class="w">                            </span><span class="s2">&quot;$pow&quot;</span><span class="o">:</span><span class="w"> </span><span class="p">[</span>
<span class="w">                              </span><span class="p">{</span>
<span class="w">                                </span><span class="s2">&quot;$multiply&quot;</span><span class="o">:</span><span class="w"> </span><span class="p">[</span>
<span class="w">                                  </span><span class="p">{</span>
<span class="w">                                    </span><span class="s2">&quot;$cos&quot;</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;$dec&quot;</span>
<span class="w">                                  </span><span class="p">},</span><span class="w"> </span><span class="p">{</span>
<span class="w">                                    </span><span class="s2">&quot;$sin&quot;</span><span class="o">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">                                      </span><span class="s2">&quot;$arrayElemAt&quot;</span><span class="o">:</span><span class="w"> </span><span class="p">[</span>
<span class="w">                                        </span><span class="s2">&quot;$$s&quot;</span><span class="p">,</span><span class="w"> </span><span class="mf">0</span>
<span class="w">                                      </span><span class="p">]</span>
<span class="w">                                    </span><span class="p">}</span>
<span class="w">                                  </span><span class="p">}</span>
<span class="w">                                </span><span class="p">]</span>
<span class="w">                              </span><span class="p">},</span><span class="w"> </span><span class="mf">2</span>
<span class="w">                            </span><span class="p">]</span>
<span class="w">                          </span><span class="p">},</span><span class="w"> </span><span class="p">{</span>
<span class="w">                            </span><span class="s2">&quot;$pow&quot;</span><span class="o">:</span><span class="w"> </span><span class="p">[</span>
<span class="w">                              </span><span class="p">{</span>
<span class="w">                                </span><span class="s2">&quot;$subtract&quot;</span><span class="o">:</span><span class="w"> </span><span class="p">[</span>
<span class="w">                                  </span><span class="p">{</span>
<span class="w">                                    </span><span class="s2">&quot;$multiply&quot;</span><span class="o">:</span><span class="w"> </span><span class="p">[</span>
<span class="w">                                      </span><span class="p">{</span>
<span class="w">                                        </span><span class="s2">&quot;$cos&quot;</span><span class="o">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">                                          </span><span class="s2">&quot;$arrayElemAt&quot;</span><span class="o">:</span><span class="w"> </span><span class="p">[</span>
<span class="w">                                            </span><span class="s2">&quot;$$s&quot;</span><span class="p">,</span><span class="w"> </span><span class="mf">1</span>
<span class="w">                                          </span><span class="p">]</span>
<span class="w">                                        </span><span class="p">}</span>
<span class="w">                                      </span><span class="p">},</span><span class="w"> </span><span class="p">{</span>
<span class="w">                                        </span><span class="s2">&quot;$sin&quot;</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;$dec&quot;</span>
<span class="w">                                      </span><span class="p">}</span>
<span class="w">                                    </span><span class="p">]</span>
<span class="w">                                  </span><span class="p">},</span><span class="w"> </span><span class="p">{</span>
<span class="w">                                    </span><span class="s2">&quot;$multiply&quot;</span><span class="o">:</span><span class="w"> </span><span class="p">[</span>
<span class="w">                                      </span><span class="p">{</span>
<span class="w">                                        </span><span class="s2">&quot;$sin&quot;</span><span class="o">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">                                          </span><span class="s2">&quot;$arrayElemAt&quot;</span><span class="o">:</span><span class="w"> </span><span class="p">[</span>
<span class="w">                                            </span><span class="s2">&quot;$$s&quot;</span><span class="p">,</span><span class="w"> </span><span class="mf">1</span>
<span class="w">                                          </span><span class="p">]</span>
<span class="w">                                        </span><span class="p">}</span>
<span class="w">                                      </span><span class="p">},</span><span class="w"> </span><span class="p">{</span>
<span class="w">                                        </span><span class="s2">&quot;$cos&quot;</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;$dec&quot;</span>
<span class="w">                                      </span><span class="p">},</span><span class="w"> </span><span class="p">{</span>
<span class="w">                                        </span><span class="s2">&quot;$cos&quot;</span><span class="o">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">                                          </span><span class="s2">&quot;$arrayElemAt&quot;</span><span class="o">:</span><span class="w"> </span><span class="p">[</span>
<span class="w">                                            </span><span class="s2">&quot;$$s&quot;</span><span class="p">,</span><span class="w"> </span><span class="mf">0</span>
<span class="w">                                          </span><span class="p">]</span>
<span class="w">                                        </span><span class="p">}</span>
<span class="w">                                      </span><span class="p">}</span>
<span class="w">                                    </span><span class="p">]</span>
<span class="w">                                  </span><span class="p">}</span>
<span class="w">                                </span><span class="p">]</span>
<span class="w">                              </span><span class="p">},</span><span class="w"> </span><span class="mf">2</span>
<span class="w">                            </span><span class="p">]</span>
<span class="w">                          </span><span class="p">}</span>
<span class="w">                        </span><span class="p">]</span>
<span class="w">                      </span><span class="p">}</span>
<span class="w">                    </span><span class="p">},</span><span class="w"> </span><span class="p">{</span>
<span class="w">                      </span><span class="s2">&quot;$add&quot;</span><span class="o">:</span><span class="w"> </span><span class="p">[</span>
<span class="w">                        </span><span class="p">{</span>
<span class="w">                          </span><span class="s2">&quot;$multiply&quot;</span><span class="o">:</span><span class="w"> </span><span class="p">[</span>
<span class="w">                            </span><span class="p">{</span>
<span class="w">                              </span><span class="s2">&quot;$sin&quot;</span><span class="o">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">                                </span><span class="s2">&quot;$arrayElemAt&quot;</span><span class="o">:</span><span class="w"> </span><span class="p">[</span>
<span class="w">                                  </span><span class="s2">&quot;$$s&quot;</span><span class="p">,</span><span class="w"> </span><span class="mf">1</span>
<span class="w">                                </span><span class="p">]</span>
<span class="w">                              </span><span class="p">}</span>
<span class="w">                            </span><span class="p">},</span><span class="w"> </span><span class="p">{</span>
<span class="w">                              </span><span class="s2">&quot;$sin&quot;</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;$dec&quot;</span>
<span class="w">                            </span><span class="p">}</span>
<span class="w">                          </span><span class="p">]</span>
<span class="w">                        </span><span class="p">},</span><span class="w"> </span><span class="p">{</span>
<span class="w">                          </span><span class="s2">&quot;$multiply&quot;</span><span class="o">:</span><span class="w"> </span><span class="p">[</span>
<span class="w">                            </span><span class="p">{</span>
<span class="w">                              </span><span class="s2">&quot;$cos&quot;</span><span class="o">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">                                </span><span class="s2">&quot;$arrayElemAt&quot;</span><span class="o">:</span><span class="w"> </span><span class="p">[</span>
<span class="w">                                  </span><span class="s2">&quot;$$s&quot;</span><span class="p">,</span><span class="w"> </span><span class="mf">1</span>
<span class="w">                                </span><span class="p">]</span>
<span class="w">                              </span><span class="p">}</span>
<span class="w">                            </span><span class="p">},</span><span class="w"> </span><span class="p">{</span>
<span class="w">                              </span><span class="s2">&quot;$cos&quot;</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;$dec&quot;</span>
<span class="w">                            </span><span class="p">},</span><span class="w"> </span><span class="p">{</span>
<span class="w">                              </span><span class="s2">&quot;$cos&quot;</span><span class="o">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">                                </span><span class="s2">&quot;$arrayElemAt&quot;</span><span class="o">:</span><span class="w"> </span><span class="p">[</span>
<span class="w">                                  </span><span class="s2">&quot;$$s&quot;</span><span class="p">,</span><span class="w"> </span><span class="mf">0</span>
<span class="w">                                </span><span class="p">]</span>
<span class="w">                              </span><span class="p">}</span>
<span class="w">                            </span><span class="p">}</span>
<span class="w">                          </span><span class="p">]</span>
<span class="w">                        </span><span class="p">}</span>
<span class="w">                      </span><span class="p">]</span>
<span class="w">                    </span><span class="p">}</span>
<span class="w">                  </span><span class="p">]</span>
<span class="w">                </span><span class="p">}</span>
<span class="w">              </span><span class="p">}</span>
<span class="w">            </span><span class="p">]</span>
<span class="w">          </span><span class="p">}</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">      </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">  </span><span class="p">},</span>
<span class="w">  </span><span class="c1">// Here, we look for objects that fall within max_distance_arcsec:</span>
<span class="w">  </span><span class="p">{</span>
<span class="w">    </span><span class="s2">&quot;$project&quot;</span><span class="o">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="s2">&quot;watchlist&quot;</span><span class="o">:</span><span class="w"> </span><span class="mf">1</span><span class="p">,</span>
<span class="w">      </span><span class="s2">&quot;distances_arcsec&quot;</span><span class="o">:</span><span class="w"> </span><span class="mf">1</span><span class="p">,</span>
<span class="w">      </span><span class="s2">&quot;nearest_index&quot;</span><span class="o">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="s2">&quot;$indexOfArray&quot;</span><span class="o">:</span><span class="w"> </span><span class="p">[</span>
<span class="w">          </span><span class="s2">&quot;$distances_arcsec&quot;</span><span class="p">,</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="s2">&quot;$min&quot;</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;$distances_arcsec&quot;</span>
<span class="w">          </span><span class="p">}</span>
<span class="w">        </span><span class="p">]</span>
<span class="w">      </span><span class="p">},</span>
<span class="w">      </span><span class="s2">&quot;bingo&quot;</span><span class="o">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="s2">&quot;$filter&quot;</span><span class="o">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">          </span><span class="s2">&quot;input&quot;</span><span class="o">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="s2">&quot;$zip&quot;</span><span class="o">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">              </span><span class="s2">&quot;inputs&quot;</span><span class="o">:</span><span class="w"> </span><span class="p">[</span>
<span class="w">                </span><span class="s2">&quot;$watchlist&quot;</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;$distances_arcsec&quot;</span>
<span class="w">              </span><span class="p">]</span>
<span class="w">            </span><span class="p">}</span>
<span class="w">          </span><span class="p">},</span>
<span class="w">          </span><span class="s2">&quot;as&quot;</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;item&quot;</span><span class="p">,</span>
<span class="w">          </span><span class="s2">&quot;cond&quot;</span><span class="o">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="s2">&quot;$lte&quot;</span><span class="o">:</span><span class="w"> </span><span class="p">[</span>
<span class="w">              </span><span class="p">{</span>
<span class="w">                </span><span class="s2">&quot;$arrayElemAt&quot;</span><span class="o">:</span><span class="w"> </span><span class="p">[</span>
<span class="w">                  </span><span class="s2">&quot;$$item&quot;</span><span class="p">,</span><span class="w"> </span><span class="mf">1</span>
<span class="w">                </span><span class="p">]</span>
<span class="w">              </span><span class="p">},</span><span class="w"> </span><span class="s2">&quot;$max_distance_arcsec&quot;</span>
<span class="w">            </span><span class="p">]</span>
<span class="w">          </span><span class="p">}</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">      </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">  </span><span class="p">},</span>
<span class="w">  </span><span class="c1">// We declare victory if such objects exist:</span>
<span class="w">  </span><span class="p">{</span>
<span class="w">    </span><span class="s2">&quot;$match&quot;</span><span class="o">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="s2">&quot;bingo.0&quot;</span><span class="o">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="s2">&quot;$exists&quot;</span><span class="o">:</span><span class="w"> </span><span class="kc">true</span>
<span class="w">      </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">  </span><span class="p">},</span>
<span class="w">  </span><span class="c1">// Finally, we are adding some useful annotations:</span>
<span class="w">  </span><span class="p">{</span>
<span class="w">    </span><span class="s2">&quot;$project&quot;</span><span class="o">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="s2">&quot;annotations.nearest_name&quot;</span><span class="o">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="s2">&quot;$arrayElemAt&quot;</span><span class="o">:</span><span class="w"> </span><span class="p">[</span>
<span class="w">          </span><span class="s2">&quot;$watchlist.name&quot;</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;$nearest_index&quot;</span>
<span class="w">        </span><span class="p">]</span>
<span class="w">      </span><span class="p">},</span>
<span class="w">      </span><span class="s2">&quot;annotations.nearest_distance_arcsec&quot;</span><span class="o">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="s2">&quot;$round&quot;</span><span class="o">:</span><span class="w"> </span><span class="p">[</span>
<span class="w">          </span><span class="p">{</span>
<span class="w">            </span><span class="s2">&quot;$arrayElemAt&quot;</span><span class="o">:</span><span class="w"> </span><span class="p">[</span>
<span class="w">              </span><span class="s2">&quot;$distances_arcsec&quot;</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;$nearest_index&quot;</span>
<span class="w">            </span><span class="p">]</span>
<span class="w">          </span><span class="p">},</span><span class="w"> </span><span class="mf">3</span>
<span class="w">        </span><span class="p">]</span>
<span class="w">      </span><span class="p">},</span>
<span class="w">      </span><span class="s2">&quot;annotations.matches&quot;</span><span class="o">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="s2">&quot;$map&quot;</span><span class="o">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">          </span><span class="s2">&quot;input&quot;</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;$bingo&quot;</span><span class="p">,</span>
<span class="w">          </span><span class="s2">&quot;as&quot;</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;item&quot;</span><span class="p">,</span>
<span class="w">          </span><span class="s2">&quot;in&quot;</span><span class="o">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="s2">&quot;$arrayElemAt&quot;</span><span class="o">:</span><span class="w"> </span><span class="p">[</span>
<span class="w">              </span><span class="s2">&quot;$$item&quot;</span><span class="p">,</span><span class="w"> </span><span class="mf">0</span>
<span class="w">            </span><span class="p">]</span>
<span class="w">          </span><span class="p">}</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">      </span><span class="p">},</span>
<span class="w">      </span><span class="s2">&quot;annotations.distances_arcsec&quot;</span><span class="o">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="s2">&quot;$map&quot;</span><span class="o">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">          </span><span class="s2">&quot;input&quot;</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;$bingo&quot;</span><span class="p">,</span>
<span class="w">          </span><span class="s2">&quot;as&quot;</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;item&quot;</span><span class="p">,</span>
<span class="w">          </span><span class="s2">&quot;in&quot;</span><span class="o">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="s2">&quot;$round&quot;</span><span class="o">:</span><span class="w"> </span><span class="p">[</span>
<span class="w">              </span><span class="p">{</span>
<span class="w">                </span><span class="s2">&quot;$arrayElemAt&quot;</span><span class="o">:</span><span class="w"> </span><span class="p">[</span>
<span class="w">                  </span><span class="s2">&quot;$$item&quot;</span><span class="p">,</span><span class="w"> </span><span class="mf">1</span>
<span class="w">                </span><span class="p">]</span>
<span class="w">              </span><span class="p">},</span><span class="w"> </span><span class="mf">3</span>
<span class="w">            </span><span class="p">]</span>
<span class="w">          </span><span class="p">}</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">      </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">]</span>
</pre></div>
</div>
</section>
<section id="tips-and-tricks">
<h3>Tips and tricks<a class="headerlink" href="#tips-and-tricks" title="Link to this heading">¶</a></h3>
<section id="prv-candidates-array-sorting">
<h4><code class="docutils literal notranslate"><span class="pre">prv_candidates</span></code> array sorting<a class="headerlink" href="#prv-candidates-array-sorting" title="Link to this heading">¶</a></h4>
<p>The <code class="docutils literal notranslate"><span class="pre">prv_candidates</span></code> are stored as a set and are thus not sorted. To do that, you may use the following stages
immediately after the default <code class="docutils literal notranslate"><span class="pre">Fritz</span></code>’s upstream stages:</p>
<div class="highlight-js notranslate"><div class="highlight"><pre><span></span><span class="p">[</span>
<span class="w">  </span><span class="p">{</span>
<span class="w">    </span><span class="s1">&#39;$project&#39;</span><span class="o">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="s1">&#39;prv_candidates&#39;</span><span class="o">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="s1">&#39;$concatArrays&#39;</span><span class="o">:</span><span class="w"> </span><span class="p">[</span>
<span class="w">          </span><span class="s1">&#39;$prv_candidates&#39;</span><span class="p">,</span><span class="w"> </span><span class="p">[</span>
<span class="w">            </span><span class="p">{</span>
<span class="w">              </span><span class="s1">&#39;fid&#39;</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;$candidate.fid&#39;</span><span class="p">,</span>
<span class="w">              </span><span class="s1">&#39;jd&#39;</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;$candidate.jd&#39;</span><span class="p">,</span>
<span class="w">              </span><span class="s1">&#39;magpsf&#39;</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;$candidate.magpsf&#39;</span>
<span class="w">            </span><span class="p">}</span>
<span class="w">          </span><span class="p">]</span>
<span class="w">        </span><span class="p">]</span>
<span class="w">      </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">  </span><span class="p">},</span>
<span class="w">  </span><span class="p">{</span>
<span class="w">    </span><span class="s1">&#39;$unwind&#39;</span><span class="o">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="s1">&#39;path&#39;</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;$prv_candidates&#39;</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">  </span><span class="p">},</span>
<span class="w">  </span><span class="p">{</span>
<span class="w">    </span><span class="s1">&#39;$sort&#39;</span><span class="o">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="s1">&#39;prv_candidates.jd&#39;</span><span class="o">:</span><span class="w"> </span><span class="mf">1</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">  </span><span class="p">},</span>
<span class="w">  </span><span class="p">{</span>
<span class="w">    </span><span class="s1">&#39;$group&#39;</span><span class="o">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="s1">&#39;_id&#39;</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;$_id&#39;</span><span class="p">,</span>
<span class="w">      </span><span class="s1">&#39;prv_candidates&#39;</span><span class="o">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="s1">&#39;$push&#39;</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;$prv_candidates&#39;</span>
<span class="w">      </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">]</span>
</pre></div>
</div>
<p>These will:</p>
<ul class="simple">
<li><p>Squeeze in the current candidate into <code class="docutils literal notranslate"><span class="pre">prv_candidates</span></code> (as it may or may not be there already)</p></li>
<li><p>Unwind the <code class="docutils literal notranslate"><span class="pre">prv_candidates</span></code> array into a bunch of documents</p></li>
<li><p>Sort them by <code class="docutils literal notranslate"><span class="pre">jd</span></code></p></li>
<li><p>Group back into a single document with the <code class="docutils literal notranslate"><span class="pre">prv_candidates</span></code> in sorted order</p></li>
</ul>
</section>
</section>
</section>
<section id="feedback">
<h2>Feedback<a class="headerlink" href="#feedback" title="Link to this heading">¶</a></h2>
<p>Please start by searching existing issues <a class="reference external" href="https://github.com/fritz-marshal/fritz/issues">here</a>.
If the issue has already been reported, feel free to add to the existing discussion or to propose solutions.</p>
<p>If you found an as-yet-unreported problem, or you have a feature request,
please create a <a class="reference external" href="https://github.com/fritz-marshal/fritz/issues/new/choose">new issue</a>.
The team will triage issues so that, within a few hours, you should see a label appear
that indicates its development priority.</p>
</section>
</section>


          </div>
          <div class="page-nav">
            <div class="inner"><ul class="page-nav">
  <li class="prev">
    <a href="index.html"
       title="previous chapter">← Fritz marshal manual</a>
  </li>
  <li class="next">
    <a href="run_your_own.html"
       title="next chapter">Run your own Fritz →</a>
  </li>
</ul><div class="footer" role="contentinfo">
      &#169; Copyright 2020, The Fritz Marshal authors.
    <br>
    Created using <a href="http://sphinx-doc.org/">Sphinx</a> 7.3.7 with <a href="https://github.com/schettino72/sphinx_press_theme">Press Theme</a> 0.9.1.
</div>
            </div>
          </div>
      </page>
    </div></div>
    
    
  </body>
</html>